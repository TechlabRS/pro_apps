
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job/Application Tracker - Full Upgrade</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .active-btn {
            background-color: #3b82f6;
            color: white;
        }

        button, .btn {
            padding: 0.5rem 1rem;
            margin-right: 0.5rem;
            font-size: 0.875rem;
            border-radius: 0.375rem;
        }
        #status {
            margin-top: 1rem;
            font-weight: bold;
        }

        .progress-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            margin-top: 16px;
        }

        .progress-line {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 4px;
            background-color: #d1d5db;
            transform: translateY(-50%);
            z-index: 0;
        }

        .progress-fill {
            position: absolute;
            top: 50%;
            left: 0;
            height: 4px;
            background-color: #3b82f6;
            transform: translateY(-50%);
            z-index: 1;
            transition: width 0.5s ease-in-out;
        }

        .progress-step {
            position: relative;
            z-index: 2;
            background-color: white;
            border: 2px solid #d1d5db;
            color: #6b7280;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease, transform 0.3s ease;
        }

        .progress-step.active {
            background-color: #3b82f6;
            border-color: #3b82f6;
            color: white;
            transform: scale(1.1);
            box-shadow: 0 0 8px #3b82f6;
        }
        .progress-step.hold {
            background-color: #f59e0b;
            border-color: #f59e0b;
            color: white;
        }
        .progress-step.rejected { 
            background-color: #ef4444;
            border-color: #ef4444;
            color: white;
        }


        .progress-label {
            font-size: 10px;
            text-align: center;
            margin-top: 4px;
            max-width: 60px; 
            overflow-wrap: break-word;
        }

        .add-btn {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background-color: #3b82f6;
            color: white;
            font-size: 32px;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 50;
            transition: background-color 0.3s;
        }

        .add-btn:hover {
            background-color: #2563eb;
        }

        .offered-card {
            border: 4px solid #48bb78;
        }

        .offered-row {
            background-color: #f0fff4;
        }

        .stage-date-tooltip {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            z-index: 10;
            bottom: -28px;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            display: none;
        }

        .progress-step:hover .stage-date-tooltip {
            display: block;
        }

        .copy-btn {
            background-color: #4caf50;
            color: white;
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8em;
            margin-left: 5px;
        }

        .copy-btn:hover {
            background-color: #45a049;
        }

        @media (max-width: 768px) { 
            .progress-step {
                width: 28px;
                height: 28px;
                font-size: 10px;
            }

            .progress-label {
                font-size: 9px;
            }
            .action-buttons-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); 
                gap: 0.5rem;
            }
             .btn-danger.text-xs { 
                padding-left: 0.5rem;
                padding-right: 0.5rem;
             }
        }
        .form-input {
            @apply w-full border p-2 rounded shadow-sm focus:ring-blue-500 focus:border-blue-500;
        }
        .btn { 
            @apply px-4 py-2 rounded font-semibold shadow-md transition-colors duration-150;
        }
        .btn-primary {
            @apply bg-blue-600 text-white hover:bg-blue-700;
        }
        .btn-secondary {
            @apply bg-gray-400 text-white hover:bg-gray-500;
        }
        .btn-danger { 
            @apply bg-red-500 text-white hover:bg-red-600;
        }
        .btn-warning {
            @apply bg-yellow-500 text-white hover:bg-yellow-600;
        }
        .btn-success {
            @apply bg-green-500 text-white hover:bg-green-600;
        }
        .btn-info {
            @apply bg-sky-500 text-white hover:bg-sky-600;
        }

    </style>

</head>

<body class="bg-gray-100 p-4 min-h-screen relative">
    <div class="max-w-5xl mx-auto space-y-4">
        <h1 class="text-3xl font-bold text-center text-gray-700">üìã Job / Application Tracker</h1>

        <div id="summary" class="bg-white p-4 rounded-lg shadow-md text-sm text-gray-600">
        </div>

        <div class="flex flex-col sm:flex-row justify-between items-center mt-6 space-y-2 sm:space-y-0">
            <input type="text" id="search" placeholder="üîç Search company, skill, or HR..." class="form-input w-full sm:w-1/2">
            <div class="flex space-x-2">
                <button id="cardViewBtn" class="btn btn-primary active-btn">Card View</button>
                <button id="tableViewBtn" class="btn btn-primary">Table View</button>
            </div>
        </div>
        <div class="my-4 p-3 bg-white rounded-lg shadow-md">
            <h2 class="text-lg font-semibold text-gray-700 mb-2">üîÅ Firebase Sync for <code>entries</code></h2>
            <div class="flex space-x-2">
                <button onclick="syncToFirebase()" class="btn btn-info">‚òÅÔ∏è Sync to Firebase</button>
                <button onclick="restoreFromFirebase()" class="btn btn-success">‚¨áÔ∏è Restore from Firebase</button>
            </div>
            <div id="status" class="mt-2 text-sm"></div>
        </div>

        <div class="my-4 p-3 bg-white rounded-lg shadow-md">
            <h2 class="text-lg font-semibold text-gray-700 mb-2">üíæ Local Data Management</h2>
            <div class="flex flex-col sm:flex-row gap-2 mt-2">
                <button onclick="exportData()" class="btn btn-info">üì§ Export Data to File</button>
                <div>
                    <label for="importFile" class="btn btn-success cursor-pointer inline-block">üì• Import Data from File</label>
                    <input type="file" id="importFile" accept=".json" class="hidden" onchange="importDataFromFile(event)">
                </div>
            </div>
            <div id="importExportStatus" class="mt-2 text-sm"></div>
        </div>

        <div id="displayArea" class="space-y-4"></div>
    </div>

    <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl p-6 w-full max-w-md space-y-4 shadow-xl">
            <h2 id="modalTitle" class="text-2xl font-bold text-blue-700">‚ûï Add New Application</h2>
            <form id="entryForm" class="space-y-3">
                <input required name="company" placeholder="üè¢ Company Name" class="form-input">
                <input name="hr" placeholder="üë§ HR Name (Optional)" class="form-input">
                <input name="mobile" placeholder="üì± Mobile (Optional)" class="form-input">
                <input name="skill" placeholder="üí° Key Skill/Role" class="form-input">
                <input name="np" placeholder="‚è≥ Notice Period (e.g., 30 days)" class="form-input">
                <textarea name="notes" placeholder="üìù Additional Notes (Optional)" class="form-input h-24"></textarea>
                <div class="flex space-x-2">
                    <button type="submit" class="btn btn-primary w-full">Save</button>
                    <button type="button" onclick="closeModal()" class="btn btn-secondary w-full">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <div id="dateModal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl p-6 w-full max-w-sm space-y-4 shadow-xl">
            <h2 id="dateModalTitle" class="text-xl font-bold text-blue-700">Set Date for Stage</h2>
            <form id="dateForm" class="space-y-3">
                <div>
                    <label for="stageDateInput" class="block text-sm font-medium text-gray-700">Date:</label>
                    <input type="date" required name="stageDate" id="stageDateInput" class="form-input mt-1">
                </div>
                <input type="hidden" id="dateModalOriginalEntryIndex">
                <input type="hidden" id="dateModalStageIndex">
                <div class="flex space-x-2">
                    <button type="submit" class="btn btn-primary w-full">Save Date</button>
                    <button type="button" onclick="closeDateModal()" class="btn btn-secondary w-full">Cancel</button>
                </div>
            </form>
        </div>
    </div>


    <div class="add-btn" onclick="openModal()">+</div>

    <script>
        const entryForm = document.getElementById('entryForm');
        const displayArea = document.getElementById('displayArea');
        const searchInput = document.getElementById('search'); 
        const cardViewBtn = document.getElementById('cardViewBtn');
        const tableViewBtn = document.getElementById('tableViewBtn');
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modalTitle');
        const summaryDiv = document.getElementById('summary');
        
        const dateModal = document.getElementById('dateModal');
        const dateModalTitle = document.getElementById('dateModalTitle');
        const dateForm = document.getElementById('dateForm');
        const stageDateInput = document.getElementById('stageDateInput');
        const dateModalOriginalEntryIndex = document.getElementById('dateModalOriginalEntryIndex');
        const dateModalStageIndex = document.getElementById('dateModalStageIndex');

        const linearStages = ["Call Recvd", "Call Schedule", "L1 Clear", "L2 Clear", "Final Disc(HR)", "Offered"];
        let entries = JSON.parse(localStorage.getItem('entries') || '[]');
        let isCardView = true;
        let currentlyEditingOriginalIndex = null; 

        function saveData() {
            localStorage.setItem('entries', JSON.stringify(entries));
            render();
            updateSummary();
        }

        function initializeNewStage() {
            const now = new Date().toISOString();
            const initialStageDates = new Array(linearStages.length).fill(null);
            initialStageDates[0] = now; 
            return {
                lastLinearStageIndex: 0,
                linearStageDates: initialStageDates,
                currentOverallStatus: "Active", 
                statusReason: "", 
                statusSetDate: null,
                createdAt: now,
                updatedAt: now
            };
        }
        
        function jsEscape(str) {
            if (typeof str !== 'string') return '';
            return str.replace(/'/g, "\\'").replace(/"/g, '\\"');
        }


        function setOverallStatus(originalEntryIndex, newStatus) {
            const entry = entries[originalEntryIndex];
            if (!entry) return;

            let reason = "";
            if (newStatus === "On Hold" || newStatus === "Not Positive") {
                reason = prompt(`Reason for setting status to "${newStatus}" for ${entry.company} (Optional):`);
            }

            // Ensure stage object exists
            if (!entry.stage) {
                 entry.stage = initializeNewStage(); // Should not happen if render patches correctly
            }

            entry.stage.currentOverallStatus = newStatus;
            entry.stage.statusSetDate = new Date().toISOString();
            entry.stage.statusReason = reason || "";
            
            if (newStatus === "Active" && entry.stage.currentOverallStatus === "Active") { // Check if we are setting to Active
                 // If resuming from "On Hold", the old reason/date might be cleared.
                 // This logic is better handled by ensuring statusSetDate is null only if truly active from start or resumed.
                 // For now, let's simplify: if becoming Active, clear previous hold/not positive reason/date.
                 // This might need refinement based on if the previous state was "On Hold".
                 // A dedicated resumeApplication function handles this better by calling setOverallStatus('Active').
                 // If setOverallStatus is called directly with 'Active', assume it's a reset or resume.
                const oldStatus = entries[originalEntryIndex].stage.currentOverallStatus; // Check old status before it's overwritten
                if (oldStatus === "On Hold") { // Only clear if coming from On Hold
                    entry.stage.statusSetDate = null;
                    entry.stage.statusReason = "";
                }
            }
            entry.stage.updatedAt = new Date().toISOString();
            saveData();
        }
        
        function resumeApplication(originalEntryIndex) {
            const entry = entries[originalEntryIndex];
            if (!entry || !entry.stage || entry.stage.currentOverallStatus !== "On Hold") {
                alert("This application is not 'On Hold'.");
                return;
            }
            // Clear specific hold-related info before setting to active
            entry.stage.statusSetDate = null;
            entry.stage.statusReason = "";
            setOverallStatus(originalEntryIndex, "Active");
        }


        function render() {
            let entriesWithOriginalIndex = entries.map((entry, index) => ({ entry, originalIndex: index }));

            entriesWithOriginalIndex.sort((a, b) => {
                const stageA = a.entry.stage || {};
                const stageB = b.entry.stage || {};
                const dateA = new Date(stageA.updatedAt || stageA.createdAt || 0);
                const dateB = new Date(stageB.updatedAt || stageB.createdAt || 0);
                return dateB - dateA;
            });

            const keyword = searchInput.value.toLowerCase();
            const filteredAndSortedEntries = entriesWithOriginalIndex.filter(({ entry }) =>
                entry.company.toLowerCase().includes(keyword) ||
                (entry.hr && entry.hr.toLowerCase().includes(keyword)) ||
                (entry.skill && entry.skill.toLowerCase().includes(keyword))
            );
            displayArea.innerHTML = '';

            if (filteredAndSortedEntries.length === 0) {
                displayArea.innerHTML = `<p class="text-center text-gray-500">No applications found matching your criteria.</p>`;
                return;
            }
            
            filteredAndSortedEntries.forEach(({ entry: e, originalIndex }) => {
                // Robust stage object initialization/patching
                if (!e.stage) {
                    e.stage = initializeNewStage();
                } else {
                    const defaultS = initializeNewStage(); // For default structures/values
                    if (typeof e.stage.createdAt === 'undefined') {
                        e.stage.createdAt = (Array.isArray(e.stage.linearStageDates) && e.stage.linearStageDates.find(d => d)) || defaultS.createdAt;
                    }
                    if (typeof e.stage.updatedAt === 'undefined') {
                        e.stage.updatedAt = e.stage.createdAt;
                    }
                    if (!Array.isArray(e.stage.linearStageDates) || e.stage.linearStageDates.length !== linearStages.length) {
                        const currentDates = Array.isArray(e.stage.linearStageDates) ? e.stage.linearStageDates : [];
                        const newDates = new Array(linearStages.length).fill(null);
                        for (let i = 0; i < Math.min(newDates.length, currentDates.length); i++) {
                            newDates[i] = currentDates[i]; // Preserve what we can
                        }
                        e.stage.linearStageDates = newDates;
                        if (e.stage.linearStageDates[0] === null && typeof e.stage.lastLinearStageIndex === 'number' && e.stage.lastLinearStageIndex === 0){
                             e.stage.linearStageDates[0] = e.stage.createdAt;
                        }
                    }
                    if (typeof e.stage.lastLinearStageIndex !== 'number' || e.stage.lastLinearStageIndex < -1 || e.stage.lastLinearStageIndex >= linearStages.length) {
                        let newLLS = -1;
                        for (let i = 0; i < e.stage.linearStageDates.length; i++) {
                            if (e.stage.linearStageDates[i]) newLLS = i; 
                            // Find the highest index with a date, not necessarily consecutive for LLS visual
                        }
                        e.stage.lastLinearStageIndex = newLLS;
                         if (newLLS === -1 && e.stage.linearStageDates[0] === null && initializeNewStage().lastLinearStageIndex === 0 && initializeNewStage().linearStageDates[0] !== null) {
                            // This condition is for very old entries that might default to first stage if it's auto-dated by initializeNewStage
                            // However, initializeNewStage() itself sets date[0] for LLS=0.
                            // If LLS is truly undefined, and no dates, it should be -1. If dates[0] exists, it's 0.
                             e.stage.lastLinearStageIndex = e.stage.linearStageDates[0] ? 0 : -1;
                        }
                    }
                    if (typeof e.stage.currentOverallStatus !== 'string' || !["Active", "On Hold", "Not Positive"].includes(e.stage.currentOverallStatus)) {
                        e.stage.currentOverallStatus = defaultS.currentOverallStatus; 
                    }
                    if (typeof e.stage.statusReason === 'undefined') e.stage.statusReason = defaultS.statusReason;
                    if (typeof e.stage.statusSetDate === 'undefined') e.stage.statusSetDate = defaultS.statusSetDate;
                }

                if (isCardView) {
                    let progressPercent = 0;
                    if (e.stage.currentOverallStatus !== "Not Positive" && e.stage.lastLinearStageIndex >= 0) {
                         progressPercent = (e.stage.lastLinearStageIndex + 1) / linearStages.length * 100;
                         if (linearStages[e.stage.lastLinearStageIndex] === "Offered") progressPercent = 100;
                    }

                    let cardClass = "bg-white p-4 rounded-lg shadow-md space-y-2";
                    if (linearStages[e.stage.lastLinearStageIndex] === "Offered" && e.stage.currentOverallStatus !== "Not Positive") {
                        cardClass += " offered-card";
                    }

                    let stageDotsHTML = linearStages.map((stageName, idx) => {
                        let tooltipHTML = '';
                        if (e.stage.linearStageDates[idx]) {
                            const formattedDate = new Date(e.stage.linearStageDates[idx]).toLocaleDateString();
                            tooltipHTML = `<div class="stage-date-tooltip">${formattedDate}</div>`;
                        }
                        
                        let stepDotClass = 'progress-step';
                        // Simplified active logic: if a date exists for the step, it's active (unless "Not Positive" and beyond LLS)
                        // And all steps up to lastLinearStageIndex are active if status is not "Not Positive"
                        if (e.stage.linearStageDates[idx]) {
                            if (!(e.stage.currentOverallStatus === "Not Positive" && idx > e.stage.lastLinearStageIndex)) {
                                stepDotClass += ' active';
                            }
                        } else if (idx <= e.stage.lastLinearStageIndex && e.stage.currentOverallStatus !== "Not Positive") {
                            stepDotClass += ' active';
                        }

                        if (e.stage.currentOverallStatus === "On Hold" && idx === e.stage.lastLinearStageIndex && e.stage.linearStageDates[idx]) {
                            stepDotClass += ' hold'; // Keep hold style if it's the last active step with date
                        } else if (e.stage.currentOverallStatus === "On Hold" && e.stage.linearStageDates[idx]) {
                             stepDotClass = 'progress-step active'; // If on hold but a past step has a date, it's just active.
                        }


                        return `
                            <div class="flex flex-col items-center">
                                <div class="${stepDotClass}" onclick="openDateModal(${originalIndex}, ${idx}, '${jsEscape(linearStages[idx])}')">
                                    ${idx + 1}
                                    ${tooltipHTML}
                                </div>
                                <div class="progress-label">${stageName}</div>
                            </div>`;
                    }).join('');
                    
                    const overallStatusColor = e.stage.currentOverallStatus === 'Not Positive' ? 'text-red-600' :
                                           e.stage.currentOverallStatus === 'On Hold' ? 'text-yellow-600' :
                                           (linearStages[e.stage.lastLinearStageIndex] === "Offered" && e.stage.currentOverallStatus !== "Not Positive" ? 'text-green-600' : 'text-blue-600');
                    
                    let stageDatesListHTML = linearStages.map((stageName, idx) => {
                        const stageDate = e.stage.linearStageDates[idx];
                        if (stageDate) {
                            return `<div class="text-xs py-0.5"><strong>${stageName}:</strong> ${new Date(stageDate).toLocaleDateString()}</div>`;
                        }
                        return '';
                    }).filter(Boolean).join('');
                    if (!stageDatesListHTML) {
                        stageDatesListHTML = '<div class="text-xs text-gray-400 py-0.5">No specific stage dates recorded.</div>';
                    }

                    displayArea.innerHTML += `
                      <div class="${cardClass}">
                        <h2 class="font-bold ${overallStatusColor} text-xl">${e.company}</h2>
                        <div><strong>Status:</strong> <span class="font-semibold ${overallStatusColor}">${e.stage.currentOverallStatus}</span>
                            ${e.stage.statusReason ? ` <span class="text-sm text-gray-500">(${e.stage.statusReason})</span>` : ''}
                            ${e.stage.statusSetDate && e.stage.currentOverallStatus !== 'Active' ?
                              ` <span class="text-xs text-gray-400">- ${new Date(e.stage.statusSetDate).toLocaleDateString()}</span>` : ''}
                        </div>

                        <div class="flex flex-col md:flex-row gap-x-4 gap-y-2 mt-2 text-sm">
                            <div class="md:w-3/5 space-y-1"> 
                                ${e.hr ? `<div>üë§ <strong>HR:</strong> ${e.hr}</div>` : ''}
                                ${e.skill ? `<div>üí° <strong>Skill/Role:</strong> ${e.skill}</div>` : ''}
                                ${e.np ? `<div>‚è≥ <strong>NP:</strong> ${e.np}</div>` : ''}
                                ${e.mobile ? `<div>üì± <strong>Mobile:</strong> ${e.mobile} <button class="copy-btn" onclick="copyToClipboard('${e.mobile}')">Copy</button></div>` : ''}
                                ${e.notes ? `<div class="text-xs text-gray-600 mt-1">üìù <strong>Notes:</strong><br>${e.notes.replace(/\n/g, '<br>')}</div>` : ''}
                            </div>
                            <div class="md:w-2/5 space-y-1 md:border-l md:pl-3"> 
                                <div> 
                                    <strong class="text-xs text-gray-500 block mb-1">STAGE DATES:</strong>
                                    ${stageDatesListHTML}
                                </div>
                            </div>
                        </div>

                        <div class="progress-container mt-3 mb-3">
                          <div class="progress-line"></div>
                          <div class="progress-fill" style="width:${progressPercent}%"></div>
                           ${stageDotsHTML}
                        </div>

                        <div class="action-buttons-grid mt-3 border-t pt-3">
                          <button onclick="setOverallStatus(${originalIndex}, 'On Hold')" class="btn btn-warning text-xs">Hold</button>
                          <button onclick="setOverallStatus(${originalIndex}, 'Not Positive')" class="btn btn-danger text-xs whitespace-nowrap">Not Positive</button>
                          ${e.stage.currentOverallStatus === 'On Hold' ?
                            `<button onclick="resumeApplication(${originalIndex})" class="btn btn-success text-xs">Resume</button>` : ''}
                          <button onclick="editEntry(${originalIndex})" class="btn btn-info text-xs">Edit Details</button>
                          <button onclick="deleteEntry(${originalIndex})" class="btn btn-secondary text-xs">Delete Entry</button>
                        </div>
                      </div>`;
                } else { // Table View
                    let table = `<div class="overflow-x-auto bg-white rounded-lg shadow-md"><table class="w-full text-sm">
                        <thead class="bg-gray-200 text-gray-600 uppercase"><tr>
                          <th class="p-3 text-left">Company</th><th class="p-3 text-left">Overall Status</th><th class="p-3 text-left">Current Linear Stage</th><th class="p-3 text-left">HR</th><th class="p-3 text-left">Skill/Role</th><th class="p-3 text-left">Actions</th>
                        </tr></thead><tbody class="text-gray-700">`;
                    filteredAndSortedEntries.forEach(({ entry: e, originalIndex }) => {
                        // Stage patching logic is already done above for 'e'
                        let rowClass = "border-t border-gray-200 hover:bg-gray-50";
                        if (e.stage && linearStages[e.stage.lastLinearStageIndex] === "Offered" && e.stage.currentOverallStatus !== "Not Positive") {
                            rowClass += " offered-row";
                        }
                         const overallStatusColor = e.stage.currentOverallStatus === 'Not Positive' ? 'text-red-600' :
                                               e.stage.currentOverallStatus === 'On Hold' ? 'text-yellow-600' :
                                               (e.stage && linearStages[e.stage.lastLinearStageIndex] === "Offered" ? 'text-green-600' : 'text-blue-600');

                        const currentLinearStageName = (e.stage && typeof e.stage.lastLinearStageIndex === 'number' && e.stage.lastLinearStageIndex >=0) ? linearStages[e.stage.lastLinearStageIndex] : 'N/A';
                        const linearStageDate = (e.stage && e.stage.linearStageDates && e.stage.lastLinearStageIndex >=0 && e.stage.linearStageDates[e.stage.lastLinearStageIndex]) ? new Date(e.stage.linearStageDates[e.stage.lastLinearStageIndex]).toLocaleDateString() : 'N/A';

                        table += `<tr class="${rowClass}">
                          <td class="p-3 font-semibold">${e.company}</td>
                          <td class="p-3"><span class="font-semibold ${overallStatusColor}">${e.stage.currentOverallStatus}</span> ${e.stage.statusReason ?
                            `<span class="text-xs text-gray-500">(${e.stage.statusReason})</span>`:""}</td>
                          <td class="p-3">${currentLinearStageName} <span class="text-xs text-gray-400">(${linearStageDate})</span></td>
                          <td class="p-3">${e.hr || '-'}</td>
                          <td class="p-3">${e.skill || '-'}</td>
                          <td class="p-3 whitespace-nowrap action-buttons-grid">
                            <button onclick="setOverallStatus(${originalIndex}, 'On Hold')" class="btn btn-warning btn-xs">Hold</button>
                            <button onclick="setOverallStatus(${originalIndex}, 'Not Positive')" class="btn btn-danger btn-xs whitespace-nowrap">Not Positive</button>
                            ${e.stage.currentOverallStatus === 'On Hold' ?
                              `<button onclick="resumeApplication(${originalIndex})" class="btn btn-success btn-xs">Resume</button>` : ''}
                            <button onclick="editEntry(${originalIndex})" class="btn btn-info btn-xs">Edit</button>
                            <button onclick="deleteEntry(${originalIndex})" class="btn btn-secondary btn-xs">Del</button>
                          </td></tr>`;
                    });
                    table += '</tbody></table></div>';
                    displayArea.innerHTML = table;
                }
            }); // End of forEach loop for filteredAndSortedEntries
        } // End of render function


        function editEntry(originalIndex) {
            const entryToEdit = entries[originalIndex];
            if (!entryToEdit) return;

            currentlyEditingOriginalIndex = originalIndex;
            modalTitle.textContent = `‚úèÔ∏è Edit Application: ${entryToEdit.company}`;
            openModal();
            entryForm.company.value = entryToEdit.company;
            entryForm.hr.value = entryToEdit.hr || '';
            entryForm.mobile.value = entryToEdit.mobile || '';
            entryForm.skill.value = entryToEdit.skill || '';
            entryForm.np.value = entryToEdit.np || '';
            entryForm.notes.value = entryToEdit.notes || '';
        }

        function deleteEntry(originalIndex) {
            const entryToDelete = entries[originalIndex];
            if (confirm(`Are you sure you want to delete the application for ${entryToDelete.company}?`)) {
                entries.splice(originalIndex, 1);
                saveData();
            }
        }

        function openModal() {
            if(currentlyEditingOriginalIndex === null) { 
                 modalTitle.textContent = '‚ûï Add New Application';
            }
            modal.classList.remove('hidden');
        }

        function closeModal() {
            modal.classList.add('hidden');
            entryForm.reset();
            currentlyEditingOriginalIndex = null; 
            modalTitle.textContent = '‚ûï Add New Application';
        }

        function openDateModal(entryIndex, stageIdx, stageName) {
            dateModalOriginalEntryIndex.value = entryIndex;
            dateModalStageIndex.value = stageIdx;
            dateModalTitle.textContent = `Set Date for: ${stageName}`;
            
            const existingDate = entries[entryIndex].stage.linearStageDates[stageIdx];
            if (existingDate) {
                stageDateInput.value = new Date(existingDate).toISOString().split('T')[0];
            } else {
                stageDateInput.value = ''; 
            }
            dateModal.classList.remove('hidden');
        }

        function closeDateModal() {
            dateModal.classList.add('hidden');
            dateForm.reset(); 
            dateModalOriginalEntryIndex.value = '';
            dateModalStageIndex.value = '';
            stageDateInput.value = '';
        }
        
        dateForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const originalEntryIdx = parseInt(dateModalOriginalEntryIndex.value);
            const stageIdx = parseInt(dateModalStageIndex.value);
            const newDateValue = stageDateInput.value;

            if (isNaN(originalEntryIdx) || isNaN(stageIdx) || !newDateValue) {
                alert("Error: Could not save date. Please ensure a valid date is selected.");
                return;
            }

            const entry = entries[originalEntryIdx];
            if (!entry || !entry.stage) return;

            entry.stage.linearStageDates[stageIdx] = new Date(newDateValue + "T12:00:00Z").toISOString();
            entry.stage.updatedAt = new Date().toISOString();

            // --- MODIFIED LOGIC for lastLinearStageIndex ---
            if (entry.stage.currentOverallStatus === "Active") {
                if (stageIdx >= entry.stage.lastLinearStageIndex) { 
                    // Only advance lastLinearStageIndex if the current stage is a forward step
                    // or the same as the current furthest point.
                    entry.stage.lastLinearStageIndex = stageIdx;
                }
                // If an earlier stage's date is set/updated, lastLinearStageIndex does not go backward.
                // The visual progress bar will still show the furthest point reached.
                // The individual dot for the updated earlier stage will become active if it wasn't.
            }
            // --- END OF MODIFIED LOGIC ---

            if (linearStages[stageIdx] === "Offered" && entry.stage.currentOverallStatus !== "Not Positive") {
                 alert(`üéâ Congratulations! You received an offer from ${entry.company}! üéâ`);
            }

            saveData();
            closeDateModal();
        });


        entryForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const formData = {
                company: entryForm.company.value.trim(),
                hr: entryForm.hr.value.trim(),
                mobile: entryForm.mobile.value.trim(),
                skill: entryForm.skill.value.trim(),
                np: entryForm.np.value.trim(),
                notes: entryForm.notes.value.trim()
            };

            if (!formData.company) {
                alert("Company name is required.");
                return;
            }

            if (currentlyEditingOriginalIndex !== null) {
                const entryToUpdate = entries[currentlyEditingOriginalIndex];
                Object.assign(entryToUpdate, formData); 
                if (!entryToUpdate.stage) entryToUpdate.stage = initializeNewStage(); // Should exist due to render patching
                entryToUpdate.stage.updatedAt = new Date().toISOString();
            } else {
                const newEntry = {
                    ...formData,
                    stage: initializeNewStage()
                };
                entries.push(newEntry);
            }
            saveData();
            closeModal();
        });

        searchInput.addEventListener('input', render);
        cardViewBtn.addEventListener('click', () => {
            isCardView = true;
            render();
            cardViewBtn.classList.add('active-btn');
            tableViewBtn.classList.remove('active-btn');
            cardViewBtn.classList.add('btn-primary'); 
            tableViewBtn.classList.remove('btn-primary'); 
            tableViewBtn.classList.add('btn-secondary');
        });
        tableViewBtn.addEventListener('click', () => {
            isCardView = false;
            render();
            tableViewBtn.classList.add('active-btn');
            cardViewBtn.classList.remove('active-btn');
            tableViewBtn.classList.add('btn-primary');
            cardViewBtn.classList.remove('btn-primary');
            cardViewBtn.classList.add('btn-secondary');
        });
        function updateSummary() {
            const totalApplications = entries.length;
            const offeredCount = entries.filter(e => e.stage && linearStages[e.stage.lastLinearStageIndex] === "Offered" && e.stage.currentOverallStatus !== "Not Positive").length;
            const onHoldCount = entries.filter(e => e.stage && e.stage.currentOverallStatus === "On Hold").length;
            const notPositiveCount = entries.filter(e => e.stage && e.stage.currentOverallStatus === "Not Positive").length;
            const activeCount = entries.filter(e => e.stage && e.stage.currentOverallStatus === "Active" && !(linearStages[e.stage.lastLinearStageIndex] === "Offered")).length;
            summaryDiv.innerHTML = `
              <span class="mr-3"><strong>Total:</strong> ${totalApplications}</span>
              <span class="mr-3 text-blue-600"><strong>Active:</strong> ${activeCount}</span>
              <span class="mr-3 text-green-600"><strong>Offered:</strong> ${offeredCount}</span>
              <span class="mr-3 text-yellow-600"><strong>On Hold:</strong> ${onHoldCount}</span>
              <span class="text-red-600"><strong>Not Positive:</strong> ${notPositiveCount}</span>
            `;
        }
        
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text)
                .then(() => alert(`Copied "${text}" to clipboard.`))
                .catch(err => console.error('Could not copy text: ', err));
        }

        function exportData() {
            const dataStr = JSON.stringify(entries, null, 2);
            const dataBlob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement("a");
            link.href = url;
            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-').replace('T', '_');
            link.download = `job_tracker_backup_${timestamp}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            const statusEl = document.getElementById("importExportStatus");
            statusEl.textContent = "‚úÖ Data exported successfully.";
            statusEl.className = "mt-2 text-sm text-green-600";
            setTimeout(() => { statusEl.textContent = ""; }, 3000);
        }

        function importDataFromFile(event) {
            const file = event.target.files[0];
            const statusEl = document.getElementById("importExportStatus");

            if (!file) {
                statusEl.textContent = "‚ö†Ô∏è No file selected.";
                statusEl.className = "mt-2 text-sm text-yellow-600";
                return;
            }

            if (file.type !== "application/json") {
                statusEl.textContent = "‚ö†Ô∏è Invalid file type. Please select a .json file.";
                statusEl.className = "mt-2 text-sm text-red-600";
                event.target.value = null; 
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedEntries = JSON.parse(e.target.result);
                    if (!Array.isArray(importedEntries)) {
                        throw new Error("Imported data is not a valid array.");
                    }

                    if (confirm(`Are you sure you want to import ${importedEntries.length} entries? This will overwrite your current local data.`)) {
                        entries = importedEntries.map(entry => {
                            const defaultStageFull = initializeNewStage(); 
                            const existingStage = entry.stage || {};
                            
                            const createdAt = existingStage.createdAt || defaultStageFull.createdAt;
                            const updatedAt = existingStage.updatedAt || createdAt; 

                            const newStage = {
                                ...defaultStageFull, 
                                ...existingStage, 
                                createdAt: createdAt,
                                updatedAt: updatedAt,
                                linearStageDates: Array.isArray(existingStage.linearStageDates) && existingStage.linearStageDates.length === linearStages.length ? existingStage.linearStageDates : [...defaultStageFull.linearStageDates],
                                lastLinearStageIndex: typeof existingStage.lastLinearStageIndex === 'number' && existingStage.lastLinearStageIndex >= -1 && existingStage.lastLinearStageIndex < linearStages.length ? existingStage.lastLinearStageIndex : defaultStageFull.lastLinearStageIndex,
                                currentOverallStatus: ["Active", "On Hold", "Not Positive"].includes(existingStage.currentOverallStatus) ? existingStage.currentOverallStatus : defaultStageFull.currentOverallStatus,
                                statusReason: typeof existingStage.statusReason === 'string' ? existingStage.statusReason : defaultStageFull.statusReason,
                                statusSetDate: existingStage.statusSetDate || defaultStageFull.statusSetDate // Keep null if it was null
                            };
                            if(newStage.currentOverallStatus !== "Active" && newStage.currentOverallStatus !== "On Hold" && newStage.statusSetDate === defaultStageFull.statusSetDate && defaultStageFull.statusSetDate === null){
                                // If status is Not Positive and statusSetDate was never set (or from a fresh defaultStage), set it.
                                newStage.statusSetDate = newStage.updatedAt;
                            }
                            if(newStage.currentOverallStatus === "Active"){ // Ensure reason and date are null for active.
                                newStage.statusReason = "";
                                newStage.statusSetDate = null;
                            }


                            entry.stage = newStage;
                            return entry;
                        });
                        saveData(); 
                        statusEl.textContent = `‚úÖ Successfully imported ${entries.length} entries.`;
                        statusEl.className = "mt-2 text-sm text-green-600";
                    } else {
                        statusEl.textContent = "‚ÑπÔ∏è Import cancelled by user.";
                        statusEl.className = "mt-2 text-sm text-blue-600";
                    }
                } catch (error) {
                    console.error("Error importing data:", error);
                    statusEl.textContent = "‚ùå Error importing data: " + error.message;
                    statusEl.className = "mt-2 text-sm text-red-600";
                } finally {
                    event.target.value = null; 
                    setTimeout(() => { statusEl.textContent = ""; }, 5000);
                }
            };
            reader.onerror = function() {
                statusEl.textContent = "‚ùå Error reading file.";
                statusEl.className = "mt-2 text-sm text-red-600";
                event.target.value = null;
                setTimeout(() => { statusEl.textContent = ""; }, 3000);
            };
            reader.readAsText(file);
        }


        // Initial setup
        if (isCardView) {
             cardViewBtn.classList.add('btn-primary');
             tableViewBtn.classList.add('btn-secondary');
        } else {
            tableViewBtn.classList.add('btn-primary');
             cardViewBtn.classList.add('btn-secondary');
        }
        render(); 
        updateSummary(); 
    </script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
    <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDGTNO6ygnAE8QG5Hs-rcPRX3TzqrKQa5w", // Replace with your actual API key
      authDomain: "rprofbdb.firebaseapp.com", // Replace with your actual auth domain
      databaseURL: "https://rprofbdb-default-rtdb.asia-southeast1.firebasedatabase.app", // Replace with your actual database URL
      projectId: "rprofbdb", // Replace with your actual project ID
      storageBucket: "rprofbdb.appspot.com", // Corrected: usually ends with .appspot.com
      messagingSenderId: "452736310737", // Replace with your actual sender ID
      appId: "1:452736310737:web:79c2ec79fda09bde7f14f0", // Replace with your actual App ID
      measurementId: "G-HKEZZQZDW2" // Optional: Replace with your actual Measurement ID
    };
    let db;
    try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.database();
        console.log("Firebase initialized successfully.");
    } catch (e) {
        console.error("Firebase initialization failed:", e);
        document.getElementById("status").textContent = "‚ö†Ô∏è Firebase initialization failed. Sync disabled.";
    }


    function syncToFirebase() {
        if (!db) {
            document.getElementById("status").textContent = "‚ö†Ô∏è Firebase not initialized. Cannot sync.";
            return;
        }
        const localEntries = JSON.parse(localStorage.getItem("entries") || "[]");
        if (!Array.isArray(localEntries) || localEntries.length === 0) {
            if (confirm("Local data is empty. Do you want to proceed and potentially clear Firebase data?")) {
            } else {
                document.getElementById("status").textContent = "‚ö†Ô∏è Sync cancelled by user due to empty local data.";
                return;
            }
        }

        db.ref("entries").set(localEntries)
            .then(() => {
            document.getElementById("status").textContent = "‚úÖ Entries synced to Firebase.";
            })
            .catch(error => {
            document.getElementById("status").textContent = "‚ùå Sync failed: " + error.message;
            console.error("Firebase sync error:", error);
            });
    }

    function restoreFromFirebase() {
         if (!db) {
            document.getElementById("status").textContent = "‚ö†Ô∏è Firebase not initialized. Cannot restore.";
            return;
        }
        if (confirm("This will overwrite your local data with data from Firebase. Are you sure?")) {
            db.ref("entries").once("value")
            .then(snapshot => {
                const data = snapshot.val() || [];
                 entries = data.map(entry => { 
                    const defaultStageFull = initializeNewStage();
                    const existingStage = entry.stage || {};
                    const createdAt = existingStage.createdAt || defaultStageFull.createdAt;
                    const updatedAt = existingStage.updatedAt || createdAt;

                    const newStage = {
                        ...defaultStageFull,
                        ...existingStage,
                        createdAt: createdAt,
                        updatedAt: updatedAt,
                        linearStageDates: Array.isArray(existingStage.linearStageDates) && existingStage.linearStageDates.length === linearStages.length ? existingStage.linearStageDates : [...defaultStageFull.linearStageDates],
                        lastLinearStageIndex: typeof existingStage.lastLinearStageIndex === 'number' && existingStage.lastLinearStageIndex >= -1 && existingStage.lastLinearStageIndex < linearStages.length ? existingStage.lastLinearStageIndex : defaultStageFull.lastLinearStageIndex,
                        currentOverallStatus: ["Active", "On Hold", "Not Positive"].includes(existingStage.currentOverallStatus) ? existingStage.currentOverallStatus : defaultStageFull.currentOverallStatus,
                        statusReason: typeof existingStage.statusReason === 'string' ? existingStage.statusReason : defaultStageFull.statusReason,
                        statusSetDate: existingStage.statusSetDate || defaultStageFull.statusSetDate
                    };
                     if(newStage.currentOverallStatus !== "Active" && newStage.currentOverallStatus !== "On Hold" && newStage.statusSetDate === defaultStageFull.statusSetDate && defaultStageFull.statusSetDate === null){
                        newStage.statusSetDate = newStage.updatedAt;
                    }
                    if(newStage.currentOverallStatus === "Active"){ 
                        newStage.statusReason = "";
                        newStage.statusSetDate = null;
                    }

                    entry.stage = newStage;
                    return entry;
                });
                saveData(); 
                document.getElementById("status").textContent = "‚úÖ Entries restored from Firebase.";
            })
            .catch(error => {
                document.getElementById("status").textContent = "‚ùå Restore failed: " + error.message;
                console.error("Firebase restore error:", error);
            });
        } else {
             document.getElementById("status").textContent = "‚ö†Ô∏è Restore cancelled by user.";
        }
    }
    </script>
</body>
</html>
