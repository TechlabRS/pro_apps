
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RaGhaS Money Tracker - Advanced Exprense Tracker v3.10</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>

    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f0f2f5;
            color: #333;
            padding-top: 1rem;
            padding-bottom: 70px; 
            overscroll-behavior-y: contain;
        }
        .app-header {
            background-color: #1acfcf;
            color: white; padding: 1rem 0;
            text-align: center; margin-bottom: 1rem; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0; z-index: 1030;
        }
        .rtitle {
            background: linear-gradient(135deg, #bbff00 0%, #007ab3 100%);
            color: white; text-align: center;
        }
        .app-header h1 { margin-bottom: 0; font-weight: 500;
            font-size: 1.5rem; }
        
        #loginScreen { display: flex;
            flex-direction: column; align-items: center; justify-content: center; min-height: 80vh; padding: 20px;
        }
        #appContainer { display: none;
        }

        .view-container { padding: 0 15px;
        }
        .view { display: none;
        }
        .view.active { display: block; animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1;
        } }
        .card { border: none; border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); margin-bottom: 1.5rem;
        }
        .card-header { background-color: #ffffff; border-bottom: 1px solid #e9ecef; font-weight: 500; border-top-left-radius: 0.75rem;
            border-top-right-radius: 0.75rem; padding: 0.75rem 1.25rem; }
        .card-body { padding: 1rem;
        }
        .total-balance-card { background: linear-gradient(135deg, #0fb7d4 0%, #bbff00  100%); color: white;
            text-align: center; }
        .total-balance-card h2 { font-size: 1.1rem; margin-bottom: 0.3rem; opacity: 0.9;
        }
        .total-balance-card .balance-amount { font-size: 2rem; font-weight: 700;
        }
        .account-balance-item { display: flex; justify-content: space-between; align-items: center; padding: 0.6rem 0.5rem;
            border-bottom: 1px solid #f0f2f5; font-size: 0.85rem; }
        .account-balance-item:last-child { border-bottom: none;
        }
        .account-balance-item .account-name { font-weight: 500; color: #495057;
        }
        .account-balance-item .account-value { font-weight: 700; color: #007bff;
        }
        .account-balance-item .account-value.hidden-balance .fas { font-size: 1em;
        }

        .balance-visibility-toggle { margin-bottom: 1rem; display: flex; justify-content: flex-end;
        }
        .balance-visibility-toggle .btn { font-size: 0.8rem; padding: 0.3rem 0.6rem;
        }
        .btn-primary {background-color: #79AEF2;}

        .form-control, .custom-select { border-radius: 0.5rem;
            border: 1px solid #ced4da; font-size:0.9rem; }
        .form-control:focus, .custom-select:focus { border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25); }
        .btn { border-radius: 0.5rem;
            font-weight:500; }

        .transaction-list .list-group-item { display: flex; justify-content: space-between; align-items: center; border-radius: 0.5rem;
            margin-bottom: 0.75rem; padding: 0.85rem 1.25rem; border: 1px solid #e0e0e0; background-color: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: relative;
        }
        .transaction-list .list-item-icon { font-size: 1.5rem; margin-right: 1rem; width: 40px; text-align: center;
        }
        .transaction-income .list-item-icon { color: #28a745;
        }
        .transaction-spend .list-item-icon { color: #dc3545;
        }
        .transaction-transfer .list-item-icon { color: #17a2b8;
        }
        .transaction-loan .list-item-icon { color: #ffc107;
        } 
        .transaction-list .list-item-details { flex-grow: 1; display: flex; flex-direction: column;
        }
        .transaction-list .main-info { font-weight: 500; font-size: 0.9rem;
        }
        .transaction-list .category-info { font-size: 0.8rem; color: #555; font-weight: 500;
        } 
        .transaction-list .description-info { font-size: 0.75rem; color: #777; font-style: italic;
            margin-left: 5px;}
        .transaction-list .sub-info, .transaction-list .loan-details-info { font-size: 0.75rem; color: #6c757d; margin-top: 2px;
        }
        .transaction-list .account-info { font-size: 0.7rem; color: #6c757d; font-style: italic;
        }
        .transaction-list .list-item-amount-actions { display: flex; flex-direction: column; align-items: flex-end;
        }
        .transaction-list .amount { font-weight: 700; font-size: 0.95rem; margin-bottom: 5px;
        }
        .transaction-income .amount { color: #28a745;
        }
        .transaction-spend .amount { color: #dc3545;
        }
        .transaction-transfer .amount { color: #17a2b8;
        }
        .transaction-loan .amount.lent { color: #dc3545;
        } 
        .transaction-loan .amount.returned { color: #28a745;
        } 
        .transaction-list .item-actions { display: flex; gap: 8px; margin-top: 5px;
        }
        .transaction-list .action-btn { font-size: 0.75rem; padding: 0.2rem 0.4rem; border-radius: 0.25rem; cursor: pointer;
        }
        .transaction-list .edit-btn { background-color: #ffc107; color: #333; border: none;
        }
        .transaction-list .edit-btn:hover { background-color: #e0a800;
        }
        .transaction-list .delete-btn { background-color: #dc3545; color: white; border: none;
        }
        .transaction-list .delete-btn:hover { background-color: #c82333;
        }
        .transaction-list .record-return-btn { background-color: #17a2b8; color: white; border: none; font-size: 0.7rem;
            padding: 0.2rem 0.4rem;}
        .transaction-list .record-return-btn:hover { background-color: #138496;
        }

        .investment-list .list-group-item { display: flex; justify-content: space-between; align-items: flex-start; border-radius: 0.5rem;
            margin-bottom: 0.5rem; padding: 0.75rem 1.25rem; border: 1px solid #e9ecef; position: relative;
        }
        .investment-list .list-group-item.redeemed-investment { background-color: #f8f9fa; opacity: 0.7;
        }
        .investment-item-actions { position: absolute; top: 5px; right: 5px; display: flex; gap: 5px;
        }
        .investment-item-actions .btn-sm { padding: 0.15rem 0.3rem;
            font-size: 0.7rem;}
        .list-item-content .main-info { font-weight: 500;
        }
        .list-item-content .sub-info { font-size: 0.8rem; color: #6c757d;
        }
        .list-item-content .account-info, .list-item-content .investment-details { font-size: 0.75rem; color: #6c757d; font-style: italic;
        }
        .list-item-amount .amount { font-weight: 700;
        }
        .list-item-amount .current-value-label { font-size: 0.7rem; color: #6c757d; display:block;
        }
        .investment-item .amount { color: #20c997;
        }
        .investment-item .profit { color: #28a745;
        }
        .investment-item .loss { color: #dc3545;
        }
        .status-badge { font-size: 0.7rem; font-weight: bold; padding: 0.2rem 0.4rem; border-radius: 0.25rem;
            color: white; }
        .status-active { background-color: #28a745;
        }
        .status-redeemed { background-color: #6c757d;
        }
        .status-loan-outstanding { background-color: #ffc107;
            color: #333;}
        .status-loan-returned { background-color: #28a745;}

        #transactionModal .form-group-account, 
        #transactionModal .form-group-transfer, 
        #transactionModal .form-group-spend-category-chips,
        #transactionModal .form-group-income-category-chips { 
            display: none;
        }
        .category-chips-container { margin-bottom: 1rem; max-height:150px; overflow-y:auto;
        }
        .category-chip { display: inline-block; padding: 0.3rem 0.6rem; margin: 0.2rem; font-size: 0.8rem;
            border-radius: 1rem; background-color: #e9ecef; color: #495057; cursor: pointer; border: 1px solid #ced4da; transition: background-color 0.2s, color 0.2s;
        }
        .category-chip.active { background-color: #007bff; color: white;
            border-color: #007bff;}
        .category-chip:hover:not(.active) { background-color: #d1d9e0;
        }

        .fab { position: fixed; bottom: 80px; right: 20px; width: 56px; height: 56px;
            background-color: #06b300; color: white; border-radius: 50%; text-align: center; line-height: 56px; font-size: 22px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); cursor: pointer;
            z-index: 1050; }
        .fab:hover { background-color: #2691cf;
        }
        .investment-actions .btn { margin-right: 0.5rem; margin-bottom: 0.5rem;
        }
        .modal-title { font-weight: 500; font-size: 1.1rem;
        }

        .new-filter-controls .form-control, .new-filter-controls .custom-select { font-size: 0.85rem; height: auto; padding: 0.375rem 0.75rem;
        }
        .new-filter-controls { display: flex; flex-direction: column; gap: 0.75rem; margin-bottom: 1rem;
        }
        .new-filter-controls .search-filter-group { display: flex; gap: 0.5rem;
        }
        .new-filter-controls .search-filter-group input[type="text"],
        .new-filter-controls .search-filter-group input[type="number"] { flex-grow: 1;
        }
        .new-filter-controls .search-filter-group input[type="number"] { max-width: 150px;
        }
        .new-filter-controls .select-filters-group { display: flex; flex-wrap: wrap; gap: 0.5rem;
        }
        .new-filter-controls .select-filters-group .custom-select,
        .new-filter-controls .select-filters-group .btn { flex-grow: 1;
            min-width: 120px; }
        .new-filter-controls .select-filters-group .btn { flex-grow: 0;
        }

        #filteredTotalsContainer { display: flex; justify-content: space-around; padding: 0.5rem 0; margin-bottom: 1rem;
            background-color: #e9ecef; border-radius: 0.5rem; font-size: 0.8rem; }
        .filtered-total-item { padding: 0.25rem 0.5rem;
            border-radius: 0.25rem; color: white; font-weight: 500; }
        .filtered-total-income { background-color: #28a745;
        }
        .filtered-total-spend { background-color: #dc3545;
        }
        .filtered-total-transfer { background-color: #17a2b8;
        }
        .filtered-total-net { background-color: #6c757d;
        }

        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; display: flex;
            justify-content: space-around; align-items: center; background-color: #ffffff; border-top: 1px solid #e0e0e0; box-shadow: 0 -2px 5px rgba(0,0,0,0.05); padding: 5px 0; height: 60px;
            z-index: 1040; }
        .nav-item { flex: 1; text-align: center; color: #888; cursor: pointer;
            padding: 5px 0; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 0.7rem;
        }
        .nav-item i { font-size: 1.2rem; margin-bottom: 2px;
        }
        .nav-item.active { color: #007bff;
        }
        .nav-item:hover:not(.active) { color: #555;
        }

        .chart-container { min-height: 300px; margin-bottom: 1.5rem;
        }
        .settings-actions .btn, .account-actions .btn { margin-top:0.5rem;
        }
        .account-actions .btn-sm { margin-top: 0;
            margin-left: 0.5rem;}
        .profit-loss-info { font-size: 0.9rem; font-weight: bold; margin-top: 0.5rem;
        }
        .auth-modal .modal-body { padding-bottom: 0.5rem;
        }
        .auth-modal .form-group { margin-bottom: 0.75rem;
        }
        .auth-modal .btn-link { padding-left: 0;
            font-size: 0.85rem;}
        .account-list-item { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0;
            border-bottom: 1px solid #eee; }
        .account-list-item:last-child { border-bottom: none;
        }
        .account-name-status .badge { font-size: 0.7em; vertical-align: middle;
            margin-left: 5px;}

        /* Styles for refined category management UI */
        .category-management-chips-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding: 0.5rem;
            border: 1px solid #e0e0e0;
            border-radius: 0.5rem;
            background-color: #f8f9fa;
            min-height: 50px; 
        }

        .mgmt-category-chip {
            display: inline-flex; 
            align-items: center; 
            padding: 0.3rem 0.6rem;
            font-size: 0.8rem;
            border-radius: 1rem;
            background-color: #007bff; 
            color: white;
            border: 1px solid #007bff;
            margin: 0.2rem; 
        }

        .mgmt-category-chip .remove-chip-btn {
            background: none;
            border: none;
            color: white;
            margin-left: 0.5rem; 
            padding: 0;
            line-height: 1; 
            cursor: pointer;
            font-size: 1.1em; 
            opacity: 0.7;
        }
        .mgmt-category-chip .remove-chip-btn:hover {
            opacity: 1;
        }
        .category-management-chips-container .text-muted { 
            width: 100%;
            text-align: center;
            font-size: 0.8rem;
        }

    </style>
</head>
<body>
    <div id="loginScreen"></div>

    <div id="appContainer">
        <header class="app-header rtitle"><h1 id="appname">RaGhaS Money Expense Tracker/Tool</h1></header>
        <header class="app-header"><h1 id="appTitle">Dashboard</h1></header>
        <div class="view-container">
            <div class="view active" id="homeView"> <div class="card total-balance-card"> <div class="card-body"><h2>Total Balance</h2><div class="balance-amount" id="totalBalance">₹0.00</div></div> </div> <div class="balance-visibility-toggle"><button class="btn btn-outline-secondary btn-sm" id="toggleBalanceVisibility"><i class="fas fa-eye"></i> Show Amounts</button></div> <div class="card account-balances-card"><div class="card-header">Account Balances <button class="btn btn-sm btn-outline-secondary float-right" id="toggleShowSecretAccountsHome" title="Toggle Secret Accounts Visibility"><i class="fas fa-eye-slash"></i></button></div><div class="card-body" id="accountBalancesList"></div></div> <div class="card"><div class="card-header">Recent Transactions</div><ul class="list-group list-group-flush" id="recentTransactionsListHome"><li class="list-group-item text-center text-muted">No recent transactions.</li></ul></div> <div class="card"><div class="card-header">Investment Portfolio Overview</div><div class="card-body" id="investmentSummaryHome"><p class="text-center text-muted">No active investments yet.</p></div></div> </div>
            <div class="view" id="transactionsView"> <div class="card"> <div class="card-header">Transaction History</div> <div class="card-body"> <div class="new-filter-controls"> <div class="search-filter-group"> <input id="txSearchInput" type="text" placeholder="Search description, category..." class="form-control" /> <input id="txAmountFilter" type="number" placeholder="Amount (₹)" class="form-control" step="0.01" /> </div> <div class="select-filters-group"> <select id="txMonthFilter" class="custom-select"><option value="">All Months</option></select> <select id="txYearFilter" class="custom-select"><option value="">All Years</option></select> <select id="txTypeFilter" class="custom-select"> <option value="">All Types</option><option value="income">Income</option><option value="spend">Spend</option> <option value="transfer">Transfer</option><option value="loan">Loan/Receivable</option><option value="loan_outstanding">Loan (Outstanding)</option><option value="loan_returned">Loan (Returned)</option><option value="investment_purchase">Investment Purchase</option><option value="investment_sale">Investment Sale</option></select> <button class="btn btn-sm btn-secondary" id="txClearFiltersBtn"><i class="fas fa-times"></i> Clear</button> </div> </div> <div id="filteredTotalsContainer" style="display: none;"></div> <ul class="list-group list-group-flush transaction-list" id="transactionList"><li class="list-group-item text-center text-muted" id="noTransactionsMessage">No transactions yet.</li></ul> </div> </div> </div>
            
            <div class="view" id="chartsView">
                <div class="card"><div class="card-header">Income vs. Spend Overview</div><div class="card-body chart-container"><canvas id="incomeSpendChart"></canvas><p id="noIncomeSpendData" class="text-center text-muted" style="display:none;">Not enough data.</p></div></div>
                <div class="card"><div class="card-header">Monthly Spend Trend</div><div class="card-body chart-container"><canvas id="monthlySpendChartCanvas"></canvas><p id="noMonthlySpendData" class="text-center text-muted" style="display:none;">Not enough spend data.</p></div></div>
                <div class="card"><div class="card-header">Investment Portfolio Distribution</div><div class="card-body chart-container"><canvas id="investmentPortfolioChart"></canvas><p id="noInvestmentPortfolioData" class="text-center text-muted" style="display:none;">No active investments.</p></div></div>
                <div class="card"><div class="card-header">Spend Category Breakdown</div><div class="card-body chart-container"><canvas id="spendCategoryChart"></canvas><p id="noSpendDataForCategoryChart" class="text-center text-muted" style="display:none;">Not enough spend data.</p></div></div>
            </div>
            
            <div class="view" id="investmentsView"> <div class="card"><div class="card-header">Manage Investments</div><div class="card-body investment-actions"> <button class="btn btn-outline-warning btn-sm open-investment-modal" data-type="stock"><i class="fas fa-chart-line"></i> Add Stock</button> <button class="btn btn-outline-info btn-sm open-investment-modal" data-type="mf"><i class="fas fa-umbrella-beach"></i> Add MF</button> <button class="btn btn-outline-success btn-sm open-investment-modal" data-type="fd"><i class="fas fa-piggy-bank"></i> Add FD</button> <button class="btn btn-outline-primary btn-sm open-investment-modal" data-type="postal"><i class="fas fa-envelope"></i> Add Postal</button> </div></div> <div class="card"><div class="card-header">My Investments Portfolio</div><ul class="list-group list-group-flush investment-list" id="investmentList"><li class="list-group-item text-center text-muted" id="noInvestmentsMessage">No investments yet.</li></ul></div> </div>
            <div class="view" id="settingsView"> 
                <div class="card">
                    <div class="card-header">
                        Manage Accounts
                        <button id="toggleAccountManagementBtn" class="btn btn-sm btn-outline-secondary float-right" title="Toggle Account Section">
                            <i class="fas fa-eye-slash"></i> Hide
                        </button>
                    </div>
                    <div id="accountManagementContent" class="card-body"> <form id="addAccountForm" class="mb-3">
                            <div class="form-row">
                                 <div class="col-sm-5 mb-2 mb-sm-0"> 
                                    <input type="text" class="form-control form-control-sm" id="newAccountName" placeholder="Account Name (e.g., ICICI Savings)" required> 
                                 </div> 
                                <div class="col-sm-4 mb-2 mb-sm-0"> 
                                    <input type="text" class="form-control form-control-sm" id="newAccountId" placeholder="Short ID (e.g., icici_sav)" required> 
                                 </div> 
                                <div class="col-sm-3"> 
                                    <button type="submit" class="btn btn-primary btn-sm btn-block">Add Account</button> 
                                 </div> 
                            </div>
                        </form>
                         <div id="accountsListContainer"> 
                            <p class="text-muted text-center" id="noAccountsMessageSettings">No accounts added yet.</p> 
                        </div>
                         <div class="form-group mt-3"> 
                             <div class="custom-control custom-switch"> 
                                <input type="checkbox" class="custom-control-input" id="showSecretAccountsToggleSettings"> 
                                <label class="custom-control-label" for="showSecretAccountsToggleSettings">Show Secret Accounts in Dropdowns & Summaries</label> 
                             </div> 
                        </div>
                    </div>
                </div>

                <div class="card mt-3">
                    <div class="card-header">
                        Manage Categories
                        <button id="toggleCategoryManagementBtn" class="btn btn-sm btn-outline-secondary float-right" title="Toggle Category Section">
                            <i class="fas fa-eye-slash"></i> Hide
                        </button>
                    </div>
                    <div id="categoryManagementContent" class="card-body"> 
                        <h5>Spend Categories</h5>
                        <form id="addSpendCategoryForm" class="form-inline mb-3">
                            <input type="text" class="form-control form-control-sm mr-2 flex-grow-1" id="newSpendCategoryName" placeholder="New Spend Category Name" required>
                            <button type="submit" class="btn btn-success btn-sm">Add</button>
                        </form>
                        <div id="spendCategoriesListContainer" class="category-management-chips-container">
                        </div>
                        <hr>
                        <h5>Income Categories</h5>
                        <form id="addIncomeCategoryForm" class="form-inline mb-3">
                            <input type="text" class="form-control form-control-sm mr-2 flex-grow-1" id="newIncomeCategoryName" placeholder="New Income Category Name" required>
                            <button type="submit" class="btn btn-success btn-sm">Add</button>
                        </form>
                        <div id="incomeCategoriesListContainer" class="category-management-chips-container">
                        </div>
                    </div>
                </div>
                <div class="card"><div class="card-header">Data Management</div><div class="card-body settings-actions"> <button class="btn btn-info btn-block" id="exportDataBtn"><i class="fas fa-file-export"></i> Export Data</button> <button class="btn btn-warning btn-block" id="importDataTriggerBtn"><i class="fas fa-file-import"></i> Import Data</button> <input type="file" id="importFile" accept=".json" style="display: none;"> <button class="btn btn-danger btn-block mt-3" id="resetDataBtn"><i class="fas fa-trash-restore"></i> Reset All Data</button> </div></div> 
                <div class="card mt-3"><div class="card-header">App Info</div><div class="card-body"><p class="text-muted text-center" id="appVersionInfo">RaGhaS Money Tracker - AET v3.10</p><p class="text-muted text-center">&copy; 2024-2025.</p></div></div> 
            </div>
        </div>
        <div class="fab" id="openTransactionModalFab"><i class="fas fa-plus"></i></div>
        <nav class="bottom-nav"> <div class="nav-item active" data-view="homeView" data-title="Dashboard"><i class="fas fa-home"></i> Home</div> <div class="nav-item" data-view="transactionsView" data-title="Transactions"><i class="fas fa-list-alt"></i> Transactions</div> <div class="nav-item" data-view="chartsView" data-title="Charts"><i class="fas fa-chart-pie"></i> Charts</div> <div class="nav-item" data-view="investmentsView" data-title="Investments"><i class="fas fa-piggy-bank"></i> Investments</div> <div class="nav-item" data-view="settingsView" data-title="Settings"><i class="fas fa-cog"></i> Settings</div> </nav>
    </div> 
    <div class="modal fade auth-modal" id="pinSetupModal" tabindex="-1" data-backdrop="static" data-keyboard="false" aria-labelledby="pinSetupModalLabel" aria-hidden="true"> <div class="modal-dialog modal-dialog-centered"> <div class="modal-content"> <div class="modal-header"><h5 class="modal-title" id="pinSetupModalLabel">Create Your Secure PIN</h5></div> <div class="modal-body"> <form id="pinSetupForm"> <p class="text-muted small mb-2">Create a 6-digit PIN to secure your app.</p> <div class="form-group"><label for="newPin">New 6-Digit PIN</label><input type="password" class="form-control" id="newPin" name="newPin" maxlength="6" pattern="[0-9]{6}" inputmode="numeric" required></div> <div class="form-group"><label for="confirmNewPin">Confirm PIN</label><input type="password" class="form-control" id="confirmNewPin" name="confirmNewPin" maxlength="6" pattern="[0-9]{6}" inputmode="numeric" required></div> <div class="form-group"><label for="pinHint">PIN Hint (Optional)</label><input type="text" class="form-control" id="pinHint" name="pinHint" maxlength="50"></div> <hr> <p class="text-muted small mb-2">Set up a security question for PIN recovery.</p> <div class="form-group"><label for="securityQuestion">Security Question</label><select class="custom-select" id="securityQuestion" name="securityQuestion" required></select></div> <div class="form-group"><label for="securityAnswer">Your Answer</label><input type="text" class="form-control" id="securityAnswer" name="securityAnswer" required maxlength="50"></div> <button type="submit" class="btn btn-primary btn-block mt-3">Save PIN & Settings</button> </form> </div> </div> </div> </div>
    <div class="modal fade auth-modal" id="pinLoginModal" tabindex="-1" data-backdrop="static" data-keyboard="false" aria-labelledby="pinLoginModalLabel" aria-hidden="true"> <div class="modal-dialog modal-dialog-centered"> <div class="modal-content"> <div class="modal-header"><h5 class="modal-title" id="pinLoginModalLabel">Enter PIN to Unlock</h5></div> <div class="modal-body"> <form id="pinLoginForm"> <div class="form-group"><label for="loginPin">6-Digit PIN</label><input type="password" class="form-control" id="loginPin" name="loginPin" maxlength="6" pattern="[0-9]{6}" inputmode="numeric" required></div> <div id="loginPinHint" class="text-muted small mb-2" style="display:none;"></div> <button type="submit" class="btn btn-primary btn-block">Login</button> </form> <div class="mt-2 d-flex justify-content-between"> <button type="button" class="btn btn-link btn-sm" id="showPinHintBtn">Show Hint</button> <button type="button" class="btn btn-link btn-sm" id="forgotPinBtn">Forgot PIN?</button> </div> </div> </div> </div> </div>
    <div class="modal fade auth-modal" id="forgotPinModal" tabindex="-1" data-backdrop="static" data-keyboard="false" aria-labelledby="forgotPinModalLabel" aria-hidden="true"> <div class="modal-dialog modal-dialog-centered"> <div class="modal-content"> <div class="modal-header"><h5 class="modal-title" id="forgotPinModalLabel">Reset PIN - Security Question</h5><button type="button" class="close" data-dismiss="modal" aria-label="Close" id="closeForgotPinModal"><span aria-hidden="true">&times;</span></button></div> <div class="modal-body"> <form id="securityQuestionForm"> <p id="displayedSecurityQuestion" class="font-weight-bold"></p> <div class="form-group"><label for="answerToSecurityQuestion">Your Answer</label><input type="text" class="form-control" id="answerToSecurityQuestion" name="answerToSecurityQuestion" required maxlength="50"></div> <button type="submit" class="btn btn-primary btn-block">Submit Answer</button> </form> </div> </div> </div> </div>
    <div class="modal fade auth-modal" id="resetPinModal" tabindex="-1" data-backdrop="static" data-keyboard="false" aria-labelledby="resetPinModalLabel" aria-hidden="true"> <div class="modal-dialog modal-dialog-centered"> <div class="modal-content"> <div class="modal-header"><h5 class="modal-title" id="resetPinModalLabel">Set New PIN</h5></div> <div class="modal-body"> <form id="resetPinForm"> <div class="form-group"><label for="newPinForReset">New 6-Digit PIN</label><input type="password" class="form-control" id="newPinForReset" name="newPinForReset" maxlength="6" pattern="[0-9]{6}" inputmode="numeric" required></div> <div class="form-group"><label for="confirmNewPinForReset">Confirm New PIN</label><input type="password" class="form-control" id="confirmNewPinForReset" name="confirmNewPinForReset" maxlength="6" pattern="[0-9]{6}" inputmode="numeric" required></div> <button type="submit" class="btn btn-primary btn-block">Set New PIN</button> </form> </div> </div> </div> </div>

    <div class="modal fade" id="transactionModal" tabindex="-1" aria-hidden="true"> <div class="modal-dialog modal-dialog-centered"> <div class="modal-content"> <div class="modal-header"><h5 class="modal-title" id="transactionModalTitle">Add New Transaction</h5><button type="button" class="close" data-dismiss="modal" aria-label="Close">&times;</button></div> <div class="modal-body"><form id="transactionForm"><input type="hidden" id="editingTransactionId"><div class="form-group"><label for="transactionType">Type</label><select class="custom-select" id="transactionType" required><option value="income">Income</option><option value="spend">Spend</option><option value="transfer">Transfer</option><option value="loan">Loan/Receivable</option></select></div>
    <div class="form-group form-group-spend-category-chips"><label>Spend Category</label><div class="category-chips-container" id="spendCategoryChipsContainer"></div></div>
    <div class="form-group form-group-income-category-chips"><label>Income Category</label><div class="category-chips-container" id="incomeCategoryChipsContainer"></div></div>
    <div class="form-group form-group-account"><label for="transactionAccount" id="transactionAccountLabel">Account</label><select class="custom-select" id="transactionAccount"></select></div><div class="form-group form-group-transfer"><label for="transferFromAccount">From Account</label><select class="custom-select" id="transferFromAccount"></select></div><div class="form-group form-group-transfer"><label for="transferToAccount">To Account</label><select class="custom-select" id="transferToAccount"></select></div><div class="form-group"><label for="transactionDescription" id="transactionDescriptionLabel">Description</label><input type="text" class="form-control" id="transactionDescription" placeholder="e.g., Salary, Coffee, Loan to John" required></div><div class="form-group"><label for="transactionAmount" id="transactionAmountLabel">Amount (₹)</label><input type="number" class="form-control" id="transactionAmount" placeholder="0.00" step="0.01" min="0.01" required></div><div class="form-group"><label for="transactionDate" id="transactionDateLabel">Date</label><input type="date" class="form-control" id="transactionDate" required></div><input type="hidden" id="selectedCategoryInput"><button type="submit" class="btn btn-primary btn-block" id="transactionSubmitBtn">Add Transaction</button></form></div></div></div></div>
    
    <div class="modal fade" id="recordLoanReturnModal" tabindex="-1" aria-labelledby="recordLoanReturnModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="recordLoanReturnModalLabel">Record Loan Return/Refund</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                </div>
                <div class="modal-body">
                    <form id="recordLoanReturnForm">
                         <input type="hidden" id="originalLoanIdToReturn">
                        <p>Recording return for loan: "<strong id="loanReturnDescription"></strong>"</p>
                        <p>Original amount lent: <strong id="originalLoanAmountDisplay"></strong></p>
                        <div class="form-group">
                             <label for="loanReturnDateInput">Return Date</label>
                            <input type="date" class="form-control" id="loanReturnDateInput" required>
                        </div>
                        <div class="form-group">
                             <label for="loanReturnAmountInput">Amount Returned (₹)</label>
                            <input type="number" class="form-control" id="loanReturnAmountInput" step="0.01" min="0.01" required>
                        </div>
                         <div class="form-group">
                            <label for="loanReturnAccountSelect">Deposit to Account</label>
                            <select class="custom-select" id="loanReturnAccountSelect" required></select>
                        </div>
                         <button type="submit" class="btn btn-success btn-block">Record Return</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="investmentModal" tabindex="-1" aria-hidden="true"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Add New Investment</h5><button type="button" class="close" data-dismiss="modal" aria-label="Close">&times;</button></div><div class="modal-body"><form id="investmentForm"><input type="hidden" id="investmentId"><div class="form-group"><label for="investmentType">Type</label><select class="custom-select" id="investmentType" required><option value="stock">Stock</option><option value="mf">Mutual Fund</option><option value="fd">Fixed Deposit</option><option value="postal">Postal</option></select></div><div class="form-group"><label for="investmentDescription">Description</label><input type="text" class="form-control" id="investmentDescription" required></div><div class="form-group"><label for="investmentDate">Date</label><input type="date" class="form-control" id="investmentDate" required></div><div class="form-group"><label for="investmentAmount">Amount Invested (₹)</label><input type="number" class="form-control" id="investmentAmount" step="0.01" min="0.01" required></div><div class="form-group"><label for="investmentSourceAccount">Source Account</label><select class="custom-select" id="investmentSourceAccount" required></select></div><div class="form-group"><label for="investmentMaturity">Maturity Info (Optional)</label><input type="text" class="form-control" id="investmentMaturity"></div><button type="submit" class="btn btn-success btn-block">Save Investment</button></form></div></div></div></div>
    <div class="modal fade" id="updateInvestmentValueModal" tabindex="-1" aria-hidden="true"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Update Investment Value</h5><button type="button" class="close" data-dismiss="modal" aria-label="Close">&times;</button></div><div class="modal-body"><form id="updateInvestmentValueForm"><input type="hidden" id="updateValueInvestmentId"><p>Investment: <strong id="updateValueInvestmentName"></strong></p><div class="form-group"><label for="investmentCurrentValue">New Current Value (₹)</label><input type="number" class="form-control" id="investmentCurrentValue" step="0.01" min="0" required></div><button type="submit" class="btn btn-primary btn-block">Update Value</button></form></div></div></div></div>
    <div class="modal fade" id="redeemInvestmentModal" tabindex="-1" aria-hidden="true"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Redeem Investment</h5><button type="button" class="close" data-dismiss="modal" aria-label="Close">&times;</button></div><div class="modal-body"><form id="redeemInvestmentForm"><input type="hidden" id="redeemInvestmentId"><p>Investment: <strong id="redeemInvestmentName"></strong></p><p>Initial Cost: <strong id="redeemInvestmentInitialCost"></strong></p><div class="form-group"><label for="investmentRedeemedAmount">Amount Received from Redemption (₹)</label><input type="number" class="form-control" id="investmentRedeemedAmount" step="0.01" min="0.01" required></div><div class="form-group"><label for="investmentRedemptionDate">Redemption Date</label><input type="date" class="form-control" id="investmentRedemptionDate" required></div><div class="form-group"><label for="redemptionDepositAccount">Deposit to Account</label><select class="custom-select" id="redemptionDepositAccount" required></select></div><div id="redeemProfitLossInfo" class="profit-loss-info text-center mb-2"></div><button type="submit" class="btn btn-success btn-block">Confirm Redemption</button></form></div></div></div></div>

<script>
// --- Constants for PIN System ---
const PIN_DATA_KEY = 'moneyTrackerPinData_v1';
const SECURITY_QUESTIONS = [
    "What was your childhood nickname?",
    "What is the name of your first pet?",
    "What is your favorite movie?",
    "In what city were you born?",
    "What is your mother's maiden name?"
];

// --- Hashing Utility (using SubtleCrypto) ---
async function hashData(str) {
    const encoder = new TextEncoder();
    const data = encoder.encode(str);
    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}

document.addEventListener('DOMContentLoaded', () => {
    // --- DOM Elements (Main App) ---
    const appContainerEl = document.getElementById('appContainer');
    const appTitleEl = document.getElementById('appTitle');
    const views = document.querySelectorAll('.view');
    const navItems = document.querySelectorAll('.bottom-nav .nav-item');
    const recentTransactionsListHomeEl = document.getElementById('recentTransactionsListHome');
    const investmentSummaryHomeEl = document.getElementById('investmentSummaryHome');
    const spendCategoryChartCanvas = document.getElementById('spendCategoryChart')?.getContext('2d');
    const noSpendDataForCategoryChartEl = document.getElementById('noSpendDataForCategoryChart');
    const incomeSpendChartCanvas = document.getElementById('incomeSpendChart')?.getContext('2d');
    const noIncomeSpendDataEl = document.getElementById('noIncomeSpendData');
    const investmentPortfolioChartCanvas = document.getElementById('investmentPortfolioChart')?.getContext('2d');
    const noInvestmentPortfolioDataEl = document.getElementById('noInvestmentPortfolioData');
    const exportDataBtn = document.getElementById('exportDataBtn');
    const importFileEl = document.getElementById('importFile');
    const importDataTriggerBtn = document.getElementById('importDataTriggerBtn');
    const resetDataBtn = document.getElementById('resetDataBtn');
    const transactionForm = document.getElementById('transactionForm');
    const transactionListEl = document.getElementById('transactionList');
    const totalBalanceEl = document.getElementById('totalBalance');
    const transactionDateEl = document.getElementById('transactionDate');
    const noTransactionsMessageEl = document.getElementById('noTransactionsMessage');
    const transactionTypeEl = document.getElementById('transactionType');
    const transactionAccountLabelEl = document.getElementById('transactionAccountLabel');
    const transactionAmountLabelEl = document.getElementById('transactionAmountLabel');
    const accountGroupEl = document.querySelector('#transactionModal .form-group-account');
    const transferGroupEls = document.querySelectorAll('#transactionModal .form-group-transfer');
    const spendCategoryChipsGroupEl = document.querySelector('#transactionModal .form-group-spend-category-chips');
    const spendCategoryChipsContainerEl = document.getElementById('spendCategoryChipsContainer');
    const incomeCategoryChipsGroupEl = document.querySelector('#transactionModal .form-group-income-category-chips');
    const incomeCategoryChipsContainerEl = document.getElementById('incomeCategoryChipsContainer');
    const transactionDescriptionLabelEl = document.getElementById('transactionDescriptionLabel');
    const selectedCategoryInputEl = document.getElementById('selectedCategoryInput');
    const accountBalancesListEl = document.getElementById('accountBalancesList');
    const toggleBalanceVisibilityBtn = document.getElementById('toggleBalanceVisibility');
    const investmentForm = document.getElementById('investmentForm');
    const investmentListEl = document.getElementById('investmentList');
    const noInvestmentsMessageEl = document.getElementById('noInvestmentsMessage');
    const investmentModalJQ = $('#investmentModal');
    const transactionModalJQ = $('#transactionModal');
    const investmentTypeSelect = document.getElementById('investmentType');
    const investmentDateEl = document.getElementById('investmentDate');
    const investmentSourceAccountEl = document.getElementById('investmentSourceAccount');
    const txSearchInputEl = document.getElementById('txSearchInput');
    const txAmountFilterEl = document.getElementById('txAmountFilter');
    const txMonthFilterEl = document.getElementById('txMonthFilter');
    const txYearFilterEl = document.getElementById('txYearFilter');
    const txTypeFilterEl = document.getElementById('txTypeFilter');
    const txClearFiltersBtnEl = document.getElementById('txClearFiltersBtn');
    const filteredTotalsContainerEl = document.getElementById('filteredTotalsContainer');
    const fabOpenTransactionModal = document.getElementById('openTransactionModalFab');
    let lastFocusedElementBeforeModal;
    const transactionModalTitleEl = document.getElementById('transactionModalTitle');
    const transactionSubmitBtnEl = document.getElementById('transactionSubmitBtn');
    const editingTransactionIdEl = document.getElementById('editingTransactionId');
    const appVersionInfoEl = document.getElementById('appVersionInfo');
    const updateInvestmentValueForm = document.getElementById('updateInvestmentValueForm');
    const updateValueInvestmentIdEl = document.getElementById('updateValueInvestmentId');
    const updateValueInvestmentNameEl = document.getElementById('updateValueInvestmentName');
    const investmentCurrentValueEl = document.getElementById('investmentCurrentValue');
    const redeemInvestmentForm = document.getElementById('redeemInvestmentForm');
    const redeemInvestmentIdEl = document.getElementById('redeemInvestmentId');
    const redeemInvestmentNameEl = document.getElementById('redeemInvestmentName');
    const redeemInvestmentInitialCostEl = document.getElementById('redeemInvestmentInitialCost');
    const investmentRedeemedAmountEl = document.getElementById('investmentRedeemedAmount');
    const investmentRedemptionDateEl = document.getElementById('investmentRedemptionDate');
    const redemptionDepositAccountEl = document.getElementById('redemptionDepositAccount');
    const redeemProfitLossInfoEl = document.getElementById('redeemProfitLossInfo');
    const recordLoanReturnFormEl = document.getElementById('recordLoanReturnForm');
    const originalLoanIdToReturnEl = document.getElementById('originalLoanIdToReturn');
    const loanReturnDescriptionEl = document.getElementById('loanReturnDescription');
    const originalLoanAmountDisplayEl = document.getElementById('originalLoanAmountDisplay');
    const loanReturnDateInputEl = document.getElementById('loanReturnDateInput');
    const loanReturnAmountInputEl = document.getElementById('loanReturnAmountInput');
    const loanReturnAccountSelectEl = document.getElementById('loanReturnAccountSelect');
    const addAccountFormEl = document.getElementById('addAccountForm');
    const newAccountNameEl = document.getElementById('newAccountName');
    const newAccountIdEl = document.getElementById('newAccountId');
    const accountsListContainerEl = document.getElementById('accountsListContainer');
    const noAccountsMessageSettingsEl = document.getElementById('noAccountsMessageSettings');
    const showSecretAccountsToggleSettingsEl = document.getElementById('showSecretAccountsToggleSettings');
    const toggleShowSecretAccountsHomeBtn = document.getElementById('toggleShowSecretAccountsHome');

    const addSpendCategoryFormEl = document.getElementById('addSpendCategoryForm');
    const newSpendCategoryNameEl = document.getElementById('newSpendCategoryName');
    const spendCategoriesListContainerEl = document.getElementById('spendCategoriesListContainer');
    const addIncomeCategoryFormEl = document.getElementById('addIncomeCategoryForm');
    const newIncomeCategoryNameEl = document.getElementById('newIncomeCategoryName');
    const incomeCategoriesListContainerEl = document.getElementById('incomeCategoriesListContainer');
    const toggleCategoryManagementBtn = document.getElementById('toggleCategoryManagementBtn');
    const categoryManagementContentEl = document.getElementById('categoryManagementContent');

    const toggleAccountManagementBtn = document.getElementById('toggleAccountManagementBtn');
    const accountManagementContentEl = document.getElementById('accountManagementContent');

    // --- DOM Elements (PIN System) ---
    const loginScreenEl = document.getElementById('loginScreen');
    const pinSetupForm = document.getElementById('pinSetupForm');
    const newPinEl = document.getElementById('newPin');
    const confirmNewPinEl = document.getElementById('confirmNewPin');
    const pinHintEl = document.getElementById('pinHint');
    const securityQuestionSelectEl = document.getElementById('securityQuestion');
    const securityAnswerEl = document.getElementById('securityAnswer');
    const pinLoginForm = document.getElementById('pinLoginForm');
    const loginPinEl = document.getElementById('loginPin');
    const loginPinHintEl = document.getElementById('loginPinHint');
    const showPinHintBtn = document.getElementById('showPinHintBtn');
    const forgotPinBtn = document.getElementById('forgotPinBtn');
    const securityQuestionForm = document.getElementById('securityQuestionForm');
    const displayedSecurityQuestionEl = document.getElementById('displayedSecurityQuestion');
    const answerToSecurityQuestionEl = document.getElementById('answerToSecurityQuestion');
    const closeForgotPinModalBtn = document.getElementById('closeForgotPinModal');
    const resetPinForm = document.getElementById('resetPinForm');
    const newPinForResetEl = document.getElementById('newPinForReset');
    const confirmNewPinForResetEl = document.getElementById('confirmNewPinForReset');

    // --- App State & Config (Main App) ---
    const APP_VERSION = "AET v3.10";
    const LOCAL_STORAGE_ACCOUNTS_KEY = `accounts_adv_${APP_VERSION}_v1`;
    const LOCAL_STORAGE_TRANSACTIONS_KEY = `transactions_adv_${APP_VERSION}_acct_mgmt_v1_loan`;
    const LOCAL_STORAGE_INVESTMENTS_KEY = `investments_adv_${APP_VERSION}_acct_mgmt_v1_loan`;
    const LOCAL_STORAGE_SPEND_CATEGORIES_KEY = `spend_categories_adv_${APP_VERSION}_v1`;
    const LOCAL_STORAGE_INCOME_CATEGORIES_KEY = `income_categories_adv_${APP_VERSION}_v1`;
    const LOCAL_STORAGE_CATEGORY_MGMT_VISIBLE_KEY = `category_mgmt_visible_${APP_VERSION}_v1`;

    const LOCAL_STORAGE_ACCOUNT_MGMT_VISIBLE_KEY = `account_mgmt_visible_${APP_VERSION}_v1`; // New key
    
    let accountManagementVisible = false; // New state variable, default to true (visible)
    
    let accounts = [];
    let showSecretAccounts = false;
    let spendCategories = [];
    let incomeCategories = [];
    const investmentRelatedCategories = ['Investment Expense', 'Investment Income'];
    let balancesVisible = false;
    let transactions = [];
    let investments = [];
    const investmentTypeNames = { stock: 'Stock', mf: 'Mutual Fund', fd: 'Fixed Deposit', postal: 'Postal' };
    let spendCategoryChartInstance = null;
    let incomeSpendChartInstance = null;
    let investmentPortfolioChartInstance = null;
    let isAuthenticated = false;
    let categoryManagementVisible = false;

    // --- Utility Functions (Main App - Defined early for access) ---
    function saveTransactions() { if(isAuthenticated) localStorage.setItem(LOCAL_STORAGE_TRANSACTIONS_KEY, JSON.stringify(transactions));}
    function saveInvestments() { if(isAuthenticated) localStorage.setItem(LOCAL_STORAGE_INVESTMENTS_KEY, JSON.stringify(investments));}
    
    function saveSpendCategories() {
        if (isAuthenticated) localStorage.setItem(LOCAL_STORAGE_SPEND_CATEGORIES_KEY, JSON.stringify(spendCategories));
    }
    function saveIncomeCategories() {
        if (isAuthenticated) localStorage.setItem(LOCAL_STORAGE_INCOME_CATEGORIES_KEY, JSON.stringify(incomeCategories));
    }

    function formatDate(dateString) { return new Date(dateString).toLocaleDateString('en-CA');
    }
    function displayDate(dateString) { return new Date(dateString).toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });}
    function formatCurrency(amount) { return new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(amount);
    }
    function setDefaultDate(dateElement) { if(dateElement && !dateElement.value) dateElement.valueAsDate = new Date();
    }
    
    function loadCategories() {
        const storedSpendCategories = localStorage.getItem(LOCAL_STORAGE_SPEND_CATEGORIES_KEY);
        if (storedSpendCategories) {
            spendCategories = JSON.parse(storedSpendCategories);
        } else {
            spendCategories = [ 'Bills & Recharges', 'CC Bills', 'Cloths', 'Education', 'Entertainment', 'EMI', 'Foods & Drinks' ,'Fuel', 'Gifts', 'Groceries', 'Homes & Utilities', 'Health & Medicine', 'Insurance', 'Investment Expense', 'Labs & Tests', 'Maintenance', 'Travel', 'Shopping', 'Parties', 'Vacation', 'Personal Care', 'Rent', 'Subscriptions', 'Others' ];
            saveSpendCategories();
        }

        const storedIncomeCategories = localStorage.getItem(LOCAL_STORAGE_INCOME_CATEGORIES_KEY);
        if (storedIncomeCategories) {
            incomeCategories = JSON.parse(storedIncomeCategories);
        } else {
            incomeCategories = ["Salary", "In-hand Cash", "Savings", "Earnings", "Investment Income", "Gifts Received", "Refunds", "Other Income"];
            saveIncomeCategories();
        }
    }

    // --- Account Management Functions ---
    function loadAccounts() {
        const storedAccounts = localStorage.getItem(LOCAL_STORAGE_ACCOUNTS_KEY);
        if (storedAccounts) {
            accounts = JSON.parse(storedAccounts);
        } else {
            accounts = [
                { id: 'cash', name: 'Cash', status: 'active' },
                { id: 'sbi', name: 'SBI', status: 'active' }
            ];
            saveAccounts();
        }
        showSecretAccounts = JSON.parse(localStorage.getItem('showSecretAccounts')) || false;
        if (showSecretAccountsToggleSettingsEl) showSecretAccountsToggleSettingsEl.checked = showSecretAccounts;
        if (toggleShowSecretAccountsHomeBtn) {
             toggleShowSecretAccountsHomeBtn.innerHTML = showSecretAccounts ?
            '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
             toggleShowSecretAccountsHomeBtn.title = showSecretAccounts ? "Hide Secret Accounts" : "Show Secret Accounts";
        }
    }

    function saveAccounts() {
        localStorage.setItem(LOCAL_STORAGE_ACCOUNTS_KEY, JSON.stringify(accounts));
    }

    function getAccountNameById(accountId) {
        const account = accounts.find(acc => acc.id === accountId);
        return account ? account.name : 'N/A';
    }

    function getVisibleAccounts() {
        return accounts.filter(acc => acc.status === 'active' || (acc.status === 'secret' && showSecretAccounts));
    }
    
    function populateAccountDropdown(selectElement, selectedValue = "") {
        if (!selectElement) return;
        const visibleAccounts = getVisibleAccounts();
        selectElement.innerHTML = '<option value="">-- Select Account --</option>';
        visibleAccounts.forEach(acc => {
            const option = document.createElement('option');
            option.value = acc.id; 
            option.textContent = acc.name;
            if (acc.id === selectedValue) option.selected = true;
            selectElement.appendChild(option);
        });
    }

    function populateAllAccountDropdowns() { 
        if (!isAuthenticated) return;
        populateAccountDropdown(document.getElementById('transactionAccount'));
        populateAccountDropdown(document.getElementById('transferFromAccount'));
        populateAccountDropdown(document.getElementById('transferToAccount'));
        if (investmentSourceAccountEl) populateAccountDropdown(investmentSourceAccountEl);
        if (redemptionDepositAccountEl) populateAccountDropdown(redemptionDepositAccountEl);
        if (loanReturnAccountSelectEl) populateAccountDropdown(loanReturnAccountSelectEl);
    }
    
    function renderAccountManagementList() {
        if (!isAuthenticated || !accountsListContainerEl) return;
        accountsListContainerEl.innerHTML = ''; 

        if (accounts.length === 0) {
            if (noAccountsMessageSettingsEl) noAccountsMessageSettingsEl.style.display = 'block';
            return;
        }
        if (noAccountsMessageSettingsEl) noAccountsMessageSettingsEl.style.display = 'none';

        const ul = document.createElement('ul');
        ul.className = 'list-group';

        accounts.forEach(acc => {
            const li = document.createElement('li');
            li.className = 'list-group-item account-list-item';

            let statusBadge = '';
            if (acc.status === 'inactive') {
                statusBadge = '<span class="badge badge-secondary">Inactive</span>';
            } else 
            if (acc.status === 'secret') {
                statusBadge = '<span class="badge badge-warning">Secret</span>';
            } else {
                 statusBadge = '<span class="badge badge-success">Active</span>';
            }

            li.innerHTML = `
                 <div class="account-name-status">
                    ${acc.name} (ID: ${acc.id}) ${statusBadge}
                </div>
                <div class="account-actions">
                    <button class="btn btn-sm ${acc.status === 'active' || acc.status === 'secret' ? 'btn-outline-warning' : 'btn-outline-success'} toggle-account-status-btn" data-id="${acc.id}" title="${acc.status === 'active' ||
acc.status === 'secret' ? 'Deactivate' : 'Activate'}">
                        ${acc.status === 'active' || acc.status === 'secret' ? '<i class="fas fa-toggle-off"></i> Deactivate' : '<i class="fas fa-toggle-on"></i> Activate'}
                    </button>
                    <button class="btn btn-sm ${acc.status === 'secret' ?
'btn-outline-info' : 'btn-outline-secondary'} toggle-account-secret-btn" data-id="${acc.id}" title="${acc.status === 'secret' ? 'Make Public' : 'Make Secret'}">
                        ${acc.status === 'secret' ? '<i class="fas fa-eye"></i> Public' : '<i class="fas fa-eye-slash"></i> Secret'}
                    </button>
                    </div>
             `;
            ul.appendChild(li);
        });
        accountsListContainerEl.appendChild(ul);
    }

    function renderCategoryManagementUI() {
        if (!isAuthenticated || !spendCategoriesListContainerEl || !incomeCategoriesListContainerEl) return;

        spendCategoriesListContainerEl.innerHTML = '';
        if (spendCategories.length === 0) {
            spendCategoriesListContainerEl.innerHTML = '<p class="text-muted text-center small m-0">No spend categories defined. Add one above.</p>';
        } else {
            spendCategories.sort().forEach(cat => {
                const chip = document.createElement('span');
                chip.className = 'mgmt-category-chip';
                chip.innerHTML = `
                    ${cat}
                    <button class="remove-chip-btn remove-category-btn" data-type="spend" data-category="${cat}" title="Remove ${cat}">&times;</button>
                `;
                spendCategoriesListContainerEl.appendChild(chip);
            });
        }

        incomeCategoriesListContainerEl.innerHTML = '';
        if (incomeCategories.length === 0) {
            incomeCategoriesListContainerEl.innerHTML = '<p class="text-muted text-center small m-0">No income categories defined. Add one above.</p>';
        } else {
            incomeCategories.sort().forEach(cat => {
                const chip = document.createElement('span');
                chip.className = 'mgmt-category-chip';
                chip.innerHTML = `
                    ${cat}
                    <button class="remove-chip-btn remove-category-btn" data-type="income" data-category="${cat}" title="Remove ${cat}">&times;</button>
                `;
                incomeCategoriesListContainerEl.appendChild(chip);
            });
        }
    }

    function loadCategoryManagementVisibility() {
        const storedVisibility = localStorage.getItem(LOCAL_STORAGE_CATEGORY_MGMT_VISIBLE_KEY);
        if (storedVisibility !== null) {
            categoryManagementVisible = JSON.parse(storedVisibility);
        } else {
            categoryManagementVisible = true; 
        }
    }

    function saveCategoryManagementVisibility() {
        if(isAuthenticated) localStorage.setItem(LOCAL_STORAGE_CATEGORY_MGMT_VISIBLE_KEY, JSON.stringify(categoryManagementVisible));
    }

    function applyCategoryManagementVisibility() {
        if (!categoryManagementContentEl || !toggleCategoryManagementBtn) return;

        if (categoryManagementVisible) {
            categoryManagementContentEl.style.display = 'block';
            toggleCategoryManagementBtn.innerHTML = '<i class="fas fa-eye-slash"></i> Hide';
            toggleCategoryManagementBtn.title = 'Hide Category Section';
        } else {
            categoryManagementContentEl.style.display = 'none';
            toggleCategoryManagementBtn.innerHTML = '<i class="fas fa-eye"></i> Show';
            toggleCategoryManagementBtn.title = 'Show Category Section';
        }
    }

    function loadAccountManagementVisibility() {
        const storedVisibility = localStorage.getItem(LOCAL_STORAGE_ACCOUNT_MGMT_VISIBLE_KEY);
        if (storedVisibility !== null) {
            accountManagementVisible = JSON.parse(storedVisibility);
        } else {
            accountManagementVisible = true; // Default to visible if not set
        }
    }

    function saveAccountManagementVisibility() {
        if(isAuthenticated) localStorage.setItem(LOCAL_STORAGE_ACCOUNT_MGMT_VISIBLE_KEY, JSON.stringify(accountManagementVisible));
    }

    function applyAccountManagementVisibility() {
        if (!accountManagementContentEl || !toggleAccountManagementBtn) return;

        if (accountManagementVisible) {
            accountManagementContentEl.style.display = 'block';
            toggleAccountManagementBtn.innerHTML = '<i class="fas fa-eye-slash"></i> Hide';
            toggleAccountManagementBtn.title = 'Hide Account Section';
        } else {
            accountManagementContentEl.style.display = 'none';
            toggleAccountManagementBtn.innerHTML = '<i class="fas fa-eye"></i> Show';
            toggleAccountManagementBtn.title = 'Show Account Section';
        }
    }


    // --- View Management (Main App) ---
    function showView(viewId, title) { 
        if (!isAuthenticated) return;
        views.forEach(view => view.classList.remove('active'));
        const targetView = document.getElementById(viewId);
        if (targetView) targetView.classList.add('active'); else console.error("View not found:", viewId);
   
        navItems.forEach(item => item.classList.toggle('active', item.dataset.view === viewId));
        if(appTitleEl) appTitleEl.textContent = title;
        
        if (viewId === 'chartsView') { renderSpendCategoryChart(); renderIncomeSpendChart(); renderInvestmentPortfolioChart(); renderMonthlySpendChart();
        }
        if (viewId === 'homeView') renderHomePageSummaries();
        if (viewId === 'investmentsView') renderInvestmentList();
        if (viewId === 'transactionsView') renderFullTransactionList();
        if (viewId === 'settingsView') {
            renderAccountManagementList();
            renderCategoryManagementUI();
            applyCategoryManagementVisibility();
            applyAccountManagementVisibility(); 
        }
    }

    // --- Chart Rendering (Main App) ---
    function renderSpendCategoryChart() { if (!isAuthenticated || !spendCategoryChartCanvas) return;
    const categorySpends = {}; transactions.filter(t => t.type === 'spend' && t.category && !investmentRelatedCategories.includes(t.category)).forEach(t => { categorySpends[t.category] = (categorySpends[t.category] || 0) + t.amount; });
    const labels = Object.keys(categorySpends); const data = Object.values(categorySpends); const backgroundColors = labels.map((_, index) => `hsl(${(index * 45 + 10) % 360}, 70%, 65%)`);
    if (noSpendDataForCategoryChartEl) noSpendDataForCategoryChartEl.style.display = (labels.length === 0) ? 'block' : 'none'; if (spendCategoryChartCanvas.parentElement) spendCategoryChartCanvas.parentElement.style.display = (labels.length > 0) ?
    'block' : 'none'; if (labels.length === 0) { if(spendCategoryChartInstance) spendCategoryChartInstance.destroy(); spendCategoryChartInstance = null; return; } if (spendCategoryChartInstance) spendCategoryChartInstance.destroy();
    spendCategoryChartInstance = new Chart(spendCategoryChartCanvas, { type: 'doughnut', data: { labels: labels, datasets: [{ label: 'Spend by Category', data: data, backgroundColor: backgroundColors, borderColor: '#fff', borderWidth: 2, hoverOffset: 8 }] }, options: { responsive: true, maintainAspectRatio: false, animation: { animateScale: true, animateRotate: true }, plugins: { legend: { position: 'bottom', labels: { font: { size: 10 }, boxWidth:15, padding:10 } }, tooltip: { callbacks: { label: context => `${context.label || ''}: ${formatCurrency(context.parsed)} (${((context.parsed / context.dataset.data.reduce((a,b)=>a+b,0)) * 100).toFixed(1)}%)` }} } } });
    }
    function renderIncomeSpendChart() { if (!isAuthenticated || !incomeSpendChartCanvas) return; let totalIncome = 0; let totalSpend = 0;
    transactions.forEach(t => { if (t.type === 'income') totalIncome += t.amount; else if (t.type === 'spend') totalSpend += t.amount; else if (t.type === 'loan') { totalSpend += t.amount; if (t.loanStatus === 'returned' && t.returnDetails) { totalIncome += t.returnDetails.returnAmount; } } });
    if (noIncomeSpendDataEl) noIncomeSpendDataEl.style.display = (totalIncome === 0 && totalSpend === 0) ? 'block' : 'none';
    if (incomeSpendChartCanvas.parentElement) incomeSpendChartCanvas.parentElement.style.display = (totalIncome > 0 || totalSpend > 0) ? 'block' : 'none';
    if (totalIncome === 0 && totalSpend === 0) { if (incomeSpendChartInstance) incomeSpendChartInstance.destroy(); incomeSpendChartInstance = null; return; } if (incomeSpendChartInstance) incomeSpendChartInstance.destroy();
    incomeSpendChartInstance = new Chart(incomeSpendChartCanvas, { type: 'bar', data: { labels: ['Total Income', 'Total Spend'], datasets: [{ label: 'Amount (₹)', data: [totalIncome, totalSpend], backgroundColor: ['rgba(75, 192, 192, 0.6)', 'rgba(255, 99, 132, 0.6)'], borderColor: ['rgba(75, 192, 192, 1)', 'rgba(255, 99, 132, 1)'], borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { callback: value => formatCurrency(value) } } }, plugins: { legend: { display: false }, tooltip: { callbacks: { label: context => `${context.label}: ${formatCurrency(context.parsed.y)}` }} } } });
    }
    function renderInvestmentPortfolioChart() { if (!isAuthenticated || !investmentPortfolioChartCanvas) return; const activeInvestments = investments.filter(inv => inv.status === 'active');
    const portfolioData = {}; activeInvestments.forEach(inv => { const typeName = investmentTypeNames[inv.type] || 'Other'; const value = inv.currentValue !== null && inv.currentValue !== undefined ? inv.currentValue : inv.amount; portfolioData[typeName] = (portfolioData[typeName] || 0) + value; });
    const labels = Object.keys(portfolioData); const data = Object.values(portfolioData); const backgroundColors = labels.map((_, index) => `hsl(${(index * 60 + 30) % 360}, 65%, 60%)`);
    if (noInvestmentPortfolioDataEl) noInvestmentPortfolioDataEl.style.display = (labels.length === 0) ? 'block' : 'none'; if (investmentPortfolioChartCanvas.parentElement) investmentPortfolioChartCanvas.parentElement.style.display = (labels.length > 0) ?
    'block' : 'none'; if (labels.length === 0) { if (investmentPortfolioChartInstance) investmentPortfolioChartInstance.destroy(); investmentPortfolioChartInstance = null; return; } if (investmentPortfolioChartInstance) investmentPortfolioChartInstance.destroy();
    investmentPortfolioChartInstance = new Chart(investmentPortfolioChartCanvas, { type: 'pie', data: { labels: labels, datasets: [{ label: 'Investment Value', data: data, backgroundColor: backgroundColors, borderColor: '#fff', borderWidth: 2, hoverOffset: 8 }] }, options: { responsive: true, maintainAspectRatio: false, animation: { animateScale: true, animateRotate: true }, plugins: { legend: { position: 'bottom', labels: { font: { size: 10 }, boxWidth:15, padding:10 } }, tooltip: { callbacks: { label: context => `${context.label || ''}: ${formatCurrency(context.parsed)} (${((context.parsed / context.dataset.data.reduce((a,b)=>a+b,0)) * 100).toFixed(1)}%)` }} } } });
    }
    
    // --- Chart Rendering (Cont.) ---
function renderMonthlySpendChart() {
    if (!isAuthenticated || !document.getElementById('monthlySpendChartCanvas')) return;
    
    const monthlyData = {};

    transactions.forEach(t => {
        let spendAmount = 0;
        
        // 1. Standard Spend: Count all standard 'spend' transactions (excluding investments)
        if (t.type === 'spend' && !investmentRelatedCategories.includes(t.category)) {
            spendAmount = t.amount;
        } 
        // 2. Loan Spend: Count the initial amount lent for *all* loans as a spend/debit
        else if (t.type === 'loan') {
            spendAmount = t.amount; 
        }

        if (spendAmount > 0) {
            const date = new Date(t.date);
            // Use date.getTime() for accurate chronological sorting of labels
            const timeKey = date.getFullYear() * 100 + (date.getMonth() + 1); 
            const monthLabel = date.toLocaleDateString('en-US', { year: 'numeric', month: 'short' });

            if (!monthlyData[timeKey]) {
                monthlyData[timeKey] = {
                    totalSpend: 0,
                    monthLabel: monthLabel
                };
            }
            monthlyData[timeKey].totalSpend += spendAmount;
        }
    });

    // Sort by timeKey (e.g., 202401, 202402, etc.)
    const sortedTimeKeys = Object.keys(monthlyData).sort((a, b) => a - b);
    const labels = sortedTimeKeys.map(timeKey => monthlyData[timeKey].monthLabel);
    const data = sortedTimeKeys.map(timeKey => monthlyData[timeKey].totalSpend);

    const monthlySpendChartCanvas = document.getElementById('monthlySpendChartCanvas')?.getContext('2d');
    const noMonthlySpendDataEl = document.getElementById('noMonthlySpendData');

    if (noMonthlySpendDataEl) noMonthlySpendDataEl.style.display = (labels.length === 0) ? 'block' : 'none';
    
    // Check if the canvas context exists and hide/show its parent
    if (monthlySpendChartCanvas?.canvas.parentElement) {
        monthlySpendChartCanvas.canvas.parentElement.style.display = (labels.length > 0) ? 'block' : 'none';
    }

    if (labels.length === 0) {
        if (window.monthlySpendChartInstance) window.monthlySpendChartInstance.destroy();
        window.monthlySpendChartInstance = null;
        return;
    }

    if (window.monthlySpendChartInstance) window.monthlySpendChartInstance.destroy();
    
    // Create a new LINE chart instance (best for trends)
    window.monthlySpendChartInstance = new Chart(monthlySpendChartCanvas, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Total Spend (₹)',
                data: data,
                borderColor: 'rgba(255, 99, 132, 1)',
                backgroundColor: 'rgba(255, 99, 132, 0.2)', // Area under the line
                fill: true, // Fill the area
                tension: 0.2 // Smoothen the line
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: { display: true, text: 'Amount (₹)' },
                    ticks: { callback: value => formatCurrency(value) }
                },
                x: {
                    title: { display: true, text: 'Month' }
                },
            },
            plugins: {
                legend: { display: false },
                tooltip: { callbacks: { label: context => `${context.dataset.label}: ${formatCurrency(context.parsed.y)}` } }
            }
        }
    });
}

    // --- Data Management Functions (Main App) ---
    function exportData() { 
        if (!isAuthenticated) { alert("Please login to export data.");
        return; } 
        const dataToExport = { 
            accounts, 
            transactions, 
            investments, 
            spendCategories, 
            incomeCategories, 
            appVersion: `money_tracker_${APP_VERSION}_export_v1.9`, 
            exportDate: new Date().toISOString() 
        };
        const jsonData = JSON.stringify(dataToExport, null, 2); 
        const blob = new Blob([jsonData], { type: 'application/json' }); 
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); 
        a.href = url; 
        a.download = `money_tracker_data_${formatDate(new Date().toISOString().slice(0,10))}.json`; 
        document.body.appendChild(a); 
        a.click(); 
        document.body.removeChild(a); 
        URL.revokeObjectURL(url); 
        alert('Data exported successfully!');
    }
    function importData(event) { 
        if (!isAuthenticated) { alert("Please login to import data."); return;
        } 
        const file = event.target.files[0]; 
        if (!file) return; 
        if (file.type !== "application/json") { alert("Invalid file type."); return;
        } 
        const reader = new FileReader(); 
        reader.onload = function(e) { 
            try { 
                const importedData = JSON.parse(e.target.result);
                const isValidTransaction = (tr) => typeof tr.id === 'number' && typeof tr.type === 'string' && (typeof tr.amount === 'number' || typeof tr.amount_lent === 'number');
                const isValidInvestment = (inv) => typeof inv.id === 'number' && typeof inv.description === 'string' && typeof inv.amount === 'number';
                const isValidAccount = (acc) => typeof acc.id === 'string' && typeof acc.name === 'string' && typeof acc.status === 'string';
                const isValidCategoryArray = (arr) => Array.isArray(arr) && arr.every(item => typeof item === 'string');

                if (importedData && 
                    Array.isArray(importedData.transactions) && importedData.transactions.every(isValidTransaction) && 
                    Array.isArray(importedData.investments) && importedData.investments.every(isValidInvestment) && 
                    (!importedData.accounts || (Array.isArray(importedData.accounts) && importedData.accounts.every(isValidAccount))) &&
                    (!importedData.spendCategories || isValidCategoryArray(importedData.spendCategories)) &&
                    (!importedData.incomeCategories || isValidCategoryArray(importedData.incomeCategories))
                ) { 
                    if (confirm('This will merge imported data. New items added. Existing IDs/Names skipped. Continue?')) { 
                        let newTransactionsAdded = 0;
                        let skippedTransactions = 0; 
                        let newInvestmentsAdded = 0; 
                        let skippedInvestments = 0; 
                        let newAccountsAdded = 0; 
                        let skippedAccounts = 0;
                        let newSpendCategoriesAdded = 0;
                        let skippedSpendCategories = 0;
                        let newIncomeCategoriesAdded = 0;
                        let skippedIncomeCategories = 0;

                        if (importedData.accounts) { 
                            const existingAccountIds = new Set(accounts.map(acc => acc.id));
                            importedData.accounts.forEach(importedAcc => { 
                                if (!existingAccountIds.has(importedAcc.id)) { 
                                    accounts.push(importedAcc); newAccountsAdded++; 
                                } else { skippedAccounts++; } 
                            });
                        } 
                        const existingTransactionIds = new Set(transactions.map(t => t.id)); 
                        importedData.transactions.forEach(importedTx => { 
                            if (!existingTransactionIds.has(importedTx.id)) { 
                                const amount = importedTx.type === 'loan' ? (importedTx.amount_lent || 0) : (importedTx.amount || 0); 
                                transactions.push({...importedTx, amount: parseFloat(amount) }); newTransactionsAdded++; 
                            } else { skippedTransactions++; } 
                        });
                        const existingInvestmentIds = new Set(investments.map(inv => inv.id)); 
                        importedData.investments.forEach(importedInv => { 
                            if (!existingInvestmentIds.has(importedInv.id)) { 
                                investments.push({ ...importedInv, amount: parseFloat(importedInv.amount), currentValue: importedInv.currentValue ? parseFloat(importedInv.currentValue) : null, redeemedAmount: importedInv.redeemedAmount ? parseFloat(importedInv.redeemedAmount) : null, profitOrLoss: importedInv.profitOrLoss ? parseFloat(importedInv.profitOrLoss) : null, status: importedInv.status || 'active' }); newInvestmentsAdded++; 
                            } else { skippedInvestments++; } 
                        });

                        if (importedData.spendCategories) {
                            const existingSpendCatSet = new Set(spendCategories.map(c => c.toLowerCase()));
                            importedData.spendCategories.forEach(cat => {
                                if (typeof cat === 'string' && !existingSpendCatSet.has(cat.toLowerCase())) {
                                    spendCategories.push(cat);
                                    newSpendCategoriesAdded++;
                                } else {
                                    skippedSpendCategories++;
                                }
                            });
                        }
                        if (importedData.incomeCategories) {
                            const existingIncomeCatSet = new Set(incomeCategories.map(c => c.toLowerCase()));
                            importedData.incomeCategories.forEach(cat => {
                                if (typeof cat === 'string' && !existingIncomeCatSet.has(cat.toLowerCase())) {
                                    incomeCategories.push(cat);
                                    newIncomeCategoriesAdded++;
                                } else {
                                    skippedIncomeCategories++;
                                }
                            });
                        }
                        
                        saveAccounts(); saveTransactions(); saveInvestments(); 
                        saveSpendCategories(); saveIncomeCategories(); 
                        renderAllContent(); populateFilters(); populateSpendCategoryChips(); populateIncomeCategoryChips(); 
                        if (document.getElementById('settingsView').classList.contains('active')) {
                            renderCategoryManagementUI(); 
                        }
                        showView('homeView', 'Dashboard'); 
                        alert(`Data merged!\nAccounts: ${newAccountsAdded} new (Skipped: ${skippedAccounts})\nTransactions: ${newTransactionsAdded} new (Skipped: ${skippedTransactions})\nInvestments: ${newInvestmentsAdded} new (Skipped: ${skippedInvestments})\nSpend Cats: ${newSpendCategoriesAdded} new (Skipped: ${skippedSpendCategories})\nIncome Cats: ${newIncomeCategoriesAdded} new (Skipped: ${skippedIncomeCategories})`);
                    } 
                } else { 
                    alert('Invalid data structure in imported file.'); 
                } 
            } catch (error) { 
                console.error("Import Error:", error);
                alert('Error importing data.'); 
            } finally { 
                importFileEl.value = ''; 
            } 
        }; 
        reader.readAsText(file);
    }
    function handleResetData() { 
        if (!isAuthenticated) { alert("Please login to reset data."); return;
        } 
        if (confirm('ARE YOU SURE you want to reset all data? This cannot be undone.')) { 
            if (confirm('SECOND CONFIRMATION: All data will be permanently deleted. Proceed?')) { 
                transactions = [];
                investments = []; 
                accounts = [ { id: 'cash', name: 'Cash', status: 'active' }, { id: 'sbi', name: 'SBI', status: 'active'} ]; 
                
                spendCategories = [ 'Bills & Recharges', 'CC Bills', 'Cloths', 'Education', 'Entertainment', 'EMI', 'Foods & Drinks' ,'Fuel', 'Gifts', 'Groceries', 'Homes & Utilities', 'Health & Medicine', 'Insurance', 'Investment Expense', 'Labs & Tests', 'Maintenance', 'Travel', 'Shopping', 'Parties', 'Vacation', 'Personal Care', 'Rent', 'Subscriptions', 'Others' ]; 
                incomeCategories = ["Salary", "In-hand Cash", "Savings", "Earnings", "Investment Income", "Gifts Received", "Refunds", "Other Income"]; 

                saveTransactions(); saveInvestments(); saveAccounts(); 
                saveSpendCategories(); saveIncomeCategories(); 
                
                renderAllContent(); 
                populateFilters();
                populateSpendCategoryChips(); populateIncomeCategoryChips(); 
                if (document.getElementById('settingsView').classList.contains('active')) {
                     renderCategoryManagementUI(); 
                }
                alert('All application data has been reset.'); 
                showView('homeView', 'Dashboard'); 
            } 
        } 
    }
    
    // --- Category Chips & Transaction Form (Main App) ---
    function populateSpendCategoryChips(selectedCategory = null) { if (!isAuthenticated || !spendCategoryChipsContainerEl) return;
    spendCategoryChipsContainerEl.innerHTML = ''; spendCategories.sort().forEach(cat => { const chip = document.createElement('span'); chip.classList.add('category-chip'); chip.textContent = cat; chip.dataset.category = cat; if (cat === selectedCategory) chip.classList.add('active'); chip.addEventListener('click', () => { document.querySelectorAll('#spendCategoryChipsContainer .category-chip').forEach(c => c.classList.remove('active')); chip.classList.add('active'); selectedCategoryInputEl.value = cat; }); spendCategoryChipsContainerEl.appendChild(chip); });
    }
    function populateIncomeCategoryChips(selectedCategory = null) { if (!isAuthenticated || !incomeCategoryChipsContainerEl) return; incomeCategoryChipsContainerEl.innerHTML = '';
    incomeCategories.sort().forEach(cat => { const chip = document.createElement('span'); chip.classList.add('category-chip'); chip.textContent = cat; chip.dataset.category = cat; if (cat === selectedCategory) chip.classList.add('active'); chip.addEventListener('click', () => { document.querySelectorAll('#incomeCategoryChipsContainer .category-chip').forEach(c => c.classList.remove('active')); chip.classList.add('active'); selectedCategoryInputEl.value = cat; }); incomeCategoryChipsContainerEl.appendChild(chip); });
    }
    function updateTransactionFormFields(transactionType = null) { if (!isAuthenticated || !transactionTypeEl || !accountGroupEl || !transferGroupEls.length || !spendCategoryChipsGroupEl || !incomeCategoryChipsGroupEl || !transactionDescriptionLabelEl || !transactionAccountLabelEl || !transactionAmountLabelEl) return;
    const type = transactionType || transactionTypeEl.value; accountGroupEl.style.display = (type === 'income' || type === 'spend' || type === 'loan') ?
    'block' : 'none'; transferGroupEls.forEach(el => el.style.display = (type === 'transfer') ? 'block' : 'none'); spendCategoryChipsGroupEl.style.display = (type === 'spend') ?
    'block' : 'none'; incomeCategoryChipsGroupEl.style.display = (type === 'income') ? 'block' : 'none';
    if (type === 'loan') { transactionAccountLabelEl.textContent = "Lent From Account"; transactionAmountLabelEl.textContent = "Amount Lent (₹)";
    transactionDescriptionLabelEl.textContent = "Description (e.g., To Whom, Reason)"; spendCategoryChipsGroupEl.style.display = 'none'; incomeCategoryChipsGroupEl.style.display = 'none'; } else { transactionAccountLabelEl.textContent = "Account";
    transactionAmountLabelEl.textContent = "Amount (₹)"; transactionDescriptionLabelEl.textContent = (type === 'spend' || type === 'income') ? 'Notes / Specifics (Optional)' : 'Description';
    } selectedCategoryInputEl.value = ''; document.querySelectorAll('#spendCategoryChipsContainer .category-chip.active').forEach(c => c.classList.remove('active')); document.querySelectorAll('#incomeCategoryChipsContainer .category-chip.active').forEach(c => c.classList.remove('active')); if (type === 'spend') { populateSpendCategoryChips();
    } else if (type === 'income') { populateIncomeCategoryChips(); } }
    
    // --- Balance Calculations (Main App) ---
    function calculateAllBalances() { if (!isAuthenticated) return {};
    const accBalances = {}; const visibleAccountsForBalance = accounts.filter(acc => acc.status === 'active' || (acc.status === 'secret' && showSecretAccounts));
    visibleAccountsForBalance.forEach(acc => accBalances[acc.id] = 0); transactions.forEach(t => { if (t.type === 'income' && accBalances.hasOwnProperty(t.account)) { accBalances[t.account] = (accBalances[t.account] || 0) + t.amount; } else if (t.type === 'spend' && accBalances.hasOwnProperty(t.account)) { accBalances[t.account] = (accBalances[t.account] || 0) - t.amount; } else if (t.type === 'transfer') { if(accBalances.hasOwnProperty(t.fromAccount)) accBalances[t.fromAccount] = (accBalances[t.fromAccount] || 0) - t.amount; if(accBalances.hasOwnProperty(t.toAccount)) accBalances[t.toAccount] = (accBalances[t.toAccount] || 0) + t.amount; } else if (t.type === 'loan') { if (t.loanStatus === 'outstanding' && t.account && accBalances.hasOwnProperty(t.account)) { 
    accBalances[t.account] = (accBalances[t.account] || 0) - t.amount; 
} if (t.loanStatus === 'returned' && t.returnDetails && t.returnDetails.returnAccount && accBalances.hasOwnProperty(t.returnDetails.returnAccount) && t.returnDetails.returnAmount > 0) { accBalances[t.returnDetails.returnAccount] = (accBalances[t.returnDetails.returnAccount] ||
    0) + t.returnDetails.returnAmount; } } }); return accBalances; }
    function renderAccountBalances() { if (!isAuthenticated || !accountBalancesListEl || !totalBalanceEl) return;
    const balances = calculateAllBalances(); accountBalancesListEl.innerHTML = ''; let totalOverallBalance = 0;
    const visibleAccountsForDisplay = accounts.filter(acc => acc.status === 'active' || (acc.status === 'secret' && showSecretAccounts));
    if (visibleAccountsForDisplay.length === 0) { accountBalancesListEl.innerHTML = '<p class="text-muted text-center">No active accounts to display.</p>'; totalBalanceEl.textContent = formatCurrency(0); return;
    } visibleAccountsForDisplay.forEach(acc => { const balance = balances[acc.id] || 0; totalOverallBalance += balance; const item = document.createElement('div'); item.classList.add('account-balance-item'); const valueDisplay = balancesVisible ? formatCurrency(balance) : `<i class="fas fa-eye-slash"></i>`; item.innerHTML = `<span class="account-name">${getAccountNameById(acc.id)} ${acc.status === 'secret' ? '<i class="fas fa-user-secret text-warning" title="Secret Account"></i>' : ''}</span><span class="account-value ${!balancesVisible ? 'hidden-balance' : ''}">${valueDisplay}</span>`; accountBalancesListEl.appendChild(item); });
    totalBalanceEl.textContent = formatCurrency(totalOverallBalance); totalBalanceEl.style.color = totalOverallBalance < 0 ? '#dc3545' : 'white';
    }
    
    // --- Transaction Filtering (Main App) ---
    function populateFilters() { if (!isAuthenticated) return;
    if (txMonthFilterEl) { const currentMonth = txMonthFilterEl.value; txMonthFilterEl.innerHTML = '<option value="">All Months</option>';
    const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
    monthNames.forEach((month, index) => { const option = document.createElement('option'); option.value = index; option.textContent = month; if (String(index) === currentMonth) option.selected = true; txMonthFilterEl.appendChild(option); });
    } if (txYearFilterEl) { const currentYear = txYearFilterEl.value; const years = [...new Set(transactions.map(t => new Date(t.date).getFullYear()))].sort((a, b) => b - a);
    txYearFilterEl.innerHTML = '<option value="">All Years</option>'; years.forEach(year => { const option = document.createElement('option'); option.value = year; option.textContent = year; if (String(year) === currentYear) option.selected = true; txYearFilterEl.appendChild(option); });
    } }
    function filterAndSearchTransactions() { if (!isAuthenticated) return []; let filtered = [...transactions];
    const searchQuery = txSearchInputEl ? txSearchInputEl.value.toLowerCase().trim() : ""; const amountQueryVal = txAmountFilterEl ? txAmountFilterEl.value.trim() : "";
    const amountQuery = amountQueryVal ? parseFloat(amountQueryVal) : null; const selectedMonth = txMonthFilterEl ? txMonthFilterEl.value : "";
    const selectedYear = txYearFilterEl ? txYearFilterEl.value : ""; const selectedType = txTypeFilterEl ? txTypeFilterEl.value : "";
    if (searchQuery) { filtered = filtered.filter(t => (t.description && t.description.toLowerCase().includes(searchQuery)) || (t.category && t.category.toLowerCase().includes(searchQuery)) || (t.type === 'transfer' && (getAccountNameById(t.fromAccount)?.toLowerCase().includes(searchQuery) || getAccountNameById(t.toAccount)?.toLowerCase().includes(searchQuery))) || (t.type !== 'transfer' && t.type !== 'loan' && getAccountNameById(t.account)?.toLowerCase().includes(searchQuery)) || (t.type === 'loan' && getAccountNameById(t.account)?.toLowerCase().includes(searchQuery)) );
    } if (amountQuery !== null && !isNaN(amountQuery)) { filtered = filtered.filter(t => t.type === 'loan' ? (t.amount === amountQuery || (t.returnDetails && t.returnDetails.returnAmount === amountQuery)) : t.amount === amountQuery);
    } if (selectedYear) { filtered = filtered.filter(t => new Date(t.date).getFullYear() === parseInt(selectedYear));
    } if (selectedMonth) { filtered = filtered.filter(t => new Date(t.date).getMonth() === parseInt(selectedMonth));
    } if (selectedType) { if (selectedType === "investment_purchase") { filtered = filtered.filter(t => t.type === 'spend' && t.category === 'Investment Expense');
    } else if (selectedType === "investment_sale") { filtered = filtered.filter(t => t.type === 'income' && t.category === 'Investment Income');
    } else if (selectedType === "loan_outstanding") { filtered = filtered.filter(t => t.type === 'loan' && t.loanStatus === 'outstanding');
    } else if (selectedType === "loan_returned") { filtered = filtered.filter(t => t.type === 'loan' && t.loanStatus === 'returned');
    } else { filtered = filtered.filter(t => t.type === selectedType); } } return filtered.sort((a,b) => new Date(b.date) - new Date(a.date));
    }
    
    // --- List Rendering (Main App) ---
    function renderFullTransactionList() { if (!isAuthenticated || !transactionListEl) return;
    populateFilters(); const transactionsToRender = filterAndSearchTransactions(); transactionListEl.innerHTML = ''; let filteredIncome = 0; let filteredSpend = 0; let filteredTransfer = 0;
    transactionsToRender.forEach(t => { if (t.type === 'income') filteredIncome += t.amount; else if (t.type === 'spend') filteredSpend += t.amount; else if (t.type === 'transfer') filteredTransfer += t.amount; else if (t.type === 'loan') { filteredSpend += t.amount; if (t.loanStatus === 'returned' && t.returnDetails) { filteredIncome += t.returnDetails.returnAmount; } } });
    if (filteredTotalsContainerEl) { if (transactionsToRender.length > 0 && transactions.length > 0) { filteredTotalsContainerEl.innerHTML = ` <span class="filtered-total-item filtered-total-income">Income: ${formatCurrency(filteredIncome)}</span> <span class="filtered-total-item filtered-total-spend">Spend: ${formatCurrency(filteredSpend)}</span> <span class="filtered-total-item filtered-total-transfer">Transfers: ${formatCurrency(filteredTransfer)}</span> <span class="filtered-total-item filtered-total-net">Net (Income-Spend): ${formatCurrency(filteredIncome - filteredSpend)}</span> `;
    filteredTotalsContainerEl.style.display = 'flex'; } else { filteredTotalsContainerEl.style.display = 'none'; } } if (transactionsToRender.length === 0) { if (noTransactionsMessageEl) { noTransactionsMessageEl.textContent = transactions.length > 0 ?
    "No transactions match filters." : "No transactions yet."; noTransactionsMessageEl.style.display = 'block'; transactionListEl.appendChild(noTransactionsMessageEl);
    } } else { if (noTransactionsMessageEl) noTransactionsMessageEl.style.display = 'none'; transactionsToRender.forEach(t => { let iconClass = '', sign = '', accInfo = '', amountDisplay = formatCurrency(t.amount); let mainInfo = t.description || 'N/A'; let categoryDisplay = t.category ? `<span class="category-info">${t.category}</span>` : ''; let loanDetailsHtml = ''; let actionButtons = `<button class="btn btn-sm action-btn edit-btn" data-id="${t.id}" title="Edit"><i class="fas fa-edit"></i></button> <button class="btn btn-sm action-btn delete-btn" data-id="${t.id}" data-type="transaction" title="Delete"><i class="fas fa-trash-alt"></i></button>`; if (t.type === 'income') { iconClass = 'fa-arrow-down'; sign = '+'; accInfo = `To: ${getAccountNameById(t.account)}`; } else if (t.type === 'spend') { iconClass = 'fa-arrow-up'; sign = '-'; accInfo = `From: ${getAccountNameById(t.account)}`; } else 
    if (t.type === 'transfer') { iconClass = 'fa-exchange-alt'; accInfo = `From ${getAccountNameById(t.fromAccount)} to ${getAccountNameById(t.toAccount)}`; categoryDisplay = ''; } else if (t.type === 'loan') { iconClass = 'fa-hand-holding-usd';
    mainInfo = `Loan: ${t.description || 'N/A'}`; categoryDisplay = `<span class="status-badge status-loan-${t.loanStatus}">${t.loanStatus.charAt(0).toUpperCase() + t.loanStatus.slice(1)}</span>`; accInfo = `Lent: ${formatCurrency(t.amount)} from ${getAccountNameById(t.account)}`;
    amountDisplay = `-${formatCurrency(t.amount)}`; if (t.loanStatus === 'outstanding') { actionButtons += ` <button class="btn btn-sm action-btn record-return-btn" data-id="${t.id}" title="Record Return"><i class="fas fa-undo-alt"></i> Return</button>`;
    } else if (t.loanStatus === 'returned' && t.returnDetails) { loanDetailsHtml = `<div class="loan-details-info text-success">Returned: ${formatCurrency(t.returnDetails.returnAmount)} to ${getAccountNameById(t.returnDetails.returnAccount)} on ${displayDate(t.returnDetails.returnDate)}</div>`;
    amountDisplay = `(Lent: -${formatCurrency(t.amount)})<br><span class="text-success">Ret: +${formatCurrency(t.returnDetails.returnAmount)}</span>`; } } if (t.category && (t.type === 'income' || t.type === 'spend')) { mainInfo = `<span class="category-info">${t.category}</span>`;
    if(t.description) mainInfo += `<span class="description-info">(${t.description})</span>`; } else if (!t.category && t.description && (t.type === 'income' || t.type === 'spend')) { mainInfo = `<span class="main-info">${t.description}</span>`;
    } const item = document.createElement('li'); item.classList.add('list-group-item', `transaction-${t.type}`); item.innerHTML = ` <div class="list-item-icon"><i class="fas ${iconClass}"></i></div> <div class="list-item-details"> ${mainInfo} <div class="sub-info">${displayDate(t.date)}</div> <div class="account-info">${accInfo}</div> ${loanDetailsHtml} </div> <div class="list-item-amount-actions"> <span class="amount ${t.type === 'loan' && t.loanStatus === 'outstanding' ? 'lent' : ''}">${t.type === 'loan' ?
    amountDisplay : `${sign}${formatCurrency(t.amount)}`}</span> <div class="item-actions"> ${actionButtons} </div> </div>`; transactionListEl.appendChild(item); });
    } }
    function renderHomePageSummaries() { if (!isAuthenticated) return; if (recentTransactionsListHomeEl) { recentTransactionsListHomeEl.innerHTML = '';
    const recent = [...transactions].sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0,5);
    if(recent.length === 0) { recentTransactionsListHomeEl.innerHTML = '<li class="list-group-item text-center text-muted">No recent transactions.</li>';
    } else { recent.forEach(t => { let sign = ''; let amountStr = formatCurrency(t.amount); let colorClass = ''; let primaryInfo = t.description || 'N/A'; if (t.type === 'income') { sign = '+'; colorClass = 'text-success'; if(t.category) primaryInfo = t.category; } else if (t.type === 'spend') { sign = '-'; colorClass = 'text-danger'; if(t.category) primaryInfo = t.category; } else if (t.type === 'transfer') { colorClass = 'text-info'; primaryInfo = 'Transfer'; } else if (t.type === 'loan') { colorClass = 'text-warning'; primaryInfo = `Loan: ${t.description || 'N/A'}`; if (t.loanStatus === 'outstanding') { sign = '-'; } else if (t.loanStatus === 'returned' && 
    t.returnDetails) { primaryInfo = `Loan (Returned): ${t.description || 'N/A'}`; amountStr = `Lent: ${formatCurrency(t.amount)}, Ret: ${formatCurrency(t.returnDetails.returnAmount)}`; colorClass = 'text-success'; } } if(t.category && (t.type === 'income' || t.type === 'spend')) primaryInfo = t.category; if(t.description && (t.type === 'income' ||
    t.type === 'spend') && t.category) primaryInfo += ` (${t.description.substring(0,15)}...)`; else if (t.description && (t.type === 'income' || t.type === 'spend')) primaryInfo = t.description.substring(0,25) + (t.description.length > 25 ? '...' : '');
    const item = document.createElement('li'); item.classList.add('list-group-item'); item.innerHTML = `<div class="d-flex w-100 justify-content-between align-items-center"><div style="font-size:0.85rem;"><span style="font-weight:500;">${primaryInfo}</span><small class="d-block text-muted">${displayDate(t.date)}</small></div><small class="${colorClass}" style="font-weight:bold;">${sign}${amountStr}</small></div>`; recentTransactionsListHomeEl.appendChild(item); });
    } } if (investmentSummaryHomeEl) { const activeInvestments = investments.filter(inv => inv.status === 'active');
    if (activeInvestments.length === 0) { investmentSummaryHomeEl.innerHTML = '<p class="text-center text-muted">No active investments yet.</p>';
    } else { const totalInitialCostActive = activeInvestments.reduce((sum, inv) => sum + inv.amount, 0);
    const totalCurrentValueActive = activeInvestments.reduce((sum, inv) => sum + (inv.currentValue !== null && inv.currentValue !== undefined ? inv.currentValue : inv.amount), 0);
    investmentSummaryHomeEl.innerHTML = `<p class="text-center mb-1"><strong>Active Investments:</strong> ${activeInvestments.length}</p><p class="text-center mb-1"><strong>Initial Cost:</strong> ${formatCurrency(totalInitialCostActive)}</p><p class="text-center"><strong>Current Value:</strong> ${formatCurrency(totalCurrentValueActive)}</p>`;
    } } }
    function renderInvestmentList() { if (!isAuthenticated || !investmentListEl) return; investmentListEl.innerHTML = '';
    const sortedInvestments = [...investments].sort((a, b) => (a.status === 'active' && b.status !== 'active') ? -1 : (a.status !== 'active' && b.status === 'active') ? 1 : new Date(b.date) - new Date(a.date));
    if (sortedInvestments.length === 0) { if (noInvestmentsMessageEl) { noInvestmentsMessageEl.style.display = 'block'; investmentListEl.appendChild(noInvestmentsMessageEl); }} else { if (noInvestmentsMessageEl) noInvestmentsMessageEl.style.display = 'none';
    sortedInvestments.forEach(inv => { const item = document.createElement('li'); item.classList.add('list-group-item', 'investment-item'); if (inv.status === 'redeemed') item.classList.add('redeemed-investment'); let valueDisplay = `<span class="amount">${formatCurrency(inv.amount)}</span> <small>(Invested)</small>`; if (inv.status === 'active' && (inv.currentValue !== null && inv.currentValue !== undefined)) { valueDisplay += `<br><span class="amount ${inv.currentValue >= inv.amount ? 'text-success' : 'text-danger'}">${formatCurrency(inv.currentValue)}</span> <small class="current-value-label">(Current)</small>`; } else if (inv.status === 'redeemed') { valueDisplay = `<span class="amount text-muted">${formatCurrency(inv.amount)}</span> <small>(Invested)</small><br><span class="amount">${formatCurrency(inv.redeemedAmount || 0)}</span> <small>(Redeemed)</small>`; } let profitLossDisplay = (inv.status === 'redeemed' && (inv.profitOrLoss !== null && inv.profitOrLoss !== undefined)) ? `<div class="investment-details ${inv.profitOrLoss >= 0 ?
    'profit' : 'loss'}">P/L: ${formatCurrency(inv.profitOrLoss)}</div>` : ''; let actionButtonsHtml = (inv.status === 'active') ? `<div class="investment-item-actions"><button class="btn btn-info btn-sm update-value-btn" data-id="${inv.id}" title="Update Value"><i class="fas fa-edit"></i></button><button class="btn btn-success btn-sm redeem-btn" data-id="${inv.id}" title="Redeem"><i class="fas fa-hand-holding-usd"></i></button></div>` : ''; item.innerHTML = `<div class="list-item-content"><div class="main-info">${inv.description} <span class="status-badge status-${inv.status}">${inv.status.charAt(0).toUpperCase() + inv.status.slice(1)}</span></div><div class="sub-info">Type: ${investmentTypeNames[inv.type] || 'N/A'} | Invested: ${displayDate(inv.date)}</div>${inv.status === 'active' && inv.maturityInfo ? `<div class="investment-details">Maturity: ${inv.maturityInfo}</div>` : ''}${inv.status === 'redeemed' && inv.redemptionDate ? `<div class="investment-details">Redeemed: ${displayDate(inv.redemptionDate)}</div>` : ''}${profitLossDisplay}<div class="investment-details">From: ${getAccountNameById(inv.sourceAccount)}</div></div><div class="list-item-amount text-right">${valueDisplay}</div>${actionButtonsHtml}<button class="delete-btn btn btn-danger btn-sm" data-id="${inv.id}" data-type="investment" title="Delete" style="position: absolute;
    bottom: 5px; right: 5px;"><i class="fas fa-trash-alt"></i></button>`; investmentListEl.appendChild(item); }); } }
    
    // --- Master Render Function (Main App) ---
    function renderAllContent() { if (!isAuthenticated) return; renderAccountBalances(); renderHomePageSummaries(); if (document.getElementById('transactionsView').classList.contains('active')) { renderFullTransactionList(); } else { populateFilters(); } if (document.getElementById('investmentsView').classList.contains('active')) renderInvestmentList(); if(document.getElementById('chartsView').classList.contains('active')) { renderSpendCategoryChart(); renderIncomeSpendChart(); renderInvestmentPortfolioChart();
    renderMonthlySpendChart();
    } if(document.getElementById('settingsView').classList.contains('active')) {renderAccountManagementList(); renderCategoryManagementUI(); } }

    // --- Main App Initialization Function (called after auth) ---
    function initializeApp() {
        if (!isAuthenticated) { console.warn("Attempted to initialize app without authentication."); return; }
         
        loadAccounts(); 
        loadCategories(); 
        loadCategoryManagementVisibility();
        transactions = JSON.parse(localStorage.getItem(LOCAL_STORAGE_TRANSACTIONS_KEY)) || [];
        investments = JSON.parse(localStorage.getItem(LOCAL_STORAGE_INVESTMENTS_KEY)) || [];
        if (appVersionInfoEl) appVersionInfoEl.textContent = `RaGhaS Money Tracker - ${APP_VERSION}`;
        document.title = `RaGhaS Money Tracker - ${APP_VERSION}`;
        
        if (transactionDateEl) setDefaultDate(transactionDateEl);
        if (investmentDateEl) setDefaultDate(investmentDateEl);
        if (investmentRedemptionDateEl) setDefaultDate(investmentRedemptionDateEl);
        if (loanReturnDateInputEl) setDefaultDate(loanReturnDateInputEl); 
        
        populateSpendCategoryChips(); 
        populateIncomeCategoryChips(); 
        populateAllAccountDropdowns(); 
        
        updateTransactionFormFields('income'); 
        renderAccountManagementList(); 
        renderCategoryManagementUI(); 
        applyCategoryManagementVisibility();
        showView('homeView', 'Dashboard'); 
        renderAllContent();

        if (toggleCategoryManagementBtn) {
            toggleCategoryManagementBtn.addEventListener('click', () => {
                categoryManagementVisible = !categoryManagementVisible;
                applyCategoryManagementVisibility();
                saveCategoryManagementVisibility();
            });
        }

        if (toggleAccountManagementBtn) {
            toggleAccountManagementBtn.addEventListener('click', () => {
                accountManagementVisible = !accountManagementVisible;
                applyAccountManagementVisibility();
                saveAccountManagementVisibility();
            });
        }
        
        if (addSpendCategoryFormEl) {
            addSpendCategoryFormEl.addEventListener('submit', (e) => {
                e.preventDefault();
                const categoryName = newSpendCategoryNameEl.value.trim();
                if (categoryName && !spendCategories.find(c => c.toLowerCase() === categoryName.toLowerCase())) {
                    spendCategories.push(categoryName);
                    saveSpendCategories();
                    renderCategoryManagementUI();
                    populateSpendCategoryChips(); 
                    newSpendCategoryNameEl.value = '';
                } else if (categoryName) {
                    alert('Spend category already exists or is invalid.');
                }
            });
        }

        if (addIncomeCategoryFormEl) {
            addIncomeCategoryFormEl.addEventListener('submit', (e) => {
                e.preventDefault();
                const categoryName = newIncomeCategoryNameEl.value.trim();
                if (categoryName && !incomeCategories.find(c => c.toLowerCase() === categoryName.toLowerCase())) {
                    incomeCategories.push(categoryName);
                    saveIncomeCategories();
                    renderCategoryManagementUI();
                    populateIncomeCategoryChips(); 
                    newIncomeCategoryNameEl.value = '';
                } else if (categoryName) {
                    alert('Income category already exists or is invalid.');
                }
            });
        }

        if (spendCategoriesListContainerEl) {
            spendCategoriesListContainerEl.addEventListener('click', (e) => {
                if (e.target.closest('.remove-category-btn')) {
                    const btn = e.target.closest('.remove-category-btn');
                    const categoryToRemove = btn.dataset.category;
                    if (confirm(`Are you sure you want to remove the spend category "${categoryToRemove}"?`)) {
                        spendCategories = spendCategories.filter(cat => cat !== categoryToRemove);
                        saveSpendCategories();
                        renderCategoryManagementUI();
                        populateSpendCategoryChips(); 
                    }
                }
            });
        }
        
        if (incomeCategoriesListContainerEl) {
            incomeCategoriesListContainerEl.addEventListener('click', (e) => {
                if (e.target.closest('.remove-category-btn')) {
                    const btn = e.target.closest('.remove-category-btn');
                    const categoryToRemove = btn.dataset.category;
                    if (confirm(`Are you sure you want to remove the income category "${categoryToRemove}"?`)) {
                        incomeCategories = incomeCategories.filter(cat => cat !== categoryToRemove);
                        saveIncomeCategories();
                        renderCategoryManagementUI();
                        populateIncomeCategoryChips(); 
                    }
                }
            });
        }
        
        if (toggleBalanceVisibilityBtn) { toggleBalanceVisibilityBtn.addEventListener('click', () => { balancesVisible = !balancesVisible; toggleBalanceVisibilityBtn.innerHTML = balancesVisible ? '<i class="fas fa-eye"></i> Hide Amounts' : '<i class="fas fa-eye-slash"></i> Show Amounts'; renderAccountBalances(); });
        }
        if (transactionTypeEl) transactionTypeEl.addEventListener('change', () => updateTransactionFormFields());
        if (exportDataBtn) exportDataBtn.addEventListener('click', exportData);
        if (importDataTriggerBtn) importDataTriggerBtn.addEventListener('click', () => { lastFocusedElementBeforeModal = document.activeElement; importFileEl.click();});
        if (importFileEl) importFileEl.addEventListener('change', importData);
        if (resetDataBtn) resetDataBtn.addEventListener('click', handleResetData);
        if (fabOpenTransactionModal) { fabOpenTransactionModal.addEventListener('click', () => { lastFocusedElementBeforeModal = document.activeElement; editingTransactionIdEl.value = ''; transactionModalTitleEl.textContent = 'Add New Transaction'; transactionSubmitBtnEl.textContent = 'Add Transaction'; transactionSubmitBtnEl.classList.remove('btn-warning'); transactionSubmitBtnEl.classList.add('btn-primary'); transactionForm.reset(); selectedCategoryInputEl.value = ''; document.querySelectorAll('.category-chips-container .category-chip.active').forEach(c => c.classList.remove('active')); setDefaultDate(transactionDateEl); updateTransactionFormFields('income'); populateAllAccountDropdowns(); transactionModalJQ.modal('show'); });}
        if (transactionForm) { transactionForm.addEventListener('submit', (e) => { e.preventDefault(); const editingId = editingTransactionIdEl.value ? parseInt(editingTransactionIdEl.value) : null; const type = transactionTypeEl.value; const descriptionInputVal = document.getElementById('transactionDescription').value.trim();
        const amount = parseFloat(document.getElementById('transactionAmount').value); const date = transactionDateEl.value; const category = (type === 'income' || type === 'spend') ?
        selectedCategoryInputEl.value : null; const description = descriptionInputVal; let acc, fromAcc, toAcc, isValid = false;
        if (type === 'income' || type === 'spend') { acc = document.getElementById('transactionAccount').value; if (!acc) { alert('Select account.'); return;
        } if (!category && !description) { alert('For income/spend, select a category or provide notes.'); return;
        } if (amount > 0 && date ) isValid = true;
        } else if (type === 'transfer') { fromAcc = document.getElementById('transferFromAccount').value; toAcc = document.getElementById('transferToAccount').value;
        if (!fromAcc || !toAcc) { alert('Select From & To accounts.'); return;
        } if (fromAcc === toAcc) { alert('Accounts cannot be same.'); return;
        } if (description && amount > 0 && date) isValid = true;
        } else if (type === 'loan') { acc = document.getElementById('transactionAccount').value;
        if (!acc) { alert('Please select the account money is lent from.'); return;
        } if (!description) { alert('Please enter a description for the loan (e.g., to whom).'); return;
        } if (amount > 0 && date) isValid = true;
        } if (isValid) { const transactionData = { type, description, amount, date, account: acc };
        if (type === 'income' || type === 'spend') { transactionData.category = category;
        } else if (type === 'transfer') { transactionData.fromAccount = fromAcc; transactionData.toAccount = toAcc; delete transactionData.category; delete transactionData.account;
        } else if (type === 'loan') { transactionData.loanStatus = 'outstanding'; transactionData.returnDetails = null; delete transactionData.category;
        } if (editingId) { const index = transactions.findIndex(t => t.id === editingId);
        if (index > -1) { transactions[index] = { ...transactions[index], ...transactionData }; if(transactions[index].type !== 'loan' && transactions[index].loanStatus) { delete transactions[index].loanStatus;
        delete transactions[index].returnDetails; } } } else { transactionData.id = Date.now(); transactions.push(transactionData); } saveTransactions(); renderAllContent(); populateFilters(); transactionForm.reset(); editingTransactionIdEl.value = '';
        selectedCategoryInputEl.value = ''; document.querySelectorAll('.category-chips-container .category-chip.active').forEach(c => c.classList.remove('active')); setDefaultDate(transactionDateEl); updateTransactionFormFields('income'); transactionModalJQ.modal('hide'); } else { alert('Fill required fields correctly.');
        } });}
        document.querySelectorAll('.open-investment-modal').forEach(button => { button.addEventListener('click', function() { lastFocusedElementBeforeModal = document.activeElement; const type = this.dataset.type; if(investmentForm) investmentForm.reset(); if(investmentTypeSelect) investmentTypeSelect.value = type; setDefaultDate(investmentDateEl); populateAllAccountDropdowns(); document.getElementById('investmentId').value = ''; investmentModalJQ.modal('show'); });});
        if(investmentForm) { investmentForm.addEventListener('submit', function(e) { e.preventDefault(); const type = investmentTypeSelect.value; const description = document.getElementById('investmentDescription').value.trim(); const date = investmentDateEl.value; const amount = parseFloat(document.getElementById('investmentAmount').value); const maturityInfo = document.getElementById('investmentMaturity').value.trim(); const sourceAccount = investmentSourceAccountEl.value; if (!description || !date || isNaN(amount) || amount <= 0 || !sourceAccount) { alert('Fill required fields.'); return; } const newInvestment = { id: Date.now(), type, description, date, amount, maturityInfo, sourceAccount, status: 'active', currentValue: null, redeemedAmount: null, redemptionDate: null, profitOrLoss: null }; investments.push(newInvestment); saveInvestments(); const spendTransactionForInvestment = { id: Date.now() + 1, type: 'spend', category: 'Investment Expense', description: `Investment: ${description}`, amount: amount, date: date, account: sourceAccount };
        transactions.push(spendTransactionForInvestment); saveTransactions(); renderAllContent(); populateFilters(); investmentForm.reset(); setDefaultDate(investmentDateEl); populateAllAccountDropdowns(); investmentModalJQ.modal('hide'); });}
        if (updateInvestmentValueForm) { updateInvestmentValueForm.addEventListener('submit', function(e) { e.preventDefault(); const id = parseInt(updateValueInvestmentIdEl.value); const currentValue = parseFloat(investmentCurrentValueEl.value); const investmentIndex = investments.findIndex(inv => inv.id === id); if (investmentIndex > -1 && !isNaN(currentValue) && currentValue >= 0) { investments[investmentIndex].currentValue = currentValue; saveInvestments(); renderAllContent(); $('#updateInvestmentValueModal').modal('hide'); } else { alert('Invalid current value.'); } });}
        if (redeemInvestmentForm) { redeemInvestmentForm.addEventListener('submit', function(e) { e.preventDefault(); const id = parseInt(redeemInvestmentIdEl.value); const redeemedAmount = parseFloat(investmentRedeemedAmountEl.value); const redemptionDate = investmentRedemptionDateEl.value; const depositAccount = redemptionDepositAccountEl.value; const investmentIndex = investments.findIndex(inv => inv.id 
        === id); if (investmentIndex > -1 && !isNaN(redeemedAmount) && redeemedAmount > 0 && redemptionDate && depositAccount) { const investment = investments[investmentIndex];
        const profitLoss = redeemedAmount - investment.amount; investment.status = 'redeemed'; investment.redeemedAmount = redeemedAmount; investment.redemptionDate = redemptionDate; investment.profitOrLoss = profitLoss;
        investment.currentValue = null; const incomeTransaction = { id: Date.now(), type: 'income', description: `Redemption: ${investment.description} (P/L: ${formatCurrency(profitLoss)})`, amount: redeemedAmount, date: redemptionDate, account: depositAccount, category: 'Investment Income' };
        transactions.push(incomeTransaction); saveInvestments(); saveTransactions(); renderAllContent(); populateFilters(); $('#redeemInvestmentModal').modal('hide'); } else { alert('Fill all fields correctly.');
        } });}
        if(investmentRedeemedAmountEl) { investmentRedeemedAmountEl.addEventListener('input', function() { const investmentId = parseInt(redeemInvestmentIdEl.value); const investment = investments.find(inv => inv.id === investmentId); if (!investment) return; const redeemedAmountVal = parseFloat(this.value); if (!isNaN(redeemedAmountVal)) { const profitLoss = redeemedAmountVal - investment.amount; redeemProfitLossInfoEl.textContent = `Est. P/L: ${formatCurrency(profitLoss)}`; redeemProfitLossInfoEl.className = `profit-loss-info text-center mb-2 ${profitLoss >= 0 ? 'text-success' : 'text-danger'}`; } else { redeemProfitLossInfoEl.textContent = ''; } });}
        document.body.addEventListener('click', function(e) { const editButton = e.target.closest('.edit-btn'); if (editButton && editButton.dataset.type !== 'investment') { lastFocusedElementBeforeModal = document.activeElement; const transactionId = parseInt(editButton.dataset.id); const transactionToEdit = transactions.find(t => 
        t.id === transactionId); if (transactionToEdit) { editingTransactionIdEl.value = transactionToEdit.id; transactionModalTitleEl.textContent = 'Edit Transaction'; transactionSubmitBtnEl.textContent = 'Update Transaction'; transactionSubmitBtnEl.classList.remove('btn-primary'); transactionSubmitBtnEl.classList.add('btn-warning');
        transactionTypeEl.value = transactionToEdit.type; updateTransactionFormFields(transactionToEdit.type); document.getElementById('transactionDescription').value = transactionToEdit.description || ''; document.getElementById('transactionAmount').value = transactionToEdit.amount; document.getElementById('transactionDate').value = formatDate(transactionToEdit.date); selectedCategoryInputEl.value = transactionToEdit.category || '';
        if (transactionToEdit.type === 'spend') { populateSpendCategoryChips(transactionToEdit.category); populateAccountDropdown(document.getElementById('transactionAccount'), transactionToEdit.account); } else if (transactionToEdit.type === 'income') { populateIncomeCategoryChips(transactionToEdit.category); populateAccountDropdown(document.getElementById('transactionAccount'), transactionToEdit.account);
        } else if (transactionToEdit.type === 'transfer') { populateAccountDropdown(document.getElementById('transferFromAccount'), transactionToEdit.fromAccount); populateAccountDropdown(document.getElementById('transferToAccount'), transactionToEdit.toAccount); } else if (transactionToEdit.type === 'loan') { populateAccountDropdown(document.getElementById('transactionAccount'), transactionToEdit.account);
        } transactionModalJQ.modal('show'); } } const deleteButton = e.target.closest('.delete-btn'); if (deleteButton) { const id = parseInt(deleteButton.dataset.id); const type = deleteButton.dataset.type;
        if (type === 'transaction') { if (confirm('Delete transaction?')) { transactions = transactions.filter(t => t.id !== id); saveTransactions(); renderAllContent();
        populateFilters();}} else if (type === 'investment') { const investmentToDelete = investments.find(inv => inv.id === id);
        let confirmMessage = 'Delete investment record?'; if (investmentToDelete && investmentToDelete.status === 'redeemed') { confirmMessage += '\nAssociated income transaction NOT reversed.';} if (confirm(confirmMessage)) { investments = investments.filter(inv => inv.id !== id);
        saveInvestments(); renderAllContent(); }}} const updateBtn = e.target.closest('.update-value-btn'); if (updateBtn) { lastFocusedElementBeforeModal = document.activeElement; const investmentId = parseInt(updateBtn.dataset.id);
        const investment = investments.find(inv => inv.id === investmentId); if (!investment) return; updateValueInvestmentIdEl.value = investment.id; updateValueInvestmentNameEl.textContent = investment.description;
        investmentCurrentValueEl.value = investment.currentValue !== null && investment.currentValue !== undefined ? investment.currentValue.toFixed(2) : ''; $('#updateInvestmentValueModal').modal('show'); } const redeemBtn = e.target.closest('.redeem-btn');
        if (redeemBtn) { lastFocusedElementBeforeModal = document.activeElement; const investmentId = parseInt(redeemBtn.dataset.id); const investment = investments.find(inv => inv.id === investmentId);
        if (!investment) return; redeemInvestmentIdEl.value = investment.id; redeemInvestmentNameEl.textContent = investment.description; redeemInvestmentInitialCostEl.textContent = formatCurrency(investment.amount); investmentRedeemedAmountEl.value = ''; setDefaultDate(investmentRedemptionDateEl); populateAllAccountDropdowns(); redeemProfitLossInfoEl.textContent = '';
        $('#redeemInvestmentModal').modal('show'); } const recordReturnBtn = e.target.closest('.record-return-btn'); if (recordReturnBtn) { lastFocusedElementBeforeModal = document.activeElement; const loanId = parseInt(recordReturnBtn.dataset.id);
        const loanToReturn = transactions.find(t => t.id === loanId && t.type === 'loan'); if (loanToReturn) { originalLoanIdToReturnEl.value = loanId;
        loanReturnDescriptionEl.textContent = loanToReturn.description; originalLoanAmountDisplayEl.textContent = formatCurrency(loanToReturn.amount); loanReturnAmountInputEl.value = loanToReturn.amount.toFixed(2); setDefaultDate(loanReturnDateInputEl); populateAllAccountDropdowns(); $('#recordLoanReturnModal').modal('show'); } }});
        if (txSearchInputEl) txSearchInputEl.addEventListener('input', renderFullTransactionList);
        if (txAmountFilterEl) txAmountFilterEl.addEventListener('input', renderFullTransactionList);
        if (txMonthFilterEl) txMonthFilterEl.addEventListener('change', renderFullTransactionList);
        if (txYearFilterEl) txYearFilterEl.addEventListener('change', renderFullTransactionList);
        if (txTypeFilterEl) txTypeFilterEl.addEventListener('change', renderFullTransactionList);
        if (txClearFiltersBtnEl) { txClearFiltersBtnEl.addEventListener('click', () => { if(txSearchInputEl) txSearchInputEl.value = ''; if(txAmountFilterEl) txAmountFilterEl.value = ''; if(txMonthFilterEl) txMonthFilterEl.value = ''; if(txYearFilterEl) txYearFilterEl.value = ''; if(txTypeFilterEl) txTypeFilterEl.value = ''; renderFullTransactionList(); });}
        navItems.forEach(item => { item.addEventListener('click', () => { showView(item.dataset.view, item.dataset.title); }); });
        $('.modal').on('shown.bs.modal', function () { $(this).find('input[type!="hidden"]:first, select:first, textarea:first, button:first').first().trigger('focus'); });
        $('#transactionModal, #investmentModal, #updateInvestmentValueModal, #redeemInvestmentModal, #recordLoanReturnModal, #pinSetupModal, #pinLoginModal, #forgotPinModal, #resetPinModal').on('hidden.bs.modal', function () { if (lastFocusedElementBeforeModal) { try { lastFocusedElementBeforeModal.focus(); } catch(e) { /* Element might no longer be focusable or exist */ } lastFocusedElementBeforeModal = null; } });
        $('#transactionModal').on('hidden.bs.modal', function () { transactionForm.reset(); editingTransactionIdEl.value = ''; selectedCategoryInputEl.value = ''; document.querySelectorAll('.category-chips-container .category-chip.active').forEach(c => c.classList.remove('active')); setDefaultDate(transactionDateEl); updateTransactionFormFields('income'); populateAllAccountDropdowns(); });
        $('#investmentModal').on('hidden.bs.modal', function () { if(investmentForm) investmentForm.reset(); setDefaultDate(investmentDateEl); if(investmentTypeSelect) investmentTypeSelect.value = "stock"; populateAllAccountDropdowns(); });
        $('#updateInvestmentValueModal').on('hidden.bs.modal', function () { if(updateInvestmentValueForm) updateInvestmentValueForm.reset(); });
        $('#redeemInvestmentModal').on('hidden.bs.modal', function () { if(redeemInvestmentForm) redeemInvestmentForm.reset(); if(redeemProfitLossInfoEl) redeemProfitLossInfoEl.textContent = ''; populateAllAccountDropdowns(); });
        $('#recordLoanReturnModal').on('hidden.bs.modal', function () { if(recordLoanReturnFormEl) recordLoanReturnFormEl.reset(); });
    }
    
    // --- PIN System Logic (Functions defined before use) ---
    function getPinData() { const data = localStorage.getItem(PIN_DATA_KEY);
    return data ? JSON.parse(data) : null; }
    async function savePinSettings(pin, hint, questionIndex, answer) { const hashedPin = await hashData(pin);
    const hashedAnswer = await hashData(answer.toLowerCase()); const pinData = { hashedPin, hint, questionIndex, hashedAnswer }; localStorage.setItem(PIN_DATA_KEY, JSON.stringify(pinData));
    }
    function populateSecurityQuestions() { if (!securityQuestionSelectEl) return; securityQuestionSelectEl.innerHTML = '<option value="">-- Select a Question --</option>';
    SECURITY_QUESTIONS.forEach((q, index) => { const option = document.createElement('option'); option.value = index; option.textContent = q; securityQuestionSelectEl.appendChild(option); });
    }
    function showApp() { loginScreenEl.style.display = 'none'; $('#pinSetupModal').modal('hide'); $('#pinLoginModal').modal('hide'); $('#forgotPinModal').modal('hide'); $('#resetPinModal').modal('hide'); appContainerEl.style.display = 'block'; isAuthenticated = true;
    initializeApp(); }
    function showLoginScreen() { loginScreenEl.style.display = 'flex'; appContainerEl.style.display = 'none'; isAuthenticated = false;
    const pinData = getPinData(); if (pinData) { $('#pinLoginModal').modal('show'); } else { populateSecurityQuestions(); $('#pinSetupModal').modal('show');
    } }

    // --- Record Loan Return Form Handler ---
    if (recordLoanReturnFormEl) {
        recordLoanReturnFormEl.addEventListener('submit', (e) => {
            e.preventDefault();
            const loanId = parseInt(originalLoanIdToReturnEl.value);
            const returnDate = loanReturnDateInputEl.value;
            const returnAmount = parseFloat(loanReturnAmountInputEl.value);
            const returnAccount
            = loanReturnAccountSelectEl.value;

            if (!loanId || !returnDate || isNaN(returnAmount) || returnAmount <= 0 || !returnAccount) {
                alert('Please fill all fields for the loan return correctly.');
                return;
            }

            const loanIndex = transactions.findIndex(t => t.id === loanId && t.type ===
            'loan');
            if (loanIndex > -1) {
                transactions[loanIndex].loanStatus = 'returned';
                transactions[loanIndex].returnDetails = { returnDate, returnAmount, returnAccount };
                saveTransactions();
                renderAllContent();
                $('#recordLoanReturnModal').modal('hide');
            } else {
                alert('Error finding the original loan transaction.');
            }
        });
    }

    // --- Account Management Event Listeners (Settings Page) ---
    if (addAccountFormEl) {
        addAccountFormEl.addEventListener('submit', (e) => {
            e.preventDefault();
            const name = newAccountNameEl.value.trim();
            const id = newAccountIdEl.value.trim().toLowerCase().replace(/\s+/g, '_'); 

            if (!name || !id) { alert('Please provide both account name and a short ID.'); return; }
            if (accounts.some(acc => acc.id === id)) { alert('Account ID already exists. Please choose a unique ID.'); return; }
            if (!/^[a-z0-9_]+$/.test(id)) { alert('Account ID can only contain lowercase letters, numbers, and underscores.'); return; }


            accounts.push({ id, name, status: 'active' }); 
            saveAccounts();
      
            renderAccountManagementList();
            populateAllAccountDropdowns(); 
            renderAccountBalances(); 
            addAccountFormEl.reset();
        });
    }

    if (accountsListContainerEl) {
        accountsListContainerEl.addEventListener('click', (e) => {
            const target = e.target.closest('button');
            if (!target) return;

            const accountId = target.dataset.id;
            const account = accounts.find(acc => acc.id === accountId);
            if (!account) return;

      
            if (target.classList.contains('toggle-account-status-btn')) {
                if (account.status === 'active' || account.status === 'secret') {
                    account.status = 'inactive';
                } else if (account.status === 'inactive') {
                    account.status = 'active'; 
 
                }
            } else if (target.classList.contains('toggle-account-secret-btn')) {
                 if (account.status === 'secret') {
                    account.status = 'active'; 
                } else {
       
                     account.status = 'secret'; 
                }
            }
            saveAccounts();
            renderAccountManagementList();
            populateAllAccountDropdowns();
            renderAccountBalances();
            if(document.getElementById('transactionsView').classList.contains('active')) renderFullTransactionList(); 
        });
    }
    

    if (showSecretAccountsToggleSettingsEl) {
        showSecretAccountsToggleSettingsEl.addEventListener('change', (e) => {
            showSecretAccounts = e.target.checked;
            localStorage.setItem('showSecretAccounts', JSON.stringify(showSecretAccounts)); 
            if(toggleShowSecretAccountsHomeBtn) {
                toggleShowSecretAccountsHomeBtn.innerHTML = showSecretAccounts ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
      
                   toggleShowSecretAccountsHomeBtn.title = showSecretAccounts ? "Hide Secret Accounts" : "Show Secret Accounts";
            }
            populateAllAccountDropdowns();
            renderAccountBalances();
            if(document.getElementById('transactionsView').classList.contains('active')) renderFullTransactionList(); 
        });
    }
    if (toggleShowSecretAccountsHomeBtn) {
         toggleShowSecretAccountsHomeBtn.innerHTML = showSecretAccounts ?
        '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
         toggleShowSecretAccountsHomeBtn.title = showSecretAccounts ? "Hide Secret Accounts" : "Show Secret Accounts";
        toggleShowSecretAccountsHomeBtn.addEventListener('click', () => {
            showSecretAccounts = !showSecretAccounts;
            localStorage.setItem('showSecretAccounts', JSON.stringify(showSecretAccounts)); 
            toggleShowSecretAccountsHomeBtn.innerHTML = showSecretAccounts ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
            toggleShowSecretAccountsHomeBtn.title = showSecretAccounts ? "Hide Secret Accounts" : "Show Secret Accounts";
            if(showSecretAccountsToggleSettingsEl) showSecretAccountsToggleSettingsEl.checked = showSecretAccounts; 

         
            populateAllAccountDropdowns();
            renderAccountBalances();
            if(document.getElementById('transactionsView').classList.contains('active')) renderFullTransactionList(); 
        });
    }


    // --- PIN System Event Listeners and Initialization ---
    if (pinSetupForm) { pinSetupForm.addEventListener('submit', async (e) => { e.preventDefault(); const newPin = newPinEl.value; const confirmPin = confirmNewPinEl.value; const hint = pinHintEl.value.trim(); const questionIndex = securityQuestionSelectEl.value; const answer = securityAnswerEl.value.trim(); if (newPin.length !== 6 || !/^\d+$/.test(newPin)) { alert('PIN must be 6 digits.'); return; } if (newPin !== confirmPin) { alert('PINs do not match.'); return; } if (questionIndex === "") { alert('Please select a security question.'); return; } if (!answer) { alert('Please provide an answer to the security question.'); return; } try { await savePinSettings(newPin, hint,
    questionIndex, answer); alert('PIN and security settings saved successfully! Please login.'); $('#pinSetupModal').modal('hide'); showLoginScreen(); } catch (error) { console.error("Error saving PIN:", error); alert('Error saving PIN settings. Please try again.');
    } }); }
    if (pinLoginForm) { pinLoginForm.addEventListener('submit', async (e) => { e.preventDefault(); const enteredPin = loginPinEl.value; const pinData = getPinData(); if (!pinData) { alert('No PIN set up. Please refresh.'); return; } const hashedEnteredPin = await hashData(enteredPin); if (hashedEnteredPin === pinData.hashedPin) { loginPinEl.value = ''; loginPinHintEl.style.display = 'none'; loginPinHintEl.textContent = ''; showApp(); } else { alert('Invalid PIN. Please try again.'); loginPinEl.value = ''; } });
    }
    if (showPinHintBtn) { showPinHintBtn.addEventListener('click', () => { const pinData = getPinData(); if (pinData && pinData.hint) { loginPinHintEl.textContent = `Hint: ${pinData.hint}`; loginPinHintEl.style.display = 'block'; } else if (pinData) { loginPinHintEl.textContent = 'No hint was set.'; loginPinHintEl.style.display = 'block'; } });
    }
    if (forgotPinBtn) { forgotPinBtn.addEventListener('click', () => { const pinData = getPinData(); if (!pinData || pinData.questionIndex === undefined) { alert('Security question not set up.'); return; } displayedSecurityQuestionEl.textContent = SECURITY_QUESTIONS[parseInt(pinData.questionIndex)]; answerToSecurityQuestionEl.value = ''; $('#pinLoginModal').modal('hide'); $('#forgotPinModal').modal('show'); });
    }
    if(closeForgotPinModalBtn) { closeForgotPinModalBtn.addEventListener('click', () => { $('#forgotPinModal').modal('hide'); $('#pinLoginModal').modal('show'); });
    }
    if (securityQuestionForm) { securityQuestionForm.addEventListener('submit', async (e) => { e.preventDefault(); const enteredAnswer = answerToSecurityQuestionEl.value.trim(); const pinData = getPinData(); if (!pinData) { alert('Error retrieving security data.'); return; } const hashedEnteredAnswer = await hashData(enteredAnswer.toLowerCase()); if (hashedEnteredAnswer === pinData.hashedAnswer) { $('#forgotPinModal').modal('hide'); $('#resetPinModal').modal('show'); } else { alert('Incorrect answer.'); answerToSecurityQuestionEl.value = ''; } });
    }
    if (resetPinForm) { resetPinForm.addEventListener('submit', async (e) => { e.preventDefault(); const newPin = newPinForResetEl.value; const confirmPin = confirmNewPinForResetEl.value; if (newPin.length !== 6 || !/^\d+$/.test(newPin)) { alert('New PIN must be 6 digits.'); return; } if (newPin !== confirmPin) { alert('New PINs do not match.'); return; } try { const currentPinData = getPinData(); if (!currentPinData) { alert("Error: Could not retrieve existing PIN data for reset."); return; } const updatedPinData = { ...currentPinData, hashedPin: await hashData(newPin) }; localStorage.setItem(PIN_DATA_KEY, JSON.stringify(updatedPinData)); alert('PIN has been reset successfully! Please login with your new PIN.'); $('#resetPinModal').modal('hide'); showLoginScreen(); } catch (error) { console.error("Error resetting PIN:", error);
    alert('Error resetting PIN.'); } }); }
    
    // Auth Modals cleanup
    $('#pinSetupModal').on('hidden.bs.modal', function () { if(pinSetupForm) pinSetupForm.reset(); if(lastFocusedElementBeforeModal) { try {lastFocusedElementBeforeModal.focus();} catch(e){} lastFocusedElementBeforeModal=null;} });
    $('#pinLoginModal').on('hidden.bs.modal', function () { if(pinLoginForm) pinLoginForm.reset(); loginPinHintEl.style.display = 'none'; loginPinHintEl.textContent = ''; if(lastFocusedElementBeforeModal) { try {lastFocusedElementBeforeModal.focus();} catch(e){} lastFocusedElementBeforeModal=null;}});
    $('#forgotPinModal').on('hidden.bs.modal', function () { if(securityQuestionForm) securityQuestionForm.reset(); if(lastFocusedElementBeforeModal) { try {lastFocusedElementBeforeModal.focus();} catch(e){} lastFocusedElementBeforeModal=null;}});
    $('#resetPinModal').on('hidden.bs.modal', function () { if(resetPinForm) resetPinForm.reset(); if(lastFocusedElementBeforeModal) { try {lastFocusedElementBeforeModal.focus();} catch(e){} lastFocusedElementBeforeModal=null; }});
    // --- Initial Auth Check & App Launch ---
    showLoginScreen(); 

});
</script>
</body>
</html>
