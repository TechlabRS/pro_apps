<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Gen Nxt StoreBilling System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body {
            background-color: #f8f9fa;
        }
        .navbar {
            background-color: #007bff; /* Primary blue */
        }
        .navbar-brand, .main-nav .nav-link { /* Adjusted to include .main-nav */
            color: #ffffff !important;
        }
        .navbar-nav .nav-link.active,
        .navbar-nav .nav-link:hover {
            color: #e2e6ea !important;
        }
        /* New styles for reports modal tabs */
        #reportsModal .nav-tabs .nav-link {
            color: #343a40; /* Darker text for visibility on white background */
            background-color: #f8f9fa; /* Slightly off-white for distinction */
            border-color: #dee2e6 #dee2e6 #fff; /* Standard Bootstrap tab borders */
        }
        #reportsModal .nav-tabs .nav-link.active {
            color: #007bff; /* Blue for the active tab */
            background-color: #ffffff; /* White background for active tab */
            border-color: #dee2e6 #dee2e6 #fff;
        }
        #reportsModal .nav-tabs .nav-link:hover {
            border-color: #e9ecef #e9ecef #dee2e6; /* Hover border */
        }
        .card-header {
            background-color: #e9ecef;
        }
        .form-control:focus {
            box-shadow: 0 0 0 0.25rem rgba(0, 123, 255, 0.25);
        }
        .list-group-item-action:hover {
            background-color: #f1f1f1;
        }
        .bill-item-qty, .bill-item-price {
            max-width: 80px;
            text-align: center;
            padding: .25rem;
        }
        .receipt-modal .modal-content {
            background-color: #fff;
            border-radius: 0;
        }
        .receipt-content {
            font-family: 'Courier New', Courier, monospace;
            font-size: 14px;
            padding: 10px;
        }
        .receipt-content .header, .receipt-content .footer {
            text-align: center;
            margin-bottom: 10px;
        }
        .receipt-content .item-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .receipt-content .item-table th, .receipt-content .item-table td {
            border-bottom: 1px dashed #ccc;
            padding: 5px 0;
            text-align: left;
        }
        .receipt-content .item-table th:nth-child(2), .receipt-content .item-table td:nth-child(2) { text-align: center; }
        .receipt-content .item-table th:nth-child(3), .receipt-content .item-table td:nth-child(3) { text-align: right; }
        .receipt-content .item-table th:nth-child(4), .receipt-content .item-table td:nth-child(4) { text-align: right; }
        .receipt-content .total-section {
            text-align: right;
            margin-top: 10px;
        }
        .receipt-content .total-section div {
            margin-bottom: 5px;
        }
        .receipt-content .thank-you {
            text-align: center;
            margin-top: 20px;
            font-style: italic;
        }
        .report-content {
            max-height: 500px; /* Adjust as needed */
            overflow-y: auto;
            border: 1px solid #e9ecef;
            padding: 15px;
            border-radius: .25rem;
            background-color: #fff;
        }
        /* Make btn-close white for dark backgrounds */
        .btn-close-white {
            filter: invert(1) grayscale(100%) brightness(200%);
        }
        /* Ensure modal titles are visible on primary background */
        .modal-header .modal-title {
            color: #ffffff;
        }
        /* New styles for WhatsApp button */
        .btn-whatsapp {
            background-color: #25D366;
            color: white;
            border-color: #25D366;
        }
        .btn-whatsapp:hover {
            background-color: #1DA851;
            color: white;
            border-color: #1DA851;
        }
        /* Style for chips (product variants, categories) */
        .product-variant-chip, .category-chip, .product-item-chip { /* Added product-item-chip */
            display: inline-block;
            padding: .5rem 1rem;
            margin: .25rem;
            border: 1px solid #007bff;
            border-radius: 20px;
            background-color: #e0f2ff;
            color: #007bff;
            cursor: pointer;
            font-size: .85rem;
            transition: all 0.2s ease-in-out;
        }
        .product-variant-chip:hover, .category-chip:hover, .product-item-chip:hover { /* Added product-item-chip */
            background-color: #007bff;
            color: #fff;
            box-shadow: 0 2px 4px rgba(0, 123, 255, 0.2);
        }
        .product-variant-chip.selected, .category-chip.selected, .product-item-chip.selected { /* Added product-item-chip */
            background-color: #007bff;
            color: #fff;
            border-color: #007bff;
            box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Smart Gen Nxt Store</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0 main-nav"> <!-- Added main-nav class here -->
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="#">Billing</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#productManagementModal">Manage Products</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#customerManagementModal">Manage Customers</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#reportsModal">Reports</a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="logoutBtn">Logout</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-md-4">
                <div class="card shadow-sm mb-4">
                    <div class="card-header">
                        <h5>Customer Details</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="customerSearch" class="form-label">Search Customer</label>
                            <input type="text" class="form-control" id="customerSearch" placeholder="Name or Phone">
                            <div id="customerList" class="list-group mt-2">
                                </div>
                        </div>
                        <div class="mb-3">
                            <strong>Selected Customer:</strong>
                            <span id="selectedCustomerDisplay" class="badge bg-secondary ms-2 p-2">No customer selected</span>
                            <button class="btn btn-outline-danger btn-sm ms-2" id="clearCustomerBtn">Clear</button>
                        </div>
                        <!-- New: Display for customer's total due amount -->
                        <div class="mb-3">
                            <strong>Total Due:</strong>
                            <span id="customerTotalDueDisplay" class="badge bg-danger ms-2 p-2">₹ 0.00</span>
                        </div>
                        <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addCustomerModal">Add New Customer</button>
                        <hr>
                        <h6>Customer's Past Bills:</h6>
                        <div id="customerBillHistory" class="p-2 border rounded" style="max-height: 250px; overflow-y: auto;">
                            <p class="text-muted text-center">Select a customer to view their past bills.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-8">
                <div class="card shadow-sm mb-4">
                    <div class="card-header">
                        <h5>Add Products to Bill</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-12">
                                <label for="productSearch" class="form-label">Search Product</label>
                                <input type="text" class="form-control" id="productSearch" placeholder="Product Name">
                                <!-- Changed productList to be a flex container for chips directly -->
                                <div id="productList" class="mt-2 d-flex flex-wrap gap-2">
                                    <!-- Product chips will be here -->
                                </div>
                                <!-- New: Display selected product name here, replacing the search list -->
                                <div id="selectedProductBillingDisplay" class="mt-2 p-2 border rounded bg-light d-none">
                                    <strong>Selected Product:</strong> <span id="selectedProductNameDisplay"></span>
                                    <button class="btn btn-sm btn-outline-secondary ms-2" id="clearProductSelectionBtn">Change</button>
                                </div>
                            </div>
                            <!-- New section for product variants (chips) -->
                            <div class="col-md-12 mt-2">
                                <div id="productVariantsContainer" class="d-flex flex-wrap gap-2">
                                    <!-- Product chips will be rendered here -->
                                </div>
                                <small id="variantSelectionHint" class="text-muted mt-2 d-none">Select a variant above before adding to bill.</small>
                            </div>
                            <div class="col-md-3 mt-3">
                                <label for="productQuantity" class="form-label">Quantity (Multiples of selected variant)</label>
                                <input type="number" class="form-control" id="productQuantity" value="1" min="1" disabled>
                            </div>
                            <div class="col-md-3 d-flex align-items-end mt-3">
                                <button class="btn btn-success w-100" id="addProductToBillBtn" disabled>Add to Bill</button>
                            </div>
                        </div>

                        <h5 class="mt-4">Current Bill</h5>
                        <div class="table-responsive">
                            <table class="table table-bordered table-striped mt-3">
                                <thead>
                                    <tr>
                                        <th>Item</th>
                                        <th>Quantity</th>
                                        <th>Price (per unit)</th>
                                        <th>Total</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="billItemsTableBody">
                                    <tr><td colspan="5" class="text-muted text-center">No items in the bill.</td></tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="d-flex justify-content-end mt-3">
                            <h4>Total: <span id="billTotal">₹ 0.00</span></h4>
                        </div>
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-3">
                            <button class="btn btn-warning" id="clearBillBtn">Clear Bill</button>
                        </div>
                    </div>
                </div>

                <div class="card shadow-sm">
                    <div class="card-header">
                        <h5>Payment Details</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="paymentAmount" class="form-label">Amount Received (₹)</label>
                            <input type="number" class="form-control" id="paymentAmount" value="0.00" step="0.01" min="0">
                            <div class="invalid-feedback">
                                Payment received is less than total amount.
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <strong>Amount Due:</strong> <span id="amountDue" class="text-danger">₹ 0.00</span>
                            </div>
                            <div class="col-md-6 text-md-end">
                                <strong>Change:</strong> <span id="changeAmount" class="text-success">₹ 0.00</span>
                            </div>
                        </div>
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" id="generateBillBtn">Generate & Print Bill</button>
                            <button class="btn btn-secondary" id="saveBillBtn">Save Bill (No Print)</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addCustomerModal" tabindex="-1" aria-labelledby="addCustomerModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="addCustomerModalLabel">Add New Customer</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="addCustomerForm">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="customerName" class="form-label">Name</label>
                            <input type="text" class="form-control" id="customerName" required>
                        </div>
                        <div class="mb-3">
                            <label for="customerPhone" class="form-label">Phone</label>
                            <input type="tel" class="form-control" id="customerPhone" pattern="[0-9]{10}" placeholder="e.g., 9876543210" required>
                            <small class="form-text text-muted">10-digit phone number</small>
                        </div>
                        <div class="mb-3">
                            <label for="customerAddress" class="form-label">Address (Optional)</label>
                            <textarea class="form-control" id="customerAddress" rows="2"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Add Customer</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="billReceiptModal" tabindex="-1" aria-labelledby="billReceiptModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content receipt-modal">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="billReceiptModalLabel">Bill Receipt</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="receiptContent" class="receipt-content">
                        </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="printReceiptBtn">Print</button>
                    <button type="button" class="btn btn-whatsapp" id="sendBillViaWhatsAppBtn"><i class="fab fa-whatsapp"></i> Send via WhatsApp</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="productManagementModal" tabindex="-1" aria-labelledby="productManagementModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="productManagementModalLabel">Manage Products</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <button class="btn btn-success mb-3" data-bs-toggle="modal" data-bs-target="#addProductModal">Add New Product</button>
                    <div id="productListManagement" class="list-group">
                        </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addProductModal" tabindex="-1" aria-labelledby="addProductModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="addProductModalLabel">Add New Product</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="addProductFormManagement">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="productNameManagement" class="form-label">Product Name</label>
                            <input type="text" class="form-control" id="productNameManagement" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Category</label>
                            <div id="addProductCategoryChips" class="d-flex flex-wrap gap-2">
                                <!-- Category chips will be dynamically loaded here -->
                            </div>
                        </div>
                        <hr>
                        <h6>Default Variant Details (First Variant)</h6>
                        <div class="mb-3">
                            <label for="productVariantDisplayNameManagement" class="form-label">Variant Display Name (e.g., Rice (1kg))</label>
                            <input type="text" class="form-control" id="productVariantDisplayNameManagement" required>
                        </div>
                        <div class="mb-3">
                            <label for="productVariantUnitManagement" class="form-label">Unit (e.g., kg, L, pc)</label>
                            <input type="text" class="form-control" id="productVariantUnitManagement" placeholder="e.g., kg, L, pc" required>
                        </div>
                        <div class="mb-3">
                            <label for="productVariantQuantityManagement" class="form-label">Quantity (e.g., 1, 0.5, 5)</label>
                            <input type="number" class="form-control" id="productVariantQuantityManagement" step="0.01" min="0.01" value="1" required>
                        </div>
                        <div class="mb-3">
                            <label for="productPriceManagement" class="form-label">Price (₹)</label>
                            <input type="number" class="form-control" id="productPriceManagement" step="0.01" min="0.01" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-success">Add Product</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editProductModal" tabindex="-1" aria-labelledby="editProductModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="editProductModalLabel">Edit Product</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="editProductForm">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="editProductName" class="form-label">Product Name</label>
                            <input type="text" class="form-control" id="editProductName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Category</label>
                            <div id="editProductCategoryChips" class="d-flex flex-wrap gap-2">
                                <!-- Category chips will be dynamically loaded here -->
                            </div>
                        </div>
                        <hr>
                        <h6>Product Variants</h6>
                        <div id="editProductVariantsContainer" class="d-flex flex-wrap gap-2 mb-3">
                            <!-- Variants will be rendered here as chips -->
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-success me-2" id="addEditProductVariantBtn">Add/Edit Variant</button>
                        <button type="button" class="btn btn-sm btn-outline-danger" id="deleteProductVariantBtn">Delete Selected Variant</button>
                        <small id="noVariantSelectedHint" class="text-muted ms-2 d-none">Select a variant chip to edit or delete.</small>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Save Product Details</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addEditVariantModal" tabindex="-1" aria-labelledby="addEditVariantModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="addEditVariantModalLabel">Add/Edit Product Variant</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="addEditVariantForm">
                    <div class="modal-body">
                        <input type="hidden" id="currentEditingVariantProductId">
                        <input type="hidden" id="currentEditingVariantId">
                        <div class="mb-3">
                            <label for="variantDisplayName" class="form-label">Variant Display Name (e.g., Rice (1kg))</label>
                            <input type="text" class="form-control" id="variantDisplayName" required>
                        </div>
                        <div class="mb-3">
                            <label for="variantUnit" class="form-label">Unit (e.g., kg, L, pc)</label>
                            <input type="text" class="form-control" id="variantUnit" placeholder="e.g., kg, L, pc" required>
                        </div>
                        <div class="mb-3">
                            <label for="variantQuantity" class="form-label">Quantity (e.g., 1, 0.5, 5)</label>
                            <input type="number" class="form-control" id="variantQuantity" step="0.01" min="0.01" value="1" required>
                        </div>
                        <div class="mb-3">
                            <label for="variantPrice" class="form-label">Price (₹)</label>
                            <input type="number" class="form-control" id="variantPrice" step="0.01" min="0.01" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-success" id="saveVariantBtn">Save Variant</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="customerManagementModal" tabindex="-1" aria-labelledby="customerManagementModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="customerManagementModalLabel">Manage Customers</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <button class="btn btn-success mb-3" data-bs-toggle="modal" data-bs-target="#addCustomerModal">Add New Customer</button>
                    <div id="customerListManagement" class="list-group">
                        </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editCustomerModal" tabindex="-1" aria-labelledby="editCustomerModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="editCustomerModalLabel">Edit Customer</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="editCustomerForm">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="editCustomerName" class="form-label">Name</label>
                            <input type="text" class="form-control" id="editCustomerName" required>
                        </div>
                        <div class="mb-3">
                            <label for="editCustomerPhone" class="form-label">Phone</label>
                            <input type="tel" class="form-control" id="editCustomerPhone" pattern="[0-9]{10}" placeholder="e.g., 9876543210" required>
                        </div>
                        <div class="mb-3">
                            <label for="editCustomerAddress" class="form-label">Address (Optional)</label>
                            <textarea class="form-control" id="editCustomerAddress" rows="2"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="reportsModal" tabindex="-1" aria-labelledby="reportsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="reportsModalLabel">Sales Reports</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs mb-3" id="reportsTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="daily-sales-tab" data-bs-toggle="tab" data-bs-target="#daily-sales" type="button" role="tab" aria-controls="daily-sales" aria-selected="true">Daily/Date Range Sales</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="product-sales-tab" data-bs-toggle="tab" data-bs-target="#product-sales" type="button" role="tab" aria-controls="product-sales" aria-selected="false">Product Sales</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="customer-history-tab" data-bs-toggle="tab" data-bs-target="#customer-history" type="button" role="tab" aria-controls="customer-history" aria-selected="false">Customer History</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="price-chart-tab" data-bs-toggle="tab" data-bs-target="#price-chart" type="button" role="tab" aria-controls="price-chart" aria-selected="false">Price Chart</button>
                        </li>
                    </ul>
                    <div class="tab-content" id="reportsTabContent">
                        <div class="tab-pane fade show active" id="daily-sales" role="tabpanel" aria-labelledby="daily-sales-tab">
                            <h6 class="mb-3">Daily/Date Range Sales Report</h6>
                            <div class="row g-3 mb-3">
                                <div class="col-md-4">
                                    <label for="startDate" class="form-label">Start Date:</label>
                                    <input type="date" class="form-control" id="startDate">
                                </div>
                                <div class="col-md-4">
                                    <label for="endDate" class="form-label">End Date:</label>
                                    <input type="date" class="form-control" id="endDate">
                                </div>
                                <div class="col-md-4 d-flex align-items-end justify-content-between">
                                    <button class="btn btn-primary w-50 me-2" id="generateDailySalesReportBtn">Generate Report</button>
                                    <button class="btn btn-whatsapp w-50" id="sendDailyReportViaWhatsAppBtn"><i class="fab fa-whatsapp"></i> Send Report</button>
                                </div>
                            </div>
                            <div id="dailySalesReportContent" class="report-content">
                                <p class="text-muted text-center">Select a date range and click "Generate Report".</p>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="product-sales" role="tabpanel" aria-labelledby="product-sales-tab">
                            <h6 class="mb-3">Product Sales Report</h6>
                            <div class="row g-3 mb-3">
                                <div class="col-md-6">
                                    <label for="productSalesReportStartDate" class="form-label">Start Date (Optional):</label>
                                    <input type="date" class="form-control" id="productSalesReportStartDate">
                                </div>
                                <div class="col-md-6">
                                    <label for="productSalesReportEndDate" class="form-label">End Date (Optional):</label>
                                    <input type="date" class="form-control" id="productSalesReportEndDate">
                                </div>
                                <div class="col-12 mt-3 d-flex justify-content-end">
                                    <button class="btn btn-primary me-2" id="generateProductSalesReportBtn">Generate Report</button>
                                    <button class="btn btn-whatsapp" id="sendProductReportViaWhatsAppBtn"><i class="fab fa-whatsapp"></i> Send Report</button>
                                </div>
                            </div>
                            <div id="productSalesReportContent" class="report-content">
                                <p class="text-muted text-center">Click "Generate Report" to see all product sales, or select a date range.</p>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="customer-history" role="tabpanel" aria-labelledby="customer-history-tab">
                            <h6 class="mb-3">Customer Purchase History Report</h6>
                            <div class="row g-3 mb-3">
                                <div class="col-md-6">
                                    <label for="customerHistoryStartDate" class="form-label">Start Date (Optional):</label>
                                    <input type="date" class="form-control" id="customerHistoryStartDate">
                                </div>
                                <div class="col-md-6">
                                    <label for="customerHistoryEndDate" class="form-label">End Date (Optional):</label>
                                    <input type="date" class="form-control" id="customerHistoryEndDate">
                                </div>
                                <div class="col-12 mt-3 d-flex justify-content-end">
                                    <button class="btn btn-primary me-2" id="generateCustomerHistoryReportBtn">Generate Report</button>
                                    <button class="btn btn-whatsapp" id="sendCustomerHistoryReportViaWhatsAppBtn"><i class="fab fa-whatsapp"></i> Send Report</button>
                                </div>
                            </div>
                            <div id="customerHistoryReportContent" class="report-content">
                                <p class="text-muted text-center">Click "Generate Report" to see all customer purchase summaries, or select a date range.</p>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="price-chart" role="tabpanel" aria-labelledby="price-chart-tab">
                            <h6 class="mb-3">Product Price History Chart</h6>
                            <div class="row g-3 mb-3">
                                <div class="col-md-6">
                                    <label for="chartProductSelect" class="form-label">Select Product:</label>
                                    <select class="form-select" id="chartProductSelect">
                                        <option value="">Select a Product</option>
                                        <!-- Products will be loaded here -->
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="chartVariantSelect" class="form-label">Select Variant:</label>
                                    <select class="form-select" id="chartVariantSelect" disabled>
                                        <option value="">Select a Variant</option>
                                        <!-- Variants will be loaded here -->
                                    </select>
                                </div>
                            </div>
                            <div class="report-content" style="height: 350px;">
                                <canvas id="priceChartCanvas"></canvas>
                                <p id="priceChartMessage" class="text-muted text-center mt-3">Select a product and variant to view its price history.</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- PSEUDO-AUTHENTICATION CHECK ---
    const AUTH_TOKEN_KEY = 'kiranaAuthToken';
    const requiredToken = 'superSecretDemoToken123';

    if (localStorage.getItem(AUTH_TOKEN_KEY) !== requiredToken) {
        window.location.href = 'login.html';
        return;
    }
    // --- END PSEUDO-AUTHENTICATION CHECK ---


    // --- Data Storage Utility Functions ---
    const saveCustomers = (data) => localStorage.setItem('kiranaCustomers', JSON.stringify(data));
    const saveProducts = (data) => localStorage.setItem('kiranaProducts', JSON.stringify(data));
    const saveCustomerBills = (data) => localStorage.setItem('kiranaCustomerBills', JSON.stringify(data));
    const saveNextBillId = (id) => localStorage.setItem('kiranaNextBillId', JSON.stringify(id));

    // --- Data Initialization (Dynamic) ---

    // Initialize Customers: Check localStorage first. If empty, load defaults and save them.
    let customers = JSON.parse(localStorage.getItem('kiranaCustomers'));
    if (!customers || customers.length === 0) {
        customers = [
            { id: 'C001', name: 'John Doe', phone: '9876543210', address: '123 Main St' },
            { id: 'C002', name: 'Jane Smith', phone: '8765432109', address: '456 Oak Ave' },
            { id: 'C003', name: 'Alice Johnson', phone: '7654321098', address: '789 Pine Ln' }
        ];
        saveCustomers(customers); // Save defaults to localStorage for the very first run
    }

    // Predefined product categories
    const productCategories = [
        'Grains & Pulses',
        'Oils & Ghee',
        'Spices & Masalas',
        'Snacks & Biscuits',
        'Beverages',
        'Dairy & Eggs',
        'Bakery',
        'Frozen Foods',
        'Personal Care',
        'Home Care',
        'Sweets & Chocolates',
        'Others'
    ];

    // Initialize Products: Check localStorage first. If empty, load defaults and save them.
    // Also, ensure each product has a 'variants' array and each variant has a priceHistory for robustness.
    let products = JSON.parse(localStorage.getItem('kiranaProducts'));
    if (!products || products.length === 0) {
        products = [
            {
                id: 'P001', name: 'Rice', category: 'Grains & Pulses',
                variants: [
                    { variantId: 'P001V1', displayName: 'Rice (1kg)', unit: 'kg', quantity: 1, price: 60.00, priceHistory: [{ date: new Date().toISOString(), price: 60.00 }] },
                    { variantId: 'P001V2', displayName: 'Rice (5kg)', unit: 'kg', quantity: 5, price: 280.00, priceHistory: [{ date: new Date().toISOString(), price: 280.00 }] },
                    { variantId: 'P001V3', displayName: 'Rice (10kg)', unit: 'kg', quantity: 10, price: 550.00, priceHistory: [{ date: new Date().toISOString(), price: 550.00 }] }
                ]
            },
            {
                id: 'P002', name: 'Wheat Flour', category: 'Grains & Pulses',
                variants: [
                    { variantId: 'P002V1', displayName: 'Wheat Flour (1kg)', unit: 'kg', quantity: 1, price: 40.00, priceHistory: [{ date: new Date().toISOString(), price: 40.00 }] },
                    { variantId: 'P002V2', displayName: 'Wheat Flour (5kg)', unit: 'kg', quantity: 5, price: 180.00, priceHistory: [{ date: new Date().toISOString(), price: 180.00 }] }
                ]
            },
            {
                id: 'P003', name: 'Sugar', category: 'Spices & Masalas',
                variants: [
                    { variantId: 'P003V1', displayName: 'Sugar (500g)', unit: 'kg', quantity: 0.5, price: 25.00, priceHistory: [{ date: new Date().toISOString(), price: 25.00 }] },
                    { variantId: 'P003V2', displayName: 'Sugar (1kg)', unit: 'kg', quantity: 1, price: 45.00, priceHistory: [{ date: new Date().toISOString(), price: 45.00 }] }
                ]
            },
            {
                id: 'P004', name: 'Toor Dal', category: 'Grains & Pulses',
                variants: [
                    { variantId: 'P004V1', displayName: 'Toor Dal (500g)', unit: 'kg', quantity: 0.5, price: 75.00, priceHistory: [{ date: new Date().toISOString(), price: 75.00 }] },
                    { variantId: 'P004V2', displayName: 'Toor Dal (1kg)', unit: 'kg', quantity: 1, price: 140.00, priceHistory: [{ date: new Date().toISOString(), price: 140.00 }] }
                ]
            },
            {
                id: 'P005', name: 'Cooking Oil', category: 'Oils & Ghee',
                variants: [
                    { variantId: 'P005V1', displayName: 'Cooking Oil (500ml)', unit: 'L', quantity: 0.5, price: 75.00, priceHistory: [{ date: new Date().toISOString(), price: 75.00 }] },
                    { variantId: 'P005V2', displayName: 'Cooking Oil (1L)', unit: 'L', quantity: 1, price: 150.00, priceHistory: [{ date: new Date().toISOString(), price: 150.00 }] },
                    { variantId: 'P005V3', displayName: 'Cooking Oil (2L)', unit: 'L', quantity: 2, price: 290.00, priceHistory: [{ date: new Date().toISOString(), price: 290.00 }] }
                ]
            },
            {
                id: 'P006', name: 'Salt', category: 'Spices & Masalas',
                variants: [
                    { variantId: 'P006V1', displayName: 'Salt (1kg)', unit: 'kg', quantity: 1, price: 20.00, priceHistory: [{ date: new Date().toISOString(), price: 20.00 }] }
                ]
            },
            {
                id: 'P007', name: 'Tea Powder', category: 'Beverages',
                variants: [
                    { variantId: 'P007V1', displayName: 'Tea Powder (100g)', unit: 'kg', quantity: 0.1, price: 50.00, priceHistory: [{ date: new Date().toISOString(), price: 50.00 }] },
                    { variantId: 'P007V2', displayName: 'Tea Powder (250g)', unit: 'kg', quantity: 0.25, price: 120.00, priceHistory: [{ date: new Date().toISOString(), price: 120.00 }] }
                ]
            },
            {
                id: 'P008', name: 'Coffee', category: 'Beverages',
                variants: [
                    { variantId: 'P008V1', displayName: 'Coffee (50g)', unit: 'kg', quantity: 0.05, price: 50.00, priceHistory: [{ date: new Date().toISOString(), price: 50.00 }] },
                    { variantId: 'P008V2', displayName: 'Coffee (100g)', unit: 'kg', quantity: 0.1, price: 90.00, priceHistory: [{ date: new Date().toISOString(), price: 90.00 }] }
                ]
            },
            {
                id: 'P009', name: 'Milk', category: 'Dairy & Eggs',
                variants: [
                    { variantId: 'P009V1', displayName: 'Milk (500ml)', unit: 'L', quantity: 0.5, price: 30.00, priceHistory: [{ date: new Date().toISOString(), price: 30.00 }] },
                    { variantId: 'P009V2', displayName: 'Milk (1L)', unit: 'L', quantity: 1, price: 60.00, priceHistory: [{ date: new Date().toISOString(), price: 60.00 }] }
                ]
            },
            {
                id: 'P010', name: 'Eggs', category: 'Dairy & Eggs',
                variants: [
                    { variantId: 'P010V1', displayName: 'Eggs (6 pcs)', unit: 'pc', quantity: 6, price: 40.00, priceHistory: [{ date: new Date().toISOString(), price: 40.00 }] },
                    { variantId: 'P010V2', displayName: 'Eggs (12 pcs)', unit: 'pc', quantity: 12, price: 70.00, priceHistory: [{ date: new Date().toISOString(), price: 70.00 }] }
                ]
            }
        ];
        saveProducts(products); // Save defaults to localStorage for the very first run
    } else {
        // Ensure all loaded products have a 'variants' array and each variant has a priceHistory array
        products = products.map(product => {
            if (!product.variants || !Array.isArray(product.variants)) {
                product.variants = [];
            }
            product.variants = product.variants.map(variant => {
                if (!variant.priceHistory || !Array.isArray(variant.priceHistory)) {
                    variant.priceHistory = [{ date: new Date().toISOString(), price: variant.price }];
                }
                return variant;
            });
            return product;
        });
        saveProducts(products); // Save corrected structure back if any changes were made
    }


    

    let currentBill = [];
    let selectedCustomer = null;

    let nextCustomerId = customers.length > 0 ? Math.max(...customers.map(c => parseInt(c.id.replace('C', '')))) + 1 : 1;
    let nextProductId = products.length > 0 ? Math.max(...products.map(p => parseInt(p.id.replace('P', '')))) + 1 : 1;
    let nextBillId = JSON.parse(localStorage.getItem('kiranaNextBillId')) || 1001;

    let customerBills = JSON.parse(localStorage.getItem('kiranaCustomerBills')) || {};

    // Track currently selected main product and its variant for adding to bill
    let selectedProductForAdding = null; // The main product object (e.g., Rice)
    let selectedVariantForAdding = null; // The specific variant object (e.g., Rice (1kg))

    // Track currently selected category and variant for product management modals
    let currentSelectedCategoryForManagement = null;
    let currentSelectedVariantForManagement = null;


    // --- Global variables for WhatsApp integration ---
    let lastGeneratedBill = null;
    let lastGeneratedDailyReport = '';
    let lastGeneratedProductReport = '';
    let lastGeneratedCustomerHistoryReport = '';


    // --- DOM Elements ---
    const customerSearchInput = document.getElementById('customerSearch');
    const customerListDiv = document.getElementById('customerList');
    const selectedCustomerDisplay = document.getElementById('selectedCustomerDisplay');
    const clearCustomerBtn = document.getElementById('clearCustomerBtn');
    const customerBillHistoryDiv = document.getElementById('customerBillHistory');
    const customerTotalDueDisplay = document.getElementById('customerTotalDueDisplay'); // New element

    const productSearchInput = document.getElementById('productSearch');
    const productListDiv = document.getElementById('productList'); // Now a flex container for product-item-chips
    // New: Element to display selected product and clear button
    const selectedProductBillingDisplay = document.getElementById('selectedProductBillingDisplay');
    const selectedProductNameDisplay = document.getElementById('selectedProductNameDisplay');
    const clearProductSelectionBtn = document.getElementById('clearProductSelectionBtn');

    // Container for displaying product variant chips
    const productVariantsContainer = document.getElementById('productVariantsContainer');
    const variantSelectionHint = document.getElementById('variantSelectionHint');


    const productQuantityInput = document.getElementById('productQuantity');
    const addProductToBillBtn = document.getElementById('addProductToBillBtn');
    const billItemsTableBody = document.getElementById('billItemsTableBody');
    const billTotalSpan = document.getElementById('billTotal');
    const clearBillBtn = document.getElementById('clearBillBtn');

    const paymentAmountInput = document.getElementById('paymentAmount');
    const amountDueSpan = document.getElementById('amountDue');
    const changeAmountSpan = document.getElementById('changeAmount');
    const generateBillBtn = document.getElementById('generateBillBtn');
    const saveBillBtn = document.getElementById('saveBillBtn');

    const billReceiptModal = new bootstrap.Modal(document.getElementById('billReceiptModal'));
    const receiptContentDiv = document.getElementById('receiptContent');
    const printReceiptBtn = document.getElementById('printReceiptBtn');
    const sendBillViaWhatsAppBtn = document.getElementById('sendBillViaWhatsAppBtn'); // New WhatsApp button

    const productManagementModal = new bootstrap.Modal(document.getElementById('productManagementModal'));
    const customerManagementModal = new bootstrap.Modal(document.getElementById('customerManagementModal'));
    const addProductModal = new bootstrap.Modal(document.getElementById('addProductModal'));
    const addCustomerModal = new bootstrap.Modal(document.getElementById('addCustomerModal'));
    const editProductModal = new bootstrap.Modal(document.getElementById('editProductModal'));
    const addEditVariantModal = new bootstrap.Modal(document.getElementById('addEditVariantModal')); // New variant modal
    const editCustomerModal = new bootstrap.Modal(document.getElementById('editCustomerModal'));

    const addCustomerForm = document.getElementById('addCustomerForm');
    const customerNameInput = document.getElementById('customerName');
    const customerPhoneInput = document.getElementById('customerPhone');
    const customerAddressInput = document.getElementById('customerAddress');

    const productListManagementDiv = document.getElementById('productListManagement');

    const addProductFormManagement = document.getElementById('addProductFormManagement');
    const productNameInputManagement = document.getElementById('productNameManagement');
    const addProductCategoryChips = document.getElementById('addProductCategoryChips'); // Changed to div for chips
    const productVariantDisplayNameManagement = document.getElementById('productVariantDisplayNameManagement');
    const productVariantUnitManagement = document.getElementById('productVariantUnitManagement');
    const productVariantQuantityManagement = document.getElementById('productVariantQuantityManagement');
    const productPriceManagement = document.getElementById('productPriceManagement');


    const customerListManagementDiv = document.getElementById('customerListManagement');

    const editProductNameInput = document.getElementById('editProductName');
    const editProductCategoryChips = document.getElementById('editProductCategoryChips'); // Changed to div for chips
    const editProductVariantsContainer = document.getElementById('editProductVariantsContainer'); // New container for variants
    const addEditProductVariantBtn = document.getElementById('addEditProductVariantBtn'); // New button
    const deleteProductVariantBtn = document.getElementById('deleteProductVariantBtn'); // New button
    const noVariantSelectedHint = document.getElementById('noVariantSelectedHint'); // New hint
    const editProductForm = document.getElementById('editProductForm');
    let currentEditProductId = null; // This will now refer to the main product ID

    const addEditVariantForm = document.getElementById('addEditVariantForm'); // New variant form
    const addEditVariantModalLabel = document.getElementById('addEditVariantModalLabel'); // New variant modal label
    const variantDisplayNameInput = document.getElementById('variantDisplayName');
    const variantUnitInput = document.getElementById('variantUnit');
    const variantQuantityInput = document.getElementById('variantQuantity');
    const variantPriceInput = document.getElementById('variantPrice');
    const currentEditingVariantProductId = document.getElementById('currentEditingVariantProductId'); // Hidden input
    const currentEditingVariantId = document.getElementById('currentEditingVariantId'); // Hidden input
    const saveVariantBtn = document.getElementById('saveVariantBtn');


    const editCustomerNameInput = document.getElementById('editCustomerName');
    const editCustomerPhoneInput = document.getElementById('editCustomerPhone');
    const editCustomerAddressInput = document.getElementById('editCustomerAddress');
    const editCustomerForm = document.getElementById('editCustomerForm');
    let currentEditCustomerId = null;

    const logoutBtn = document.getElementById('logoutBtn');

    // Reports Modal Elements
    const reportsModal = new bootstrap.Modal(document.getElementById('reportsModal'));
    const startDateInput = document.getElementById('startDate');
    const endDateInput = document.getElementById('endDate');
    const generateDailySalesReportBtn = document.getElementById('generateDailySalesReportBtn');
    const dailySalesReportContent = document.getElementById('dailySalesReportContent');
    const sendDailyReportViaWhatsAppBtn = document.getElementById('sendDailyReportViaWhatsAppBtn'); // New WhatsApp button

    const productSalesReportStartDate = document.getElementById('productSalesReportStartDate');
    const productSalesReportEndDate = document.getElementById('productSalesReportEndDate');
    const generateProductSalesReportBtn = document.getElementById('generateProductSalesReportBtn');
    const productSalesReportContent = document.getElementById('productSalesReportContent');
    const sendProductReportViaWhatsAppBtn = document.getElementById('sendProductReportViaWhatsAppBtn'); // New WhatsApp button

    const customerHistoryStartDate = document.getElementById('customerHistoryStartDate');
    const customerHistoryEndDate = document.getElementById('customerHistoryEndDate');
    const generateCustomerHistoryReportBtn = document.getElementById('generateCustomerHistoryReportBtn');
    const customerHistoryReportContent = document.getElementById('customerHistoryReportContent');
    const sendCustomerHistoryReportViaWhatsAppBtn = document.getElementById('sendCustomerHistoryReportViaWhatsAppBtn'); // New WhatsApp button

    // Price Chart Elements
    const chartProductSelect = document.getElementById('chartProductSelect');
    const chartVariantSelect = document.getElementById('chartVariantSelect');
    const priceChartCanvas = document.getElementById('priceChartCanvas');
    const priceChartMessage = document.getElementById('priceChartMessage');
    let priceChart = null; // Chart.js instance


    // --- Utility Functions ---
    const formatCurrency = (amount) => `₹ ${amount.toFixed(2)}`;

    /**
     * Masks a phone number to show only the last 4 digits.
     * @param {string} phoneNumber - The full phone number.
     * @returns {string} The masked phone number.
     */
    const maskPhoneNumber = (phoneNumber) => {
        if (!phoneNumber || phoneNumber.length < 4) {
            return phoneNumber; // Return as is if too short to mask
        }
        return 'X'.repeat(phoneNumber.length - 4) + phoneNumber.slice(-4);
    };

    // Function to render category chips for add/edit product modals
    const renderCategoryChips = (containerElement, selectedCategory) => {
        containerElement.innerHTML = ''; // Clear existing chips
        currentSelectedCategoryForManagement = selectedCategory; // Set the initially selected category

        productCategories.forEach(category => {
            const chip = document.createElement('button');
            chip.type = 'button';
            chip.classList.add('category-chip');
            chip.textContent = category;
            chip.dataset.category = category;

            if (currentSelectedCategoryForManagement === category) {
                chip.classList.add('selected');
            }

            chip.addEventListener('click', () => {
                // Remove 'selected' from all chips in this container
                containerElement.querySelectorAll('.category-chip').forEach(c => c.classList.remove('selected'));
                chip.classList.add('selected');
                currentSelectedCategoryForManagement = category;
            });
            containerElement.appendChild(chip);
        });
    };

    // --- WhatsApp Integration Functions ---

    /**
     * Sends a message via WhatsApp Web API.
     * @param {string} phoneNumber - The recipient's phone number (e.g., '919876543210').
     * @param {string} message - The message text to send.
     */
    const sendWhatsAppMessage = (phoneNumber, message) => {
        if (!phoneNumber) {
            phoneNumber = prompt("Please enter the recipient's 10-digit phone number (e.g., 91XXXXXXXXXX for India):");
            if (!phoneNumber || !/^\d{10,15}$/.test(phoneNumber)) { // Basic validation for 10-15 digits
                showCustomMessage('Error', 'Invalid phone number. Please enter a valid number.', 'danger');
                return;
            }
            // Prepend '91' if the number is 10 digits and seems like an Indian number without country code
            if (phoneNumber.length === 10 && (phoneNumber.startsWith('7') || phoneNumber.startsWith('8') || phoneNumber.startsWith('9'))) { // Common Indian mobile starting digits
                phoneNumber = '91' + phoneNumber;
            }
        }
        
        const encodedMessage = encodeURIComponent(message);
        const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodedMessage}`;
        window.open(whatsappUrl, '_blank');
    };

    /**
     * Generates a formatted text message for a customer bill.
     * @param {object} bill - The bill object.
     * @returns {string} The formatted bill message.
     */
    const generateWhatsAppBillMessage = (bill) => {
        let message = `*Smart Gen Nxt Store- Bill Receipt*\n\n`;
        message += `*Bill ID:* ${bill.billId}\n`;
        message += `*Date:* ${new Date(bill.date).toLocaleString()}\n`;
        // Use masked phone number for WhatsApp message
        message += `*Customer:* ${bill.customer.name} (${maskPhoneNumber(bill.customer.phone)})\n`;
        if (bill.customer.address) {
            message += `*Address:* ${bill.customer.address}\n`;
        }
        message += `--------------------------------\n`;
        message += `*Items:*\n`;
        bill.items.forEach(item => {
            // item.name now holds the variant's display name, and item.price is the variant's price
            message += `${item.name} (Qty: ${item.quantityInBill}) - ${formatCurrency(item.total)}\n`; // Use quantityInBill
        });
        message += `--------------------------------\n`;
        message += `*Total:* ${formatCurrency(bill.total)}\n`;
        message += `*Cash Received:* ${formatCurrency(bill.paymentReceived)}\n`;
        if (bill.amountDue > 0) {
            message += `*Amount Due:* ${formatCurrency(bill.amountDue)}\n`;
        }
        if (bill.change > 0) {
            message += `*Change Due:* ${formatCurrency(bill.change)}\n`;
        }
        message += `--------------------------------\n`;
        message += `Thank you for your purchase! Visit again! 🙏\n`;
        message += `Smart Gen Nxt Store\nAllagadda, Andhra Pradesh`;
        return message;
    };

    /**
     * Generates a formatted text message for the daily sales report.
     * @param {string} reportContentHtml - The HTML content of the report.
     * @returns {string} The formatted report message.
     */
    const generateWhatsAppDailyReportMessage = (reportContentHtml) => {
        let message = `*Smart Gen Nxt Store- Daily Sales Report*\n\n`;
        // Basic parsing of HTML to get text content for WhatsApp
        const parser = new DOMParser();
        const doc = parser.parseFromString(reportContentHtml, 'text/html');
        
        const salesSummary = doc.querySelector('h5')?.textContent || 'Sales Summary';
        message += `${salesSummary}\n\n`;

        const totalBills = doc.querySelector('.row.mb-3 .col-md-6:first-child')?.textContent;
        const totalRevenue = doc.querySelector('.row.mb-3 .col-md-6:last-child')?.textContent;
        if(totalBills) message += `${totalBills}\n`;
        if(totalRevenue) message += `${totalRevenue}\n\n`;

        message += `*Top Selling Products by Revenue:*\n`;
        doc.querySelectorAll('#dailySalesReportContent tbody tr').forEach(row => {
            const cells = row.querySelectorAll('td');
            if (cells.length === 3) {
                message += `- ${cells[0].textContent.trim()}: ${cells[1].textContent.trim()} Qty | ${cells[2].textContent.trim()}\n`;
            }
        });
        message += `\nReport generated on: ${new Date().toLocaleString()}`;
        return message;
    };

    /**
     * Generates a formatted text message for the product sales report.
     * @param {string} reportContentHtml - The HTML content of the report.
     * @returns {string} The formatted report message.
     */
    const generateWhatsAppProductReportMessage = (reportContentHtml) => {
        let message = `*Smart Gen Nxt Store- Product Sales Report*\n\n`;
        const parser = new DOMParser();
        const doc = parser.parseFromString(reportContentHtml, 'text/html');

        const salesSummary = doc.querySelector('h5')?.textContent || 'Product Sales Summary';
        message += `${salesSummary}\n\n`;

        message += `*Product Sales Details:*\n`;
        doc.querySelectorAll('#productSalesReportContent tbody tr').forEach(row => {
            const cells = row.querySelectorAll('td');
            if (cells.length === 3) {
                message += `- ${cells[0].textContent.trim()}: ${cells[1].textContent.trim()} Qty | ${cells[2].textContent.trim()}\n`;
            }
        });
        message += `\nReport generated on: ${new Date().toLocaleString()}`;
        return message;
    };

    /**
     * Generates a formatted text message for the customer history report.
     * @param {string} reportContentHtml - The HTML content of the report.
     * @returns {string} The formatted report message.
     */
    const generateWhatsAppCustomerHistoryReportMessage = (reportContentHtml) => {
        let message = `*Smart Gen Nxt Store- Customer Purchase History Report*\n\n`;
        const parser = new DOMParser();
        const doc = parser.parseFromString(reportContentHtml, 'text/html');

        const salesSummary = doc.querySelector('h5')?.textContent || 'Customer Purchase Summary';
        message += `${salesSummary}\n\n`;

        message += `*Customer Summaries:*\n`;
        doc.querySelectorAll('#customerHistoryReportContent tbody tr').forEach(row => {
            const cells = row.querySelectorAll('td');
            if (cells.length >= 3) {
                message += `- ${cells[0].textContent.trim()}: Bills: ${cells[1].textContent.trim()} | Spent: ${cells[2].textContent.trim()}\n`;
            }
        });
        message += `\nReport generated on: ${new Date().toLocaleString()}`;
        return message;
    };


    // --- Customer Billing Functions ---
    const renderCustomerList = (searchTerm = '') => {
        customerListDiv.innerHTML = '';
        const filteredCustomers = customers.filter(customer =>
            customer.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
            customer.phone.includes(searchTerm)
        );

        if (selectedCustomer) {
            const selectedLi = document.createElement('a');
            selectedLi.href = '#';
            selectedLi.classList.add('list-group-item', 'list-group-item-action', 'active');
            selectedLi.textContent = `${selectedCustomer.name} (${selectedCustomer.phone})`;
            customerListDiv.appendChild(selectedLi);
        } else if (filteredCustomers.length > 0) {
            filteredCustomers.forEach(customer => {
                const li = document.createElement('a');
                li.href = '#';
                li.classList.add('list-group-item', 'list-group-item-action');
                li.textContent = `${customer.name} (${customer.phone})`;
                li.addEventListener('click', () => selectCustomer(customer));
                customerListDiv.appendChild(li);
            });
        } else if (searchTerm) {
            customerListDiv.innerHTML = '<div class="list-group-item text-muted">No customers found. Try adding a new one.</div>';
        } else {
            customerListDiv.innerHTML = '<div class="list-group-item text-muted">Start typing to search customers.</div>';
        }
    };

    const selectCustomer = (customer) => {
        selectedCustomer = customer;
        selectedCustomerDisplay.textContent = `${customer.name} (${customer.phone})`;
        selectedCustomerDisplay.classList.add('active');
        customerListDiv.innerHTML = '';
        customerSearchInput.value = '';
        displayCustomerBillHistory(customer.id);
        updateCustomerTotalDue(customer.id); // Update due amount
        updatePaymentDetails();
    };

    const clearSelectedCustomer = () => {
        selectedCustomer = null;
        selectedCustomerDisplay.textContent = 'No customer selected';
        selectedCustomerDisplay.classList.remove('active');
        customerTotalDueDisplay.textContent = formatCurrency(0); // Clear due amount
        renderCustomerList();
        customerSearchInput.value = '';
        customerBillHistoryDiv.innerHTML = '<p class="text-muted">Select a customer to view their past bills.</p>';
    };

    const updateCustomerTotalDue = (customerId) => {
        const bills = customerBills[customerId] || [];
        let totalDue = 0;
        bills.forEach(bill => {
            totalDue += bill.amountDue;
        });
        customerTotalDueDisplay.textContent = formatCurrency(totalDue);
        if (totalDue > 0) {
            customerTotalDueDisplay.classList.remove('bg-secondary', 'bg-success');
            customerTotalDueDisplay.classList.add('bg-danger');
        } else {
            customerTotalDueDisplay.classList.remove('bg-danger');
            customerTotalDueDisplay.classList.add('bg-success');
        }
    };


    const displayCustomerBillHistory = (customerId) => {
        customerBillHistoryDiv.innerHTML = '';
        const bills = customerBills[customerId] || [];

        if (bills.length === 0) {
            customerBillHistoryDiv.innerHTML = '<p class="text-muted">No past bills for this customer.</p>';
            return;
        }

        const ul = document.createElement('ul');
        ul.classList.add('list-group');
        bills.sort((a, b) => new Date(b.date) - new Date(a.date));

        bills.forEach(bill => {
            const li = document.createElement('li');
            li.classList.add('list-group-item', 'd-flex', 'justify-content-between', 'align-items-center');
            li.innerHTML = `
                <div>
                    Bill ID: <strong>${bill.billId}</strong><br>
                    Date: ${new Date(bill.date).toLocaleString()}<br>
                    Total: ${formatCurrency(bill.total)}
                    ${bill.amountDue > 0 ? `<br><span class="badge bg-warning text-dark">Due: ${formatCurrency(bill.amountDue)}</span>` : ''}
                </div>
                <button class="btn btn-outline-primary btn-sm view-bill-details" data-bill-id="${bill.billId}" data-customer-id="${customerId}">View</button>
            `;
            ul.appendChild(li);
        });
        customerBillHistoryDiv.appendChild(ul);

        document.querySelectorAll('.view-bill-details').forEach(button => {
            button.addEventListener('click', (event) => {
                const billId = event.target.dataset.billId;
                const custId = event.target.dataset.customerId;
                viewBillDetails(custId, billId);
            });
        });
    };

    const viewBillDetails = (customerId, billId) => {
        const bills = customerBills[customerId] || [];
        const bill = bills.find(b => b.billId === billId);

        if (bill) {
            generateReceiptContent(bill);
            lastGeneratedBill = bill; // Store for WhatsApp sending
            billReceiptModal.show();
        } else {
            // Using a custom message box instead of alert()
            showCustomMessage('Error', 'Bill not found!', 'danger');
        }
    };


    // --- Product Billing Functions ---
    const renderProductList = (searchTerm = '') => {
        // Hide selected product display
        selectedProductBillingDisplay.classList.add('d-none');

        // Ensure product search input is visible for typing
        productSearchInput.classList.remove('d-none');

        // Clear existing product chips and variant chips
        productListDiv.innerHTML = ''; // This will now hold product-item-chips
        productVariantsContainer.innerHTML = '';
        selectedProductForAdding = null;
        selectedVariantForAdding = null;
        variantSelectionHint.classList.add('d-none');

        // Disable quantity and add to bill button
        productQuantityInput.disabled = true;
        addProductToBillBtn.disabled = true;

        const productsToDisplay = searchTerm
            ? products.filter(product => product.name.toLowerCase().includes(searchTerm.toLowerCase()))
            : products; // Show all products if search is empty

        if (productsToDisplay.length > 0) {
            productsToDisplay.forEach(product => {
                const chip = document.createElement('button');
                chip.type = 'button';
                chip.classList.add('product-item-chip'); // Using a new class for product chips
                chip.textContent = product.name;
                chip.dataset.productId = product.id;
                chip.addEventListener('click', () => {
                    // Remove 'selected' from all product chips
                    productListDiv.querySelectorAll('.product-item-chip').forEach(c => c.classList.remove('selected'));
                    chip.classList.add('selected'); // Add 'selected' to the clicked product chip
                    selectProductForBilling(product);
                });
                productListDiv.appendChild(chip);
            });
        } else {
            productListDiv.innerHTML = '<div class="text-muted">No products found matching your search.</div>';
        }
    };


    const selectProductForBilling = (product) => {
        selectedProductForAdding = product;
        selectedVariantForAdding = null; // Ensure no variant is pre-selected

        // Hide search input and product chips, show selected product display
        productSearchInput.classList.add('d-none');
        productListDiv.classList.add('d-none'); // Hide the product chips container
        selectedProductBillingDisplay.classList.remove('d-none');
        selectedProductNameDisplay.textContent = product.name;

        // Render variants as chips
        productVariantsContainer.innerHTML = '';
        // Only attempt to sort and iterate if product.variants is an array and has elements
        if (product.variants && Array.isArray(product.variants) && product.variants.length > 0) {
            product.variants.sort((a, b) => a.quantity - b.quantity).forEach(variant => { // Sort variants by quantity
                const chip = document.createElement('button');
                chip.type = 'button';
                chip.classList.add('product-variant-chip');
                chip.textContent = `${variant.displayName} (${formatCurrency(variant.price)})`;
                chip.dataset.variantId = variant.variantId;
                chip.addEventListener('click', (event) => {
                    selectVariantForBilling(variant, event.target);
                });
                productVariantsContainer.appendChild(chip);
            });
            variantSelectionHint.classList.remove('d-none'); // Show hint
        } else {
            productVariantsContainer.innerHTML = '<p class="text-muted mt-2">No variants available for this product. Please add variants via Manage Products.</p>';
            variantSelectionHint.classList.add('d-none'); // Hide hint as no variants to select
        }
        
        // Disable quantity and add to bill until a variant is selected
        productQuantityInput.disabled = true;
        addProductToBillBtn.disabled = true;
    };

    const clearProductSelection = () => {
        selectedProductForAdding = null;
        selectedVariantForAdding = null;
        productSearchInput.value = '';
        productVariantsContainer.innerHTML = '';
        variantSelectionHint.classList.add('d-none');
        productQuantityInput.disabled = true; // Disable after clearing
        addProductToBillBtn.disabled = true; // Disable after clearing
        
        // Show product search input and product chips again
        productSearchInput.classList.remove('d-none');
        productListDiv.classList.remove('d-none'); // Show the product chips container
        selectedProductBillingDisplay.classList.add('d-none'); // Hide the selected product display

        renderProductList(''); // Re-render the search list (empty search term to show initial state with all products as chips)
    };

    const selectVariantForBilling = (variant, clickedChip) => {
        selectedVariantForAdding = variant;
        // Remove 'selected' class from all variant chips
        document.querySelectorAll('.product-variant-chip').forEach(chip => {
            chip.classList.remove('selected');
        });
        // Add 'selected' class to the clicked variant chip
        clickedChip.classList.add('selected');
        
        // Enable quantity and add to bill button once a variant is selected
        productQuantityInput.disabled = false;
        addProductToBillBtn.disabled = false;
        productQuantityInput.focus(); // Focus on quantity for quick entry
    };

    const addProductToBill = () => {
        const quantity = parseInt(productQuantityInput.value);

        if (!selectedProductForAdding) {
             showCustomMessage('Information', 'Please search for and select a main product first.', 'info');
             return;
        }

        if (!selectedVariantForAdding) {
            showCustomMessage('Information', 'Please select a specific product variant (e.g., \'Rice (1kg)\') from the chips above.', 'info');
            return;
        }

        if (isNaN(quantity) || quantity <= 0) {
            showCustomMessage('Warning', 'Please enter a valid quantity (multiples of selected variant) greater than zero.', 'warning');
            return;
        }

        // Use the selected variant object directly
        const variantToAdd = selectedVariantForAdding;

        // Check if item (variant) already exists in bill, update quantity if so
        const existingItemIndex = currentBill.findIndex(item => item.variantId === variantToAdd.variantId);

        if (existingItemIndex > -1) {
            currentBill[existingItemIndex].quantityInBill += quantity; // Quantity of the variant itself
            currentBill[existingItemIndex].total = currentBill[existingItemIndex].quantityInBill * currentBill[existingItemIndex].price;
        } else {
            // Add new item to bill
            currentBill.push({
                productId: selectedProductForAdding.id, // Store main product ID
                variantId: variantToAdd.variantId,
                name: variantToAdd.displayName, // Display name for the bill
                unit: variantToAdd.unit, // Unit of the variant (e.g., kg, L)
                quantityPerUnit: variantToAdd.quantity, // Actual quantity of the variant (e.g., 1 for 1kg, 0.5 for 500ml)
                price: variantToAdd.price, // Price of this variant
                quantityInBill: quantity, // How many of this variant is being purchased (e.g., 2 of 5kg rice)
                total: variantToAdd.price * quantity
            });
        }

        renderBillItems(); // Refresh the bill display
        // Clear all product selection state after adding to bill
        clearProductSelection(); // Use the new clear function
        productQuantityInput.value = '1'; // Reset quantity
        productSearchInput.focus(); // Focus back to product search for next item
    };

    const removeProductFromBill = (variantId) => {
        currentBill = currentBill.filter(item => item.variantId !== variantId);
        renderBillItems();
    };

    const renderBillItems = () => {
        billItemsTableBody.innerHTML = '';
        let total = 0;

        if (currentBill.length === 0) {
            billItemsTableBody.innerHTML = '<tr><td colspan="5" class="text-muted text-center">No items in the bill.</td></tr>';
            billTotalSpan.textContent = formatCurrency(0);
            updatePaymentDetails();
            return;
        }

        currentBill.forEach(item => {
            const row = billItemsTableBody.insertRow();
            // Display name from variant, quantity is quantityInBill
            row.innerHTML = `
                <td>${item.name}</td>
                <td><input type="number" class="form-control form-control-sm bill-item-qty" data-variant-id="${item.variantId}" value="${item.quantityInBill}" min="1"></td>
                <td><input type="number" class="form-control form-control-sm bill-item-price" data-variant-id="${item.variantId}" value="${item.price}" min="0.01" step="0.01"></td>
                <td>${formatCurrency(item.total)}</td>
                <td><button class="btn btn-danger btn-sm remove-item-btn" data-variant-id="${item.variantId}">Remove</button></td>
            `;
            total += item.total;
        });

        billTotalSpan.textContent = formatCurrency(total);
        updatePaymentDetails();

        document.querySelectorAll('.remove-item-btn').forEach(button => {
            button.addEventListener('click', (event) => {
                const variantId = event.target.dataset.variantId;
                removeProductFromBill(variantId);
            });
        });

        document.querySelectorAll('.bill-item-qty').forEach(input => {
            input.addEventListener('change', (event) => {
                const variantId = event.target.dataset.variantId;
                let newQuantityInBill = parseInt(event.target.value);
                const item = currentBill.find(i => i.variantId === variantId);

                if (item) {
                    if (isNaN(newQuantityInBill) || newQuantityInBill <= 0) {
                        newQuantityInBill = 1;
                        event.target.value = 1;
                    }
                    item.quantityInBill = newQuantityInBill;
                    item.total = item.quantityInBill * item.price;
                    renderBillItems();
                }
            });
        });

        document.querySelectorAll('.bill-item-price').forEach(input => {
            input.addEventListener('change', (event) => {
                const variantId = event.target.dataset.variantId;
                let newPrice = parseFloat(event.target.value);
                const item = currentBill.find(i => i.variantId === variantId);

                if (item) {
                    if (isNaN(newPrice) || newPrice <= 0) {
                        newPrice = item.price; // Revert to old price if invalid
                        event.target.value = item.price.toFixed(2);
                    }
                    item.price = newPrice;
                    item.total = item.quantityInBill * item.price; // Recalculate total based on new price
                    renderBillItems();
                }
            });
        });
    };

    const clearCurrentBill = () => {
        // Replace confirm with custom modal for better UI
        showCustomConfirm('Clear Bill', 'Are you sure you want to clear the current bill?', () => {
            currentBill = [];
            renderBillItems();
            paymentAmountInput.value = '0';
            updatePaymentDetails();
            clearProductSelection(); // Use the new clear function
        });
    };


    // --- Payment & Finalize Functions ---
    const updatePaymentDetails = () => {
        const total = parseFloat(billTotalSpan.textContent.replace('₹ ', ''));
        const paymentReceived = parseFloat(paymentAmountInput.value) || 0;

        const amountDue = Math.max(0, total - paymentReceived);
        const change = Math.max(0, paymentReceived - total);

        amountDueSpan.textContent = formatCurrency(amountDue);
        changeAmountSpan.textContent = formatCurrency(change);

        generateBillBtn.disabled = false;
        saveBillBtn.disabled = false;

        if (paymentReceived > 0 && amountDue > 0) {
            paymentAmountInput.classList.add('is-invalid');
        } else {
            paymentAmountInput.classList.remove('is-invalid');
        }
    };

    const generateBill = (print = true) => {
        if (!selectedCustomer) {
            showCustomMessage('Warning', 'Please select a customer first.', 'warning');
            return;
        }
        if (currentBill.length === 0) {
            showCustomMessage('Warning', 'Bill is empty. Add some items first.', 'warning');
            return;
        }

        const total = parseFloat(billTotalSpan.textContent.replace('₹ ', ''));
        const paymentReceived = parseFloat(paymentAmountInput.value) || 0;
        const amountDue = parseFloat(amountDueSpan.textContent.replace('₹ ', ''));
        const change = parseFloat(changeAmountSpan.textContent.replace('₹ ', ''));

        const bill = {
            billId: `INV-${nextBillId++}`,
            date: new Date().toISOString(),
            customer: { ...selectedCustomer },
            // Store items in the bill including their variant details
            items: currentBill.map(item => ({
                productId: item.productId,
                variantId: item.variantId,
                name: item.name, // Display name of the variant
                unit: item.unit,
                quantityPerUnit: item.quantityPerUnit,
                price: item.price,
                quantityInBill: item.quantityInBill, // How many of this variant (e.g., 2 bags of 5kg rice)
                total: item.total
            })),
            total: total,
            paymentReceived: paymentReceived,
            amountDue: amountDue,
            change: change
        };

        if (!customerBills[selectedCustomer.id]) {
            customerBills[selectedCustomer.id] = [];
        }
        customerBills[selectedCustomer.id].push(bill);
        saveCustomerBills(customerBills);
        saveNextBillId(nextBillId);

        generateReceiptContent(bill);
        lastGeneratedBill = bill; // Store the generated bill for WhatsApp sending
        billReceiptModal.show();

        if (print) {
            setTimeout(() => {
                const printWindow = window.open('', '', 'height=600,width=800');
                printWindow.document.write('<html><head><title>Print Bill</title>');
                printWindow.document.write('<style>');
                printWindow.document.write(`
                    body { font-family: 'Courier New', Courier, monospace; font-size: 12px; margin: 0; padding: 10mm; }
                    .receipt { width: 80mm; margin: 0 auto; border: 1px dashed #ccc; padding: 10px; }
                    .header, .footer { text-align: center; margin-bottom: 10px; }
                    .item-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
                    .item-table th, .item-table td { border-bottom: 1px dashed #ccc; padding: 5px 0; text-align: left; }
                    .item-table th:nth-child(2), .item-table td:nth-child(2) { text-align: center; }
                    .item-table th:nth-child(3), .item-table td:nth-child(3) { text-align: right; }
                    .item-table th:nth-child(4), .item-table td:nth-child(4) { text-align: right; }
                    .total-section { text-align: right; margin-top: 10px; }
                    .total-section div { margin-bottom: 5px; }
                    .thank-you { text-align: center; margin-top: 20px; font-style: italic; }
                `);
                printWindow.document.write('</style></head><body>');
                printWindow.document.write(receiptContentDiv.innerHTML);
                printWindow.document.close();
                printWindow.focus();
                printWindow.print();
                printWindow.onafterprint = () => printWindow.close();
            }, 500);
        }

        // After successful bill generation, update the customer's total due display
        if (selectedCustomer) {
            updateCustomerTotalDue(selectedCustomer.id);
        }

        clearSelectedCustomer();
        clearCurrentBill();
        // The clearProductSelection() is already called within addProductToBill, no need here.
    };

    const generateReceiptContent = (bill) => {
        let receiptHtml = `
            <div class="receipt">
                <div class="header">
                    <h4>Smart Gen Nxt Store</h4>
                    <p>Allagadda, Andhra Pradesh, India</p>
                    <p>Phone: 9876543210 | GSTIN: ABCDE12345FGHI</p>
                    <hr style="border-top: 1px dashed #000;">
                </div>
                <div>
                    <strong>Bill ID:</strong> ${bill.billId}<br>
                    <strong>Date:</strong> ${new Date(bill.date).toLocaleString()}<br>
                    <strong>Customer:</strong> ${bill.customer.name} (${maskPhoneNumber(bill.customer.phone)})<br> <!-- Masked phone number here -->
                    ${bill.customer.address ? `<strong>Address:</strong> ${bill.customer.address}<br>` : ''}
                    <hr style="border-top: 1px dashed #000;">
                </div>
                <table class="item-table">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>Qty</th>
                            <th>Price</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        bill.items.forEach(item => {
            // item.name is now the variant's displayName (e.g., Rice (1kg))
            // item.quantityInBill is the number of *these variants* purchased
            // item.price is the price of ONE of these variants
            receiptHtml += `
                        <tr>
                            <td>${item.name}</td>
                            <td>${item.quantityInBill}</td>
                            <td>${formatCurrency(item.price)}</td>
                            <td>${formatCurrency(item.total)}</td>
                        </tr>
            `;
        });

        receiptHtml += `
                    </tbody>
                </table>
                <hr style="border-top: 1px dashed #000;">
                <div class="total-section">
                    <div><strong>Subtotal:</strong> ${formatCurrency(bill.total)}</div>
                    <div><strong>Discount:</strong> ${formatCurrency(0)}</div>
                    <div><strong>Grand Total:</strong> ${formatCurrency(bill.total)}</div>
                    <div><strong>Cash Received:</strong> ${formatCurrency(bill.paymentReceived)}</div>
                    ${bill.amountDue > 0 ? `<div><strong>Amount Due:</strong> ${formatCurrency(bill.amountDue)}</div>` : ''}
                    ${bill.change > 0 ? `<div><strong>Change Due:</strong> ${formatCurrency(bill.change)}</div>` : ''}
                </div>
                <div class="thank-you">
                    <p>Thank you for your purchase!</p>
                    <p>Visit again!</p>
                </div>
            </div>
        `;
        receiptContentDiv.innerHTML = receiptHtml;
    };


    // --- Product Management Functions ---
    const renderProductListManagement = () => {
        productListManagementDiv.innerHTML = '';
        if (products.length === 0) {
            productListManagementDiv.innerHTML = '<p class="text-muted">No products added yet. Click "Add New Product" to start.</p>';
            return;
        }

        const ul = document.createElement('ul');
        ul.classList.add('list-group');
        // Sort products by category then by name for better readability
        const sortedProducts = [...products].sort((a, b) => {
            if (a.category < b.category) return -1;
            if (a.category > b.category) return 1;
            if (a.name < b.name) return -1;
            if (a.name > b.name) return 1;
            return 0;
        });

        sortedProducts.forEach(product => {
            // Safely get the first variant
            const firstVariant = (product.variants && product.variants.length > 0) ? product.variants[0] : null;
            const displayPrice = firstVariant ? formatCurrency(firstVariant.price) : 'N/A';
            const displayVariantName = firstVariant ? firstVariant.displayName : 'No variants defined';

            const li = document.createElement('li');
            li.classList.add('list-group-item', 'd-flex', 'justify-content-between', 'align-items-center');
            li.innerHTML = `
                <div>
                    <strong>${product.name}</strong> (Category: ${product.category})<br>
                    <small>Default Variant: ${displayVariantName} - ${displayPrice}</small>
                </div>
                <div>
                    <button class="btn btn-sm btn-outline-primary edit-product-btn" data-product-id="${product.id}">Edit</button>
                    <button class="btn btn-sm btn-outline-danger delete-product-btn" data-product-id="${product.id}">Delete</button>
                </div>
            `;
            ul.appendChild(li);
        });
        productListManagementDiv.appendChild(ul);

        document.querySelectorAll('.edit-product-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const productId = e.target.dataset.productId;
                showEditProductModal(productId);
            });
        });
        document.querySelectorAll('.delete-product-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const productId = e.target.dataset.productId;
                // Replace confirm with custom modal
                showCustomConfirm('Delete Product', 'Are you sure you want to delete this product? This action cannot be undone.', () => {
                    deleteProduct(productId);
                });
            });
        });
    };

    const showEditProductModal = (productId) => {
        const product = products.find(p => p.id === productId);
        if (product) {
            currentEditProductId = productId;
            editProductNameInput.value = product.name;
            renderCategoryChips(editProductCategoryChips, product.category); // Render category chips with selected category

            // Reset variant selection and buttons for editing variants
            currentSelectedVariantForManagement = null;
            addEditProductVariantBtn.textContent = 'Add Variant';
            addEditProductVariantBtn.disabled = false; // Always allow adding variants
            deleteProductVariantBtn.disabled = true;
            noVariantSelectedHint.classList.add('d-none'); // Hide hint by default

            renderVariantChipsForProductManagement(productId); // Render variants for the product
            editProductModal.show();
        }
    };

    const editProduct = () => {
        const newName = editProductNameInput.value.trim();
        const newCategory = currentSelectedCategoryForManagement; // Get from selected chip

        if (!newName || !newCategory || newCategory === '') {
            showCustomMessage('Warning', 'Please fill all product details correctly, including selecting a category.', 'warning');
            return;
        }

        const productIndex = products.findIndex(p => p.id === currentEditProductId);
        if (productIndex > -1) {
            products[productIndex].name = newName;
            products[productIndex].category = newCategory;
            
            saveProducts(products);
            renderProductListManagement();
            renderProductList(''); // Re-render main billing product list with empty search to show all
            editProductModal.hide();
            showCustomMessage('Success', 'Product updated successfully!', 'success');
        }
    };

    const deleteProduct = (productId) => {
        products = products.filter(p => p.id !== productId);
        saveProducts(products);
        renderProductListManagement();
        renderProductList(''); // Re-render main billing product list with empty search to show all
        showCustomMessage('Success', 'Product deleted successfully!', 'success');
    };

    const addProduct = () => {
        const name = productNameInputManagement.value.trim();
        const category = currentSelectedCategoryForManagement; // Get from selected chip
        const variantDisplayName = productVariantDisplayNameManagement.value.trim();
        const variantUnit = productVariantUnitManagement.value.trim();
        const variantQuantity = parseFloat(productVariantQuantityManagement.value);
        const price = parseFloat(productPriceManagement.value);

        if (!name || !category || category === '' || // Ensure category is selected
            !variantDisplayName || !variantUnit || variantUnit === '' ||
            isNaN(variantQuantity) || variantQuantity <= 0 ||
            isNaN(price) || price <= 0) {
            showCustomMessage('Warning', 'Please fill all product and default variant fields correctly, ensuring quantities and prices are positive numbers and a category is selected.', 'warning');
            return;
        }

        // Check for duplicate product names (case-insensitive)
        if (products.some(p => p.name.toLowerCase() === name.toLowerCase())) {
            showCustomMessage('Warning', 'A product with this name already exists. Please use a unique name.', 'warning');
            return;
        }

        const newProductId = `P${String(nextProductId++).padStart(3, '0')}`;
        const newProduct = {
            id: newProductId,
            name: name,
            category: category,
            variants: [
                {
                    variantId: `${newProductId}V1`, // First variant ID
                    displayName: variantDisplayName,
                    unit: variantUnit,
                    quantity: variantQuantity,
                    price: price,
                    priceHistory: [{ date: new Date().toISOString(), price: price }] // Initial price entry
                }
            ]
        };
        products.push(newProduct);
        saveProducts(products);
        renderProductListManagement();
        renderProductList(''); // Re-render main billing product list with empty search to show all
        addProductModal.hide();
        addProductFormManagement.reset();
        currentSelectedCategoryForManagement = null; // Reset selected category after adding
        showCustomMessage('Success', 'Product added successfully!', 'success');
    };


    // --- Variant Management Functions (within Edit Product Modal) ---
    const renderVariantChipsForProductManagement = (productId) => {
        const container = document.getElementById('editProductVariantsContainer');
        if (!container) return;

        container.innerHTML = '';
        currentSelectedVariantForManagement = null; // Reset selection

        const product = products.find(p => p.id === productId);
        if (!product || !product.variants || product.variants.length === 0) {
            container.innerHTML = '<p class="text-muted">No variants for this product. Click "Add/Edit Variant" to add one.</p>';
            addEditProductVariantBtn.textContent = 'Add Variant';
            addEditProductVariantBtn.disabled = false; // Always allow adding new if none exist
            deleteProductVariantBtn.disabled = true;
            noVariantSelectedHint.classList.add('d-none'); // Hide hint
            return;
        }

        // Initially, the button should say "Add Variant" and delete should be disabled
        addEditProductVariantBtn.textContent = 'Add Variant';
        addEditProductVariantBtn.disabled = false;
        deleteProductVariantBtn.disabled = true;
        noVariantSelectedHint.classList.remove('d-none'); // Show hint to select for edit/delete

        product.variants.forEach(variant => {
            const chip = document.createElement('button');
            chip.type = 'button';
            chip.classList.add('product-variant-chip');
            chip.textContent = `${variant.displayName} (${formatCurrency(variant.price)})`;
            chip.dataset.variantId = variant.variantId;
            chip.addEventListener('click', (e) => {
                // Remove 'selected' from all chips
                document.querySelectorAll('#editProductVariantsContainer .product-variant-chip').forEach(c => c.classList.remove('selected'));
                e.target.classList.add('selected');
                currentSelectedVariantForManagement = variant;
                // Update button text and enable delete
                addEditProductVariantBtn.textContent = 'Edit Selected Variant';
                deleteProductVariantBtn.disabled = false;
                noVariantSelectedHint.classList.add('d-none'); // Hide hint once selected
            });
            container.appendChild(chip);
        });
    };

    // Event listener for the "Add/Edit Variant" button in the Product Management Modal
    addEditProductVariantBtn.addEventListener('click', () => {
        const product = products.find(p => p.id === currentEditProductId);
        if (!product) {
            showCustomMessage('Error', 'No product selected for variant management.', 'danger');
            return;
        }

        // If a variant is selected, prepare for edit; otherwise, prepare for add
        if (currentSelectedVariantForManagement) {
            addEditVariantModalLabel.textContent = 'Edit Product Variant';
            variantDisplayNameInput.value = currentSelectedVariantForManagement.displayName;
            variantUnitInput.value = currentSelectedVariantForManagement.unit;
            variantQuantityInput.value = currentSelectedVariantForManagement.quantity;
            variantPriceInput.value = currentSelectedVariantForManagement.price;
            currentEditingVariantId.value = currentSelectedVariantForManagement.variantId;
        } else {
            addEditVariantModalLabel.textContent = 'Add New Product Variant';
            addEditVariantForm.reset();
            currentEditingVariantId.value = ''; // Clear variant ID for new variant
        }
        currentEditingVariantProductId.value = currentEditProductId; // Always set the product ID

        addEditVariantModal.show();
    });

    // Event listener for the "Delete Selected Variant" button
    deleteProductVariantBtn.addEventListener('click', () => {
        if (!currentSelectedVariantForManagement) {
            showCustomMessage('Warning', 'Please select a variant to delete.', 'warning');
            return;
        }
        showCustomConfirm('Delete Variant', 'Are you sure you want to delete this variant? This action cannot be undone.', () => {
            const product = products.find(p => p.id === currentEditProductId);
            if (product) {
                // Ensure there's at least one variant remaining
                if (product.variants.length <= 1) {
                    showCustomMessage('Warning', 'A product must have at least one variant. Cannot delete the last variant.', 'warning');
                    return;
                }
                product.variants = product.variants.filter(v => v.variantId !== currentSelectedVariantForManagement.variantId);
                saveProducts(products);
                renderVariantChipsForProductManagement(currentEditProductId); // Re-render variants
                renderProductList(''); // Update main billing view
                showCustomMessage('Success', 'Variant deleted successfully!', 'success');
            }
        });
    });

    // Event listener for saving variant (add/edit)
    addEditVariantForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const productId = currentEditingVariantProductId.value;
        const variantId = currentEditingVariantId.value;
        const displayName = variantDisplayNameInput.value.trim();
        const unit = variantUnitInput.value.trim();
        const quantity = parseFloat(variantQuantityInput.value);
        const price = parseFloat(variantPriceInput.value);

        if (!displayName || !unit || isNaN(quantity) || quantity <= 0 || isNaN(price) || price <= 0) {
            showCustomMessage('Warning', 'Please fill all variant details correctly, ensuring quantity and price are positive numbers.', 'warning');
            return;
        }

        const product = products.find(p => p.id === productId);
        if (!product) {
            showCustomMessage('Error', 'Product not found for variant operation.', 'danger');
            return;
        }

        const isEditing = !!variantId;
        if (isEditing) {
            const existingVariant = product.variants.find(v => v.variantId === variantId);
            if (existingVariant) {
                // Check if price has changed and record history
                if (existingVariant.price !== price) {
                    if (!existingVariant.priceHistory) {
                        existingVariant.priceHistory = [];
                    }
                    existingVariant.priceHistory.push({ date: new Date().toISOString(), price: existingVariant.price }); // Record old price
                    // Ensure the price history is sorted by date for Chart.js
                    existingVariant.priceHistory.sort((a,b) => new Date(a.date) - new Date(b.date));
                }
                existingVariant.displayName = displayName;
                existingVariant.unit = unit;
                existingVariant.quantity = quantity;
                existingVariant.price = price;
            } else {
                showCustomMessage('Error', 'Variant to edit not found.', 'danger');
                return;
            }
        } else {
            // Add new variant
            // Check for duplicate display name for the same product
            if (product.variants.some(v => v.displayName.toLowerCase() === displayName.toLowerCase())) {
                showCustomMessage('Warning', `A variant with display name "${displayName}" already exists for this product.`, 'warning');
                return;
            }

            const newVariantId = `${productId}V${product.variants.length + 1}`; // Simple incrementing ID for new variants
            product.variants.push({
                variantId: newVariantId,
                displayName: displayName,
                unit: unit,
                quantity: quantity,
                price: price,
                priceHistory: [{ date: new Date().toISOString(), price: price }] // Initial price entry
            });
        }

        saveProducts(products);
        renderVariantChipsForProductManagement(productId); // Re-render variants
        renderProductList(''); // Update main billing view
        addEditVariantModal.hide();
        showCustomMessage('Success', `Variant ${isEditing ? 'updated' : 'added'} successfully!`, 'success');
    });


    // --- Customer Management Functions ---
    const renderCustomerListManagement = () => {
        customerListManagementDiv.innerHTML = '';
        if (customers.length === 0) {
            customerListManagementDiv.innerHTML = '<p class="text-muted">No customers added yet. Click "Add New Customer" to start.</p>';
            return;
        }

        const ul = document.createElement('ul');
        ul.classList.add('list-group');
        customers.forEach(customer => {
            const li = document.createElement('li');
            li.classList.add('list-group-item', 'd-flex', 'justify-content-between', 'align-items-center');
            li.innerHTML = `
                <div>${customer.name} (${customer.phone})</div>
                <div>
                     <button class="btn btn-sm btn-outline-primary edit-customer-btn" data-customer-id="${customer.id}">Edit</button>
                    <button class="btn btn-sm btn-outline-danger delete-customer-btn" data-customer-id="${customer.id}">Delete</button>
                </div>
            `;
            ul.appendChild(li);
        });
        customerListManagementDiv.appendChild(ul);

        document.querySelectorAll('.edit-customer-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const customerId = e.target.dataset.customerId;
                showEditCustomerModal(customerId);
            });
        });
        document.querySelectorAll('.delete-customer-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const customerId = e.target.dataset.customerId;
                // Replace confirm with custom modal
                showCustomConfirm('Delete Customer', 'Are you sure you want to delete this customer? This action cannot be undone.', () => {
                    deleteCustomer(customerId);
                });
            });
        });
    };

    const showEditCustomerModal = (customerId) => {
        const customer = customers.find(c => c.id === customerId);
        if (customer) {
            currentEditCustomerId = customerId;
            editCustomerNameInput.value = customer.name;
            editCustomerPhoneInput.value = customer.phone;
            editCustomerAddressInput.value = customer.address || '';
            editCustomerModal.show();
        }
    };

    const editCustomer = () => {
        const newName = editCustomerNameInput.value.trim();
        const newPhone = editCustomerPhoneInput.value.trim();
        const newAddress = editCustomerAddressInput.value.trim();

        if (!newName || !newPhone) {
            showCustomMessage('Warning', 'Please enter a valid name and phone number.', 'warning');
            return;
        }

        const customerIndex = customers.findIndex(c => c.id === currentEditCustomerId);
        if (customerIndex > -1) {
            customers[customerIndex].name = newName;
            customers[customerIndex].phone = newPhone;
            customers[customerIndex].address = newAddress;
            saveCustomers(customers);
            renderCustomerListManagement();
            renderCustomerList(); // Re-render main billing customer list
            if (selectedCustomer && selectedCustomer.id === currentEditCustomerId) {
                selectCustomer(customers[customerIndex]); // Update selected customer display if it's the one being edited
            }
            editCustomerModal.hide();
            showCustomMessage('Success', 'Customer updated successfully!', 'success');
        }
    };

    const deleteCustomer = (customerId) => {
        customers = customers.filter(c => c.id !== customerId);
        delete customerBills[customerId]; // Also delete their bill history
        saveCustomers(customers);
        saveCustomerBills(customerBills);
        renderCustomerListManagement();
        renderCustomerList(); // Re-render main billing customer list
        if (selectedCustomer && selectedCustomer.id === customerId) {
            clearSelectedCustomer(); // Clear selected customer if it was the one deleted
        }
        showCustomMessage('Success', 'Customer deleted successfully!', 'success');
    };

    // --- Reporting Functions ---

    // Helper to filter bills by date range
    const filterBillsByDateRange = (allBills, startDate, endDate) => {
        let filteredBills = [];
        const startTimestamp = startDate ? new Date(startDate).setHours(0, 0, 0, 0) : 0; // Start of day or epoch
        const endTimestamp = endDate ? new Date(endDate).setHours(23, 59, 59, 999) : Infinity; // End of day or far future

        for (const customerId in allBills) {
            allBills[customerId].forEach(bill => {
                const billDate = new Date(bill.date).getTime(); // Bill date in milliseconds
                if (billDate >= startTimestamp && billDate <= endTimestamp) {
                    filteredBills.push(bill);
                }
            });
        }
        return filteredBills.sort((a, b) => new Date(a.date) - new Date(b.date)); // Sort by date ascending
    };

    // 1. Generate Daily/Date Range Sales Report
    const generateDailySalesReport = () => {
        const start = startDateInput.value;
        const end = endDateInput.value;

        if (start && end && new Date(start) > new Date(end)) {
            dailySalesReportContent.innerHTML = '<p class="text-danger text-center">Start date cannot be after end date.</p>';
            lastGeneratedDailyReport = ''; // Clear report content
            return;
        }

        const filteredBills = filterBillsByDateRange(customerBills, start, end);

        if (filteredBills.length === 0) {
            dailySalesReportContent.innerHTML = `<p class="text-muted text-center">No sales found for the selected date range.</p>`;
            lastGeneratedDailyReport = ''; // Clear report content
            return;
        }

        let totalRevenue = 0;
        let totalBills = filteredBills.length;
        const productSales = {}; // {variantId: {name: '...', quantity: X, revenue: Y}}

        filteredBills.forEach(bill => {
            totalRevenue += bill.total;
            bill.items.forEach(item => {
                // Use variantId for product sales aggregation
                if (!productSales[item.variantId]) {
                    productSales[item.variantId] = { name: item.name, totalQuantityInBill: 0, totalRevenue: 0, unit: item.unit, quantityPerUnit: item.quantityPerUnit };
                }
                productSales[item.variantId].totalQuantityInBill += item.quantityInBill; // Number of variants sold
                productSales[item.variantId].totalRevenue += item.total;
            });
        });

        // Convert productSales object to array for sorting
        const sortedProducts = Object.values(productSales).sort((a, b) => b.totalRevenue - a.totalRevenue);

        let reportHtml = `
            <h5 class="text-center">Sales Summary: ${start || 'All Time'} to ${end || 'All Time'}</h5>
            <div class="row mb-3">
                <div class="col-md-6"><strong>Total Bills:</strong> ${totalBills}</div>
                <div class="col-md-6"><strong>Total Revenue:</strong> ${formatCurrency(totalRevenue)}</div>
            </div>
            <h6 class="mt-4">Top Selling Products by Revenue:</h6>
            <div class="table-responsive">
                <table class="table table-sm table-striped">
                    <thead>
                        <tr>
                            <th>Product Variant</th>
                            <th class="text-center">Units Sold</th>
                            <th class="text-end">Revenue</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        sortedProducts.slice(0, 10).forEach(p => { // Show top 10
            reportHtml += `
                        <tr>
                            <td>${p.name}</td>
                            <td class="text-center">${p.totalQuantityInBill}</td>
                            <td class="text-end">${formatCurrency(p.totalRevenue)}</td>
                        </tr>
            `;
        });
        reportHtml += `
                    </tbody>
                </table>
            </div>
            ${sortedProducts.length > 10 ? '<p class="text-muted text-center">(Showing top 10 products)</p>' : ''}
        `;
        dailySalesReportContent.innerHTML = reportHtml;
        lastGeneratedDailyReport = reportHtml; // Store HTML content for WhatsApp sending
    };

    // 2. Generate Product Sales Report
    const generateProductSalesReport = () => {
        const start = productSalesReportStartDate.value;
        const end = productSalesReportEndDate.value;

        if (start && end && new Date(start) > new Date(end)) {
            productSalesReportContent.innerHTML = '<p class="text-danger text-center">Start date cannot be after end date.</p>';
            lastGeneratedProductReport = ''; // Clear report content
            return;
        }

        const filteredBills = filterBillsByDateRange(customerBills, start, end);

        if (filteredBills.length === 0) {
            productSalesReportContent.innerHTML = `<p class="text-muted text-center">No product sales found for the selected date range.</p>`;
            lastGeneratedProductReport = ''; // Clear report content
            return;
        }

        const productSummary = {}; // {productId: {name: '...', totalQuantitySold: X, totalRevenue: Y}}
        // Aggregate by main product, not variant, for this report
        filteredBills.forEach(bill => {
            bill.items.forEach(item => {
                const mainProduct = products.find(p => p.id === item.productId);
                const mainProductName = mainProduct ? mainProduct.name : 'Unknown Product';

                if (!productSummary[item.productId]) {
                    productSummary[item.productId] = { name: mainProductName, totalQuantitySold: 0, totalRevenue: 0 };
                }
                productSummary[item.productId].totalQuantitySold += (item.quantityPerUnit * item.quantityInBill); // Aggregate total kg/L/pcs
                productSummary[item.productId].totalRevenue += item.total;
            });
        });

        const sortedProducts = Object.values(productSummary).sort((a, b) => b.totalRevenue - a.totalRevenue);

        let reportHtml = `
            <h5 class="text-center">Product Sales Summary: ${start || 'All Time'} to ${end || 'All Time'}</h5>
            <div class="table-responsive">
                <table class="table table-sm table-striped">
                    <thead>
                        <tr>
                            <th>Product Name</th>
                            <th class="text-center">Total Quantity (Aggregated)</th>
                            <th class="text-end">Total Revenue</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        sortedProducts.forEach(p => {
            reportHtml += `
                        <tr>
                            <td>${p.name}</td>
                            <td class="text-center">${p.totalQuantitySold.toFixed(2)}</td> <!-- Display aggregated quantity -->
                            <td class="text-end">${formatCurrency(p.totalRevenue)}</td>
                        </tr>
            `;
        });
        reportHtml += `
                    </tbody>
                </table>
            </div>
        `;
        productSalesReportContent.innerHTML = reportHtml;
        lastGeneratedProductReport = reportHtml; // Store HTML content for WhatsApp sending
    };

    // 3. Generate Customer Purchase History Report
    const generateCustomerHistoryReport = () => {
        const start = customerHistoryStartDate.value;
        const end = customerHistoryEndDate.value;

        if (start && end && new Date(start) > new Date(end)) {
            customerHistoryReportContent.innerHTML = '<p class="text-danger text-center">Start date cannot be after end date.</p>';
            lastGeneratedCustomerHistoryReport = ''; // Clear report content
            return;
        }

        const customerPurchaseSummary = {}; // {customerId: {name: '...', totalBills: X, totalSpent: Y, bills: []}}

        const filteredBills = filterBillsByDateRange(customerBills, start, end);

        if (filteredBills.length === 0) {
            customerHistoryReportContent.innerHTML = `<p class="text-muted text-center">No customer purchases found for the selected date range.</p>`;
            lastGeneratedCustomerHistoryReport = ''; // Clear report content
            return;
        }

        filteredBills.forEach(bill => {
            const custId = bill.customer.id;
            if (!customerPurchaseSummary[custId]) {
                customerPurchaseSummary[custId] = {
                    name: bill.customer.name,
                    phone: bill.customer.phone,
                    totalBills: 0,
                    totalSpent: 0,
                    bills: [] // Store full bill objects for potential drill-down
                };
            }
            customerPurchaseSummary[custId].totalBills++;
            customerPurchaseSummary[custId].totalSpent += bill.total;
            customerPurchaseSummary[custId].bills.push(bill);
        });

        const sortedCustomers = Object.values(customerPurchaseSummary).sort((a, b) => b.totalSpent - a.totalSpent);

        let reportHtml = `
            <h5 class="text-center">Customer Purchase Summary: ${start || 'All Time'} to ${end || 'All Time'}</h5>
            <div class="table-responsive">
                <table class="table table-sm table-striped">
                    <thead>
                        <tr>
                            <th>Customer Name (Phone)</th>
                            <th class="text-center">Total Bills</th>
                            <th class="text-end">Total Spent</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        sortedCustomers.forEach(c => {
            reportHtml += `
                        <tr>
                            <td>${c.name} (${maskPhoneNumber(c.phone)})</td> <!-- Masked phone number here -->
                            <td class="text-center">${c.totalBills}</td>
                            <td class="text-end">${formatCurrency(c.totalSpent)}</td>
                            <td><button class="btn btn-sm btn-outline-info view-customer-bills-btn" data-customer-id="${c.phone}" data-start-date="${start}" data-end-date="${end}">View Bills</button></td>
                        </tr>
            `;
        });
        reportHtml += `
                    </tbody>
                </table>
            </div>
            <div id="customerDetailedBills" class="mt-4">
                </div>
        `;
        customerHistoryReportContent.innerHTML = reportHtml;
        lastGeneratedCustomerHistoryReport = reportHtml; // Store HTML content for WhatsApp sending

        // Add event listeners for "View Bills" buttons
        document.querySelectorAll('.view-customer-bills-btn').forEach(button => {
            button.addEventListener('click', (event) => {
                const customerPhone = event.target.dataset.customerId; // Using phone as a unique identifier for now
                const startDateForDetail = event.target.dataset.startDate || '';
                const endDateForDetail = event.target.dataset.endDate || '';

                const customer = customers.find(c => c.phone === customerPhone);
                if (customer) {
                    displayCustomerDetailedBills(customer.id, startDateForDetail, endDateForDetail);
                }
            });
        });
    };

    // Function to display detailed bills for a specific customer in the reports modal
    const displayCustomerDetailedBills = (customerId, startDate, endDate) => {
        const customer = customers.find(c => c.id === customerId);
        const bills = customerBills[customerId] || [];

        let detailedBillsHtml = `
            <h6 class="mt-4">Detailed Bills for ${customer.name} (${maskPhoneNumber(customer.phone)}):</h6> <!-- Masked phone number here -->
        `;

        const filteredCustomerBills = filterBillsByDateRange({[customerId]: bills}, startDate, endDate);

        if (filteredCustomerBills.length === 0) {
            detailedBillsHtml += `<p class="text-muted">No bills found for this customer in the selected date range.</p>`;
        } else {
            detailedBillsHtml += `
            <div class="list-group">
            `;
            filteredCustomerBills.forEach(bill => {
                detailedBillsHtml += `
                    <div class="list-group-item mb-2 border rounded">
                        <strong>Bill ID:</strong> ${bill.billId}<br>
                        <strong>Date:</strong> ${new Date(bill.date).toLocaleString()}<br>
                        <strong>Total:</strong> ${formatCurrency(bill.total)}<br>
                        ${bill.amountDue > 0 ? `<span class="badge bg-warning text-dark">Amount Due: ${formatCurrency(bill.amountDue)}</span><br>` : ''}
                        <strong>Items:</strong>
                        <ul class="list-group list-group-flush mt-1">
                `;
                bill.items.forEach(item => {
                    // Use item.name (which is variant's displayName)
                    detailedBillsHtml += `
                            <li class="list-group-item py-1 px-0">${item.name} (Qty: ${item.quantityInBill}) - ${formatCurrency(item.total)}</li>
                    `;
                });
                detailedBillsHtml += `
                        </ul>
                    </div>
                `;
            });
            detailedBillsHtml += `</div>`;
        }
        document.getElementById('customerDetailedBills').innerHTML = detailedBillsHtml;
        document.getElementById('customerDetailedBills').scrollIntoView({ behavior: 'smooth', block: 'start' }); // Scroll to view details
    };


    // --- Price Chart Functions ---
    const populateChartProductSelect = () => {
        chartProductSelect.innerHTML = '<option value="">Select a Product</option>';
        chartVariantSelect.innerHTML = '<option value="">Select a Variant</option>';
        chartVariantSelect.disabled = true;
        priceChartMessage.textContent = 'Select a product and variant to view its price history.';

        products.forEach(p => {
            const option = document.createElement('option');
            option.value = p.id;
            option.textContent = p.name;
            chartProductSelect.appendChild(option);
        });
        // Destroy existing chart if any
        if (priceChart) {
            priceChart.destroy();
            priceChart = null;
        }
    };

    const populateChartVariantSelect = () => {
        const productId = chartProductSelect.value;
        chartVariantSelect.innerHTML = '<option value="">Select a Variant</option>';
        chartVariantSelect.disabled = true;
        priceChartMessage.textContent = 'Select a variant to view its price history.';

        if (priceChart) {
            priceChart.destroy();
            priceChart = null;
        }

        if (productId) {
            const product = products.find(p => p.id === productId);
            if (product && product.variants && product.variants.length > 0) {
                product.variants.forEach(variant => {
                    const option = document.createElement('option');
                    option.value = variant.variantId;
                    option.textContent = variant.displayName;
                    chartVariantSelect.appendChild(option);
                });
                chartVariantSelect.disabled = false;
            } else {
                priceChartMessage.textContent = 'No variants available for this product.';
            }
        }
    };

    const renderPriceChart = () => {
        const productId = chartProductSelect.value;
        const variantId = chartVariantSelect.value;

        if (!productId || !variantId) {
            priceChartMessage.textContent = 'Please select both a product and a variant.';
            if (priceChart) priceChart.destroy();
            priceChart = null;
            return;
        }

        const product = products.find(p => p.id === productId);
        const variant = product ? product.variants.find(v => v.variantId === variantId) : null;

        if (!variant || !variant.priceHistory || variant.priceHistory.length === 0) {
            priceChartMessage.textContent = 'No price history available for this variant.';
            if (priceChart) priceChart.destroy();
            priceChart = null;
            return;
        }

        // Filter out duplicate consecutive prices to make the chart cleaner if needed
        // For example, if price was 10, then 10 again, then 12. Only show 10 and 12.
        const uniquePricePoints = [];
        if (variant.priceHistory.length > 0) {
            uniquePricePoints.push(variant.priceHistory[0]);
            for (let i = 1; i < variant.priceHistory.length; i++) {
                if (variant.priceHistory[i].price !== variant.priceHistory[i-1].price) {
                    uniquePricePoints.push(variant.priceHistory[i]);
                }
            }
        }

        const labels = uniquePricePoints.map(entry => new Date(entry.date).toLocaleDateString());
        const data = uniquePricePoints.map(entry => entry.price);

        priceChartMessage.textContent = ''; // Clear message

        if (priceChart) {
            priceChart.destroy(); // Destroy previous chart instance
        }

        const ctx = priceChartCanvas.getContext('2d');
        priceChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: `${variant.displayName} Price (₹)`,
                    data: data,
                    borderColor: 'rgb(75, 192, 192)',
                    tension: 0.1,
                    fill: false,
                    pointBackgroundColor: 'rgb(75, 192, 192)',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: 'rgb(75, 192, 192)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Date'
                        }
                    },
                    y: {
                        beginAtZero: false,
                        title: {
                            display: true,
                            text: 'Price (₹)'
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(context.parsed.y);
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });
    };

    // --- Custom Message/Alert Box (Replaces alert() and confirm()) ---
    const showCustomMessage = (title, message, type = 'info') => {
        // Simple Bootstrap Modal for messages
        const modalId = 'customMessageModal';
        let modalElement = document.getElementById(modalId);
        if (!modalElement) {
            modalElement = document.createElement('div');
            modalElement.classList.add('modal', 'fade');
            modalElement.id = modalId;
            modalElement.setAttribute('tabindex', '-1');
            modalElement.setAttribute('aria-labelledby', `${modalId}Label`);
            modalElement.setAttribute('aria-hidden', 'true');
            document.body.appendChild(modalElement);
        }

        let headerClass = 'bg-primary text-white';
        if (type === 'success') headerClass = 'bg-success text-white';
        else if (type === 'warning') headerClass = 'bg-warning text-dark';
        else if (type === 'danger') headerClass = 'bg-danger text-white';

        modalElement.innerHTML = `
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header ${headerClass}">
                        <h5 class="modal-title" id="${modalId}Label">${title}</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>${message}</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        `;
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
    };

    const showCustomConfirm = (title, message, onConfirm) => {
        const modalId = 'customConfirmModal';
        let modalElement = document.getElementById(modalId);
        if (!modalElement) {
            modalElement = document.createElement('div');
            modalElement.classList.add('modal', 'fade');
            modalElement.id = modalId;
            modalElement.setAttribute('tabindex', '-1');
            modalElement.setAttribute('aria-labelledby', `${modalId}Label`);
            modalElement.setAttribute('aria-hidden', 'true');
            document.body.appendChild(modalElement);
        }

        modalElement.innerHTML = `
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-warning text-dark">
                        <h5 class="modal-title" id="${modalId}Label">${title}</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>${message}</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-danger" id="confirmActionBtn">Confirm</button>
                    </div>
                </div>
            </div>
        `;
        const modal = new bootstrap.Modal(modalElement);
        modal.show();

        document.getElementById('confirmActionBtn').onclick = () => {
            onConfirm();
            modal.hide();
        };
    };


    // --- Event Listeners ---
    customerSearchInput.addEventListener('input', (e) => renderCustomerList(e.target.value));
    clearCustomerBtn.addEventListener('click', clearSelectedCustomer);
    addCustomerForm.addEventListener('submit', (e) => {
        e.preventDefault();

        // --- IMPORTANT: CHECK YOUR BROWSER'S DEVELOPER CONSOLE FOR THESE LOGS ---
        console.log('--- Debugging New Customer Addition ---');
        console.log('Raw Name Input Value:', customerNameInput.value);
        console.log('Raw Phone Input Value:', customerPhoneInput.value);
        console.log('Raw Address Input Value:', customerAddressInput.value);
        // --- END DEBUG LOGS ---

        const name = customerNameInput.value.trim();
        const phone = customerPhoneInput.value.trim();
        const address = customerAddressInput.value.trim();

        // --- MORE DEBUG LOGS AFTER TRIMMING ---
        console.log('Trimmed Name:', name);
        console.log('Trimmed Phone:', phone);
        console.log('Trimmed Address:', address);
        // --- END MORE DEBUG LOGS ---

        if (!name) {
            showCustomMessage('Warning', 'Customer Name cannot be empty.', 'warning');
            customerNameInput.focus();
            return;
        }
        if (!phone || !/^\d{10}$/.test(phone)) { // Checks for empty and exact 10 digits
            showCustomMessage('Warning', 'Please enter a valid 10-digit Phone Number.', 'warning');
            customerPhoneInput.focus();
            return;
        }

        const newCustomer = {
            id: `C${String(nextCustomerId++).padStart(3, '0')}`,
            name: name,
            phone: phone,
            address: address
        };

        console.log('New Customer Object to be saved:', newCustomer); // Final object before save

        // Basic check for duplicate phone number
        if (customers.some(c => c.phone === newCustomer.phone)) {
            showCustomMessage('Warning', 'A customer with this phone number already exists.', 'warning');
            return;
        }

        customers.push(newCustomer);
        saveCustomers(customers);
        renderCustomerList();
        selectCustomer(newCustomer);
        addCustomerModal.hide();
        addCustomerForm.reset(); // This clears the form *after* values are read and saved
        showCustomMessage('Success', 'Customer added successfully!', 'success');
        console.log('--- New Customer Addition Process Completed ---');
    });

    productSearchInput.addEventListener('input', (e) => renderProductList(e.target.value));
    clearProductSelectionBtn.addEventListener('click', clearProductSelection); // New event listener
    addProductToBillBtn.addEventListener('click', addProductToBill);
    clearBillBtn.addEventListener('click', clearCurrentBill);

    paymentAmountInput.addEventListener('input', updatePaymentDetails);
    generateBillBtn.addEventListener('click', () => generateBill(true));
    saveBillBtn.addEventListener('click', () => generateBill(false));
    printReceiptBtn.addEventListener('click', () => {
        const printContent = receiptContentDiv.innerHTML;
        const printWindow = window.open('', '', 'height=600,width=800');
        printWindow.document.write('<html><head><title>Print Bill</title>');
        printWindow.document.write('<style>');
        printWindow.document.write(`
            body { font-family: 'Courier New', Courier, monospace; font-size: 12px; margin: 0; padding: 10mm; }
            .receipt { width: 80mm; margin: 0 auto; border: 1px dashed #ccc; padding: 10px; }
            .header, .footer { text-align: center; margin-bottom: 10px; }
            .item-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
            .item-table th, .item-table td { border-bottom: 1px dashed #ccc; padding: 5px 0; text-align: left; }
            .item-table th:nth-child(2), .item-table td:nth-child(2) { text-align: center; }
            .item-table th:nth-child(3), .item-table td:nth-child(3) { text-align: right; }
            .item-table th:nth-child(4), .item-table td:nth-child(4) { text-align: right; }
            .total-section { text-align: right; margin-top: 10px; }
            .total-section div { margin-bottom: 5px; }
            .thank-you { text-align: center; margin-top: 20px; font-style: italic; }
        `);
        printWindow.document.write('</style></head><body>');
        printWindow.document.write(printContent);
        printWindow.document.close();
        printWindow.focus();
        printWindow.print();
        printWindow.onafterprint = () => printWindow.close();
    });

    // Event listener for sending bill via WhatsApp
    sendBillViaWhatsAppBtn.addEventListener('click', () => {
        if (lastGeneratedBill) {
            sendWhatsAppMessage(lastGeneratedBill.customer.phone, generateWhatsAppBillMessage(lastGeneratedBill));
        } else {
            showCustomMessage('Information', 'No bill has been generated yet to send.', 'info');
        }
    });


    addProductFormManagement.addEventListener('submit', (e) => {
        e.preventDefault();
        addProduct();
    });
    editProductForm.addEventListener('submit', (e) => {
        e.preventDefault();
        editProduct();
    });

    // When Add Product modal is shown, render category chips
    addProductModal._element.addEventListener('shown.bs.modal', () => {
        renderCategoryChips(addProductCategoryChips, currentSelectedCategoryForManagement); // Pass currently selected if applicable
    });

    // When Edit Product modal is shown, render category chips and variants
    editProductModal._element.addEventListener('shown.bs.modal', () => {
        const product = products.find(p => p.id === currentEditProductId);
        renderCategoryChips(editProductCategoryChips, product ? product.category : null);
        renderVariantChipsForProductManagement(currentEditProductId);
    });

    editCustomerForm.addEventListener('submit', (e) => {
        e.preventDefault();
        editCustomer();
    });

    logoutBtn.addEventListener('click', (e) => {
        e.preventDefault();
        // Replace confirm with custom modal
        showCustomConfirm('Logout', 'Are you sure you want to log out? This will clear local data for this session.', () => {
            localStorage.removeItem(AUTH_TOKEN_KEY);
            // Optionally, clear other data on logout if you don't want it persisted for next login
            // localStorage.removeItem('kiranaCustomers');
            // localStorage.removeItem('kiranaProducts');
            // localStorage.removeItem('kiranaNextBillId');
            // localStorage.removeItem('kiranaCustomerBills');

            window.location.href = 'login.html';
        });
    });

    // --- Reports Modal Listeners ---
    generateDailySalesReportBtn.addEventListener('click', generateDailySalesReport);
    sendDailyReportViaWhatsAppBtn.addEventListener('click', () => {
        if (lastGeneratedDailyReport) {
            sendWhatsAppMessage('', generateWhatsAppDailyReportMessage(lastGeneratedDailyReport)); // Prompt for number
        } else {
            showCustomMessage('Information', 'Please generate the daily sales report first.', 'info');
        }
    });

    generateProductSalesReportBtn.addEventListener('click', generateProductSalesReport);
    sendProductReportViaWhatsAppBtn.addEventListener('click', () => {
        if (lastGeneratedProductReport) {
            sendWhatsAppMessage('', generateWhatsAppProductReportMessage(lastGeneratedProductReport)); // Prompt for number
        } else {
            showCustomMessage('Information', 'Please generate the product sales report first.', 'info');
        }
    });

    generateCustomerHistoryReportBtn.addEventListener('click', generateCustomerHistoryReport);
    sendCustomerHistoryReportViaWhatsAppBtn.addEventListener('click', () => {
        if (lastGeneratedCustomerHistoryReport) {
            // If a customer is selected on the main billing screen, use their number. Otherwise, prompt.
            const phoneNumber = selectedCustomer ? selectedCustomer.phone : '';
            sendWhatsAppMessage(phoneNumber, generateWhatsAppCustomerHistoryReportMessage(lastGeneratedCustomerHistoryReport));
        } else {
            showCustomMessage('Information', 'Please generate the customer history report first.', 'info');
        }
    });


    // When the reports modal is shown, ensure the initial tab's content is generated
    // This makes sure the first report is ready when the modal opens
    reportsModal._element.addEventListener('shown.bs.modal', () => {
        // Automatically set current date for end date for daily report for convenience
        const today = new Date();
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(today.getDate() - 30);

        endDateInput.valueAsDate = today;
        startDateInput.valueAsDate = thirtyDaysAgo;

        productSalesReportEndDate.valueAsDate = today;
        const ninetyDaysAgoProduct = new Date();
        ninetyDaysAgoProduct.setDate(today.getDate() - 90);
        productSalesReportStartDate.valueAsDate = ninetyDaysAgoProduct;

        customerHistoryEndDate.valueAsDate = today;
        const ninetyDaysAgoCustomer = new Date();
        ninetyDaysAgoCustomer.setDate(today.getDate() - 90);
        customerHistoryStartDate.valueAsDate = ninetyDaysAgoCustomer;


        // Trigger the initial report generation for the active tab (Daily Sales by default)
        // Check which tab is active and generate its report
        const activeTab = reportsTab.querySelector('.nav-link.active');
        if (activeTab) {
            const activeTabId = activeTab.id;
            if (activeTabId === 'daily-sales-tab') {
                generateDailySalesReport();
            } else if (activeTabId === 'product-sales-tab') {
                generateProductSalesReport();
            } else if (activeTabId === 'customer-history-tab') {
                generateCustomerHistoryReport();
            } else if (activeTabId === 'price-chart-tab') {
                populateChartProductSelect(); // Populate product select for price chart
            }
        }
    });

    // Event listener for tab changes to regenerate report for the active tab
    const reportsTab = document.getElementById('reportsTab');
    reportsTab.addEventListener('shown.bs.tab', (event) => {
        const activeTabId = event.target.id;
        if (activeTabId === 'daily-sales-tab') {
            generateDailySalesReport();
        } else if (activeTabId === 'product-sales-tab') {
            generateProductSalesReport();
        } else if (activeTabId === 'customer-history-tab') {
            generateCustomerHistoryReport();
        } else if (activeTabId === 'price-chart-tab') {
            populateChartProductSelect(); // Re-populate on tab switch to clear previous selections/chart
        }
    });

    // Price Chart Listeners
    chartProductSelect.addEventListener('change', populateChartVariantSelect);
    chartVariantSelect.addEventListener('change', renderPriceChart);


    // --- Initial Renders ---
    renderCustomerList();
    renderProductList(''); // Initialize product search area correctly, with empty search term to show all products as chips
    renderBillItems();
    renderProductListManagement();
    renderCustomerListManagement();
});
</script>
</body>
</html>
