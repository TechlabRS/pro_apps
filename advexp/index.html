<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Money Tracker - Advanced Expenses Tracker v 3.10</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>

    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f0f2f5;
            color: #333;
            padding-top: 1rem;
            padding-bottom: 70px; /* Space for bottom nav */
            overscroll-behavior-y: contain;
        }
        .app-header {
            background-color: #1acfcf; color: white; padding: 1rem 0;
            text-align: center; margin-bottom: 1rem; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: sticky; top: 0; z-index: 1030;
        }
        .app-header h1 { margin-bottom: 0; font-weight: 500; font-size: 1.5rem; }
        .rtitle {
            background: linear-gradient(135deg, #bbff00 0%, #007ab3 100%);
            color: white; text-align: center;
        }
        .view-container { padding: 0 15px; }
        .view { display: none; }
        .view.active { display: block; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .card {
            border: none; border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); margin-bottom: 1.5rem;
        }
        .card-header {
            background-color: #ffffff; border-bottom: 1px solid #e9ecef; font-weight: 500;
            border-top-left-radius: 0.75rem; border-top-right-radius: 0.75rem;
            padding: 0.75rem 1.25rem;
        }
        .card-body { padding: 1rem; }
        .total-balance-card {
            background: linear-gradient(135deg, #0fb7d4 0%, #bbff00  100%);
            color: white; text-align: center;
        }
        .total-balance-card h2 { font-size: 1.1rem; margin-bottom: 0.3rem; opacity: 0.9; }
        .total-balance-card .balance-amount { font-size: 2rem; font-weight: 700; }
        .account-balance-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0.6rem 0.5rem; border-bottom: 1px solid #f0f2f5; font-size: 0.85rem;
        }
        .account-balance-item:last-child { border-bottom: none; }
        .account-balance-item .account-name { font-weight: 500; color: #495057; }
        .account-balance-item .account-value { font-weight: 700; color: #007bff; }
        .account-balance-item .account-value.hidden-balance .fas { font-size: 1em; }

        .balance-visibility-toggle { margin-bottom: 1rem; display: flex; justify-content: flex-end; }
        .balance-visibility-toggle .btn { font-size: 0.8rem; padding: 0.3rem 0.6rem; }

        .form-control, .custom-select { border-radius: 0.5rem; border: 1px solid #ced4da; font-size:0.9rem; }
        .form-control:focus, .custom-select:focus {
            border-color: #007bff; box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }
        .btn { border-radius: 0.5rem; font-weight:500; }

        /* Transaction List Item Styling */
        .transaction-list .list-group-item {
            display: flex; justify-content: space-between; align-items: center;
            border-radius: 0.5rem; margin-bottom: 0.75rem; padding: 0.85rem 1.25rem;
            border: 1px solid #e0e0e0; background-color: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: relative;
        }
        .transaction-list .list-item-icon { font-size: 1.5rem; margin-right: 1rem; width: 40px; text-align: center; }
        .transaction-income .list-item-icon { color: #28a745; }
        .transaction-spend .list-item-icon { color: #dc3545; }
        .transaction-transfer .list-item-icon { color: #17a2b8; }
        .transaction-list .list-item-details { flex-grow: 1; display: flex; flex-direction: column; }
        .transaction-list .main-info { font-weight: 500; font-size: 0.9rem; }
        .transaction-list .category-info { font-size: 0.8rem; color: #555; font-weight: 500; }
        .transaction-list .description-info { font-size: 0.75rem; color: #777; font-style: italic; margin-left: 5px;}
        .transaction-list .sub-info { font-size: 0.75rem; color: #6c757d; margin-top: 2px; }
        .transaction-list .account-info { font-size: 0.7rem; color: #6c757d; font-style: italic; }
        .transaction-list .list-item-amount-actions { display: flex; flex-direction: column; align-items: flex-end; }
        .transaction-list .amount { font-weight: 700; font-size: 0.95rem; margin-bottom: 5px; }
        .transaction-income .amount { color: #28a745; }
        .transaction-spend .amount { color: #dc3545; }
        .transaction-transfer .amount { color: #17a2b8; }
        .transaction-list .item-actions { display: flex; gap: 8px; margin-top: 5px; }
        .transaction-list .action-btn { font-size: 0.75rem; padding: 0.2rem 0.4rem; border-radius: 0.25rem; cursor: pointer; }
        .transaction-list .edit-btn { background-color: #ffc107; color: #333; border: none; }
        .transaction-list .edit-btn:hover { background-color: #e0a800; }
        .transaction-list .delete-btn { background-color: #dc3545; color: white; border: none; }
        .transaction-list .delete-btn:hover { background-color: #c82333; }

        .investment-list .list-group-item {
            display: flex; justify-content: space-between; align-items: flex-start;
            border-radius: 0.5rem; margin-bottom: 0.5rem; padding: 0.75rem 1.25rem;
            border: 1px solid #e9ecef; position: relative;
        }
        .investment-list .list-group-item.redeemed-investment { background-color: #f8f9fa; opacity: 0.7; }
        .investment-item-actions { position: absolute; top: 5px; right: 5px; display: flex; gap: 5px; }
        .investment-item-actions .btn-sm { padding: 0.15rem 0.3rem; font-size: 0.7rem;}
        .list-item-content .main-info { font-weight: 500; }
        .list-item-content .sub-info { font-size: 0.8rem; color: #6c757d; }
        .list-item-content .account-info, .list-item-content .investment-details { font-size: 0.75rem; color: #6c757d; font-style: italic; }
        .list-item-amount .amount { font-weight: 700; }
        .list-item-amount .current-value-label { font-size: 0.7rem; color: #6c757d; display:block; }
        .investment-item .amount { color: #20c997; }
        .investment-item .profit { color: #28a745; }
        .investment-item .loss { color: #dc3545; }
        .status-badge { font-size: 0.7rem; font-weight: bold; padding: 0.2rem 0.4rem; border-radius: 0.25rem; color: white; }
        .status-active { background-color: #28a745; }
        .status-redeemed { background-color: #6c757d; }

        #transactionModal .form-group-account, #transactionModal .form-group-transfer, #transactionModal .form-group-category-chips { display: none; }
        .category-chips-container { margin-bottom: 1rem; max-height:150px; overflow-y:auto; }
        .category-chip {
            display: inline-block; padding: 0.3rem 0.6rem; margin: 0.2rem;
            font-size: 0.8rem; border-radius: 1rem; background-color: #e9ecef;
            color: #495057; cursor: pointer; border: 1px solid #ced4da;
            transition: background-color 0.2s, color 0.2s;
        }
        .category-chip.active { background-color: #007bff; color: white; border-color: #007bff;}
        .category-chip:hover:not(.active) { background-color: #d1d9e0; }

        .fab {
            position: fixed; bottom: 80px; right: 20px; width: 56px; height: 56px;
            background-color: #007bff; color: white; border-radius: 50%; text-align: center;
            line-height: 56px; font-size: 22px; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            cursor: pointer; z-index: 1050;
        }
        .fab:hover { background-color: #0056b3; }
        .investment-actions .btn { margin-right: 0.5rem; margin-bottom: 0.5rem; }
        .modal-title { font-weight: 500; font-size: 1.1rem; }

        /* New Filter Styles */
        .new-filter-controls .form-control, .new-filter-controls .custom-select {
            font-size: 0.85rem;
            height: auto;
            padding: 0.375rem 0.75rem;
        }
        .new-filter-controls {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }
        .new-filter-controls .search-filter-group {
            display: flex;
            gap: 0.5rem;
        }
         .new-filter-controls .search-filter-group input[type="text"],
         .new-filter-controls .search-filter-group input[type="number"] {
            flex-grow: 1;
        }
         .new-filter-controls .search-filter-group input[type="number"] {
            max-width: 150px;
        }
        .new-filter-controls .select-filters-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .new-filter-controls .select-filters-group .custom-select,
        .new-filter-controls .select-filters-group .btn {
            flex-grow: 1;
            min-width: 120px;
        }
         .new-filter-controls .select-filters-group .btn {
            flex-grow: 0;
        }

        /* Filtered Totals Styling */
        #filteredTotalsContainer {
            display: flex;
            justify-content: space-around;
            padding: 0.5rem 0;
            margin-bottom: 1rem;
            background-color: #e9ecef;
            border-radius: 0.5rem;
            font-size: 0.8rem;
        }
        .filtered-total-item {
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            color: white;
            font-weight: 500;
        }
        .filtered-total-income { background-color: #28a745; }
        .filtered-total-spend { background-color: #dc3545; }
        .filtered-total-transfer { background-color: #17a2b8; }
        .filtered-total-net { background-color: #6c757d; }


        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            display: flex; justify-content: space-around; align-items: center;
            background-color: #ffffff; border-top: 1px solid #e0e0e0;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.05);
            padding: 5px 0; height: 60px; z-index: 1040;
        }
        .nav-item {
            flex: 1; text-align: center; color: #888; cursor: pointer; padding: 5px 0;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-size: 0.7rem;
        }
        .nav-item i { font-size: 1.2rem; margin-bottom: 2px; }
        .nav-item.active { color: #007bff; }
        .nav-item:hover:not(.active) { color: #555; }

        .chart-container { min-height: 300px; margin-bottom: 1.5rem; }
        .settings-actions .btn { margin-top:0.5rem; }
        .profit-loss-info { font-size: 0.9rem; font-weight: bold; margin-top: 0.5rem; }
    </style>
</head>
<body>
    <header class="app-header rtitle"><h1 id="appname">RaGhaS Money Expense Tracker/Tool</h1></header>
    <header class="app-header"><h1 id="appTitle">Dashboard</h1></header>

    <div class="view-container">
        <div class="view active" id="homeView">
            <div class="card total-balance-card">
                <div class="card-body">
                    <h2>Total Balance</h2>
                    <div class="balance-amount" id="totalBalance">₹0.00</div>
                </div>
            </div>
            <div class="balance-visibility-toggle">
                <button class="btn btn-outline-secondary btn-sm" id="toggleBalanceVisibility">
                    <i class="fas fa-eye"></i> Hide Amounts
                </button>
            </div>
            <div class="card account-balances-card">
                <div class="card-header">Account Balances</div>
                <div class="card-body" id="accountBalancesList"></div>
            </div>
            <div class="card">
                <div class="card-header">Recent Transactions</div>
                <ul class="list-group list-group-flush" id="recentTransactionsListHome">
                     <li class="list-group-item text-center text-muted">No recent transactions.</li>
                </ul>
            </div>
            <div class="card">
                <div class="card-header">Investment Portfolio Overview</div>
                <div class="card-body" id="investmentSummaryHome">
                    <p class="text-center text-muted">No active investments yet.</p>
                </div>
            </div>
        </div>

        <div class="view" id="transactionsView">
            <div class="card">
                <div class="card-header">Transaction History</div>
                <div class="card-body">
                    <div class="new-filter-controls">
                        <div class="search-filter-group">
                            <input id="txSearchInput" type="text" placeholder="Search description, category..." class="form-control" />
                            <input id="txAmountFilter" type="number" placeholder="Amount (₹)" class="form-control" step="0.01" />
                        </div>
                        <div class="select-filters-group">
                            <select id="txMonthFilter" class="custom-select"><option value="">All Months</option></select>
                            <select id="txYearFilter" class="custom-select"><option value="">All Years</option></select>
                            <select id="txTypeFilter" class="custom-select">
                                <option value="">All Types</option>
                                <option value="income">Income</option>
                                <option value="spend">Spend</option>
                                <option value="transfer">Transfer</option>
                                <option value="investment_purchase">Investment Purchase</option>
                                <option value="investment_sale">Investment Sale</option>
                            </select>
                            <button class="btn btn-sm btn-secondary" id="txClearFiltersBtn"><i class="fas fa-times"></i> Clear</button>
                        </div>
                    </div>
                     <div id="filteredTotalsContainer" style="display: none;">
                        </div>
                    <ul class="list-group list-group-flush transaction-list" id="transactionList">
                        <li class="list-group-item text-center text-muted" id="noTransactionsMessage">No transactions yet.</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="view" id="chartsView">
            <div class="card">
                <div class="card-header">Income vs. Spend Overview</div>
                <div class="card-body chart-container">
                    <canvas id="incomeSpendChart"></canvas>
                    <p id="noIncomeSpendData" class="text-center text-muted" style="display:none;">Not enough data for Income vs. Spend chart.</p>
                </div>
            </div>
            <div class="card">
                <div class="card-header">Investment Portfolio Distribution</div>
                <div class="card-body chart-container">
                    <canvas id="investmentPortfolioChart"></canvas>
                    <p id="noInvestmentPortfolioData" class="text-center text-muted" style="display:none;">No active investments to display in portfolio chart.</p>
                </div>
            </div>
            <div class="card">
                <div class="card-header">Spend Category Breakdown</div>
                <div class="card-body chart-container">
                    <canvas id="spendCategoryChart"></canvas>
                    <p id="noSpendDataForCategoryChart" class="text-center text-muted" style="display:none;">Not enough spend data to display category chart.</p>
                </div>
            </div>
        </div>

        <div class="view" id="investmentsView">
            <div class="card">
                <div class="card-header">Manage Investments</div>
                <div class="card-body investment-actions">
                    <button class="btn btn-outline-warning btn-sm open-investment-modal" data-type="stock"><i class="fas fa-chart-line"></i> Add Stock</button>
                    <button class="btn btn-outline-info btn-sm open-investment-modal" data-type="mf"><i class="fas fa-umbrella-beach"></i> Add MF</button>
                    <button class="btn btn-outline-success btn-sm open-investment-modal" data-type="fd"><i class="fas fa-piggy-bank"></i> Add FD</button>
                    <button class="btn btn-outline-primary btn-sm open-investment-modal" data-type="postal"><i class="fas fa-envelope"></i> Add Postal</button>
                </div>
            </div>
            <div class="card">
                <div class="card-header">My Investments Portfolio</div>
                <ul class="list-group list-group-flush investment-list" id="investmentList">
                    <li class="list-group-item text-center text-muted" id="noInvestmentsMessage">No investments yet.</li>
                </ul>
            </div>
        </div>

        <div class="view" id="settingsView">
            <div class="card">
                <div class="card-header">Data Management</div>
                <div class="card-body settings-actions">
                    <button class="btn btn-info btn-block" id="exportDataBtn"><i class="fas fa-file-export"></i> Export Data</button>
                    <button class="btn btn-warning btn-block" id="importDataTriggerBtn"><i class="fas fa-file-import"></i> Import Data</button>
                    <input type="file" id="importFile" accept=".json" style="display: none;">
                    <button class="btn btn-danger btn-block mt-3" id="resetDataBtn"><i class="fas fa-trash-restore"></i> Reset All Data</button>
                </div>
            </div>
             <div class="card mt-3">
                <div class="card-header">App Info</div>
                <div class="card-body">
                    <p class="text-muted text-center" id="appVersionInfo">Money Tracker - Adavanced Expenses Tracker v 3.10</p>
                    <p class="text-muted text-center">&copy; 2024-2025. RaGhaS AET </p>
                </div>
            </div>
        </div>
    </div>

    <div class="fab" id="openTransactionModalFab"><i class="fas fa-plus"></i></div>

    <nav class="bottom-nav">
        <div class="nav-item active" data-view="homeView" data-title="Dashboard"><i class="fas fa-home"></i> Home</div>
        <div class="nav-item" data-view="transactionsView" data-title="Transactions"><i class="fas fa-list-alt"></i> Transactions</div>
        <div class="nav-item" data-view="chartsView" data-title="Charts"><i class="fas fa-chart-pie"></i> Charts</div>
        <div class="nav-item" data-view="investmentsView" data-title="Investments"><i class="fas fa-piggy-bank"></i> Investments</div>
        <div class="nav-item" data-view="settingsView" data-title="Settings"><i class="fas fa-cog"></i> Settings</div>
    </nav>

    <div class="modal fade" id="transactionModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="transactionModalTitle">Add New Transaction</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="transactionForm">
                        <input type="hidden" id="editingTransactionId">
                        <div class="form-group">
                            <label for="transactionType">Type</label>
                            <select class="custom-select" id="transactionType" required>
                                <option value="income">Income</option>
                                <option value="spend">Spend</option>
                                <option value="transfer">Transfer</option>
                            </select>
                        </div>
                        <div class="form-group form-group-category-chips">
                            <label>Category</label>
                            <div class="category-chips-container" id="categoryChipsContainer"></div>
                        </div>
                        <div class="form-group form-group-account">
                            <label for="transactionAccount">Account</label>
                            <select class="custom-select" id="transactionAccount"></select>
                        </div>
                        <div class="form-group form-group-transfer">
                            <label for="transferFromAccount">From Account</label>
                            <select class="custom-select" id="transferFromAccount"></select>
                        </div>
                        <div class="form-group form-group-transfer">
                            <label for="transferToAccount">To Account</label>
                            <select class="custom-select" id="transferToAccount"></select>
                        </div>
                        <div class="form-group">
                            <label for="transactionDescription" id="transactionDescriptionLabel">Description</label>
                            <input type="text" class="form-control" id="transactionDescription" placeholder="e.g., Salary, Coffee" required>
                        </div>
                        <div class="form-group">
                            <label for="transactionAmount">Amount (₹)</label>
                            <input type="number" class="form-control" id="transactionAmount" placeholder="0.00" step="0.01" min="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="transactionDate">Date</label>
                            <input type="date" class="form-control" id="transactionDate" required>
                        </div>
                        <input type="hidden" id="selectedCategoryInput">
                        <button type="submit" class="btn btn-primary btn-block" id="transactionSubmitBtn">Add Transaction</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="investmentModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Add New Investment</h5><button type="button" class="close" data-dismiss="modal" aria-label="Close">&times;</button></div>
            <div class="modal-body"><form id="investmentForm">
                <input type="hidden" id="investmentId"><div class="form-group"><label for="investmentType">Type</label><select class="custom-select" id="investmentType" required><option value="stock">Stock</option><option value="mf">Mutual Fund</option><option value="fd">Fixed Deposit</option><option value="postal">Postal</option></select></div>
                <div class="form-group"><label for="investmentDescription">Description</label><input type="text" class="form-control" id="investmentDescription" required></div><div class="form-group"><label for="investmentDate">Date</label><input type="date" class="form-control" id="investmentDate" required></div>
                <div class="form-group"><label for="investmentAmount">Amount Invested (₹)</label><input type="number" class="form-control" id="investmentAmount" step="0.01" min="0.01" required></div>
                <div class="form-group"><label for="investmentSourceAccount">Source Account</label><select class="custom-select" id="investmentSourceAccount" required></select></div>
                <div class="form-group"><label for="investmentMaturity">Maturity Info (Optional)</label><input type="text" class="form-control" id="investmentMaturity"></div><button type="submit" class="btn btn-success btn-block">Save Investment</button>
            </form></div></div></div>
    </div>

    <div class="modal fade" id="updateInvestmentValueModal" tabindex="-1" aria-hidden="true"><div class="modal-dialog modal-dialog-centered"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Update Investment Value</h5><button type="button" class="close" data-dismiss="modal" aria-label="Close">&times;</button></div>
        <div class="modal-body"><form id="updateInvestmentValueForm">
            <input type="hidden" id="updateValueInvestmentId"><p>Investment: <strong id="updateValueInvestmentName"></strong></p>
            <div class="form-group"><label for="investmentCurrentValue">New Current Value (₹)</label><input type="number" class="form-control" id="investmentCurrentValue" step="0.01" min="0" required></div>
            <button type="submit" class="btn btn-primary btn-block">Update Value</button>
        </form></div></div></div>
    </div>

    <div class="modal fade" id="redeemInvestmentModal" tabindex="-1" aria-hidden="true"><div class="modal-dialog modal-dialog-centered"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Redeem Investment</h5><button type="button" class="close" data-dismiss="modal" aria-label="Close">&times;</button></div>
        <div class="modal-body"><form id="redeemInvestmentForm">
            <input type="hidden" id="redeemInvestmentId"><p>Investment: <strong id="redeemInvestmentName"></strong></p><p>Initial Cost: <strong id="redeemInvestmentInitialCost"></strong></p>
            <div class="form-group"><label for="investmentRedeemedAmount">Amount Received from Redemption (₹)</label><input type="number" class="form-control" id="investmentRedeemedAmount" step="0.01" min="0.01" required></div>
            <div class="form-group"><label for="investmentRedemptionDate">Redemption Date</label><input type="date" class="form-control" id="investmentRedemptionDate" required></div>
            <div class="form-group"><label for="redemptionDepositAccount">Deposit to Account</label><select class="custom-select" id="redemptionDepositAccount" required></select></div>
            <div id="redeemProfitLossInfo" class="profit-loss-info text-center mb-2"></div><button type="submit" class="btn btn-success btn-block">Confirm Redemption</button>
        </form></div></div></div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- DOM Elements ---
    const appTitleEl = document.getElementById('appTitle');
    const views = document.querySelectorAll('.view');
    const navItems = document.querySelectorAll('.bottom-nav .nav-item');
    const recentTransactionsListHomeEl = document.getElementById('recentTransactionsListHome');
    const investmentSummaryHomeEl = document.getElementById('investmentSummaryHome');
    
    const spendCategoryChartCanvas = document.getElementById('spendCategoryChart')?.getContext('2d');
    const noSpendDataForCategoryChartEl = document.getElementById('noSpendDataForCategoryChart');
    const incomeSpendChartCanvas = document.getElementById('incomeSpendChart')?.getContext('2d');
    const noIncomeSpendDataEl = document.getElementById('noIncomeSpendData');
    const investmentPortfolioChartCanvas = document.getElementById('investmentPortfolioChart')?.getContext('2d');
    const noInvestmentPortfolioDataEl = document.getElementById('noInvestmentPortfolioData');

    const exportDataBtn = document.getElementById('exportDataBtn');
    const importFileEl = document.getElementById('importFile');
    const importDataTriggerBtn = document.getElementById('importDataTriggerBtn');
    const resetDataBtn = document.getElementById('resetDataBtn');
    const transactionForm = document.getElementById('transactionForm');
    const transactionListEl = document.getElementById('transactionList');
    const totalBalanceEl = document.getElementById('totalBalance');
    const transactionDateEl = document.getElementById('transactionDate');
    const noTransactionsMessageEl = document.getElementById('noTransactionsMessage');
    const transactionTypeEl = document.getElementById('transactionType');
    const accountGroupEl = document.querySelector('#transactionModal .form-group-account');
    const transferGroupEls = document.querySelectorAll('#transactionModal .form-group-transfer');
    const categoryChipsGroupEl = document.querySelector('#transactionModal .form-group-category-chips');
    const categoryChipsContainerEl = document.getElementById('categoryChipsContainer');
    const transactionDescriptionLabelEl = document.getElementById('transactionDescriptionLabel');
    const selectedCategoryInputEl = document.getElementById('selectedCategoryInput');
    const accountBalancesListEl = document.getElementById('accountBalancesList');
    const toggleBalanceVisibilityBtn = document.getElementById('toggleBalanceVisibility');
    const investmentForm = document.getElementById('investmentForm');
    const investmentListEl = document.getElementById('investmentList');
    const noInvestmentsMessageEl = document.getElementById('noInvestmentsMessage');
    const investmentModalJQ = $('#investmentModal');
    const transactionModalJQ = $('#transactionModal');
    const investmentTypeSelect = document.getElementById('investmentType');
    const investmentDateEl = document.getElementById('investmentDate');
    const investmentSourceAccountEl = document.getElementById('investmentSourceAccount');
    
    const txSearchInputEl = document.getElementById('txSearchInput');
    const txAmountFilterEl = document.getElementById('txAmountFilter');
    const txMonthFilterEl = document.getElementById('txMonthFilter');
    const txYearFilterEl = document.getElementById('txYearFilter');
    const txTypeFilterEl = document.getElementById('txTypeFilter');
    const txClearFiltersBtnEl = document.getElementById('txClearFiltersBtn');
    const filteredTotalsContainerEl = document.getElementById('filteredTotalsContainer'); // For filtered totals

    const fabOpenTransactionModal = document.getElementById('openTransactionModalFab');
    const transactionModalTitleEl = document.getElementById('transactionModalTitle');
    const transactionSubmitBtnEl = document.getElementById('transactionSubmitBtn');
    const editingTransactionIdEl = document.getElementById('editingTransactionId');
    const appVersionInfoEl = document.getElementById('appVersionInfo');

    const updateInvestmentValueForm = document.getElementById('updateInvestmentValueForm');
    const updateValueInvestmentIdEl = document.getElementById('updateValueInvestmentId');
    const updateValueInvestmentNameEl = document.getElementById('updateValueInvestmentName');
    const investmentCurrentValueEl = document.getElementById('investmentCurrentValue');
    const redeemInvestmentForm = document.getElementById('redeemInvestmentForm');
    const redeemInvestmentIdEl = document.getElementById('redeemInvestmentId');
    const redeemInvestmentNameEl = document.getElementById('redeemInvestmentName');
    const redeemInvestmentInitialCostEl = document.getElementById('redeemInvestmentInitialCost');
    const investmentRedeemedAmountEl = document.getElementById('investmentRedeemedAmount');
    const investmentRedemptionDateEl = document.getElementById('investmentRedemptionDate');
    const redemptionDepositAccountEl = document.getElementById('redemptionDepositAccount');
    const redeemProfitLossInfoEl = document.getElementById('redeemProfitLossInfo');

    // --- App State & Config ---
    const APP_VERSION = "advexpv3.10";
    const LOCAL_STORAGE_TRANSACTIONS_KEY = `transactions_adv_${APP_VERSION}_filters_v4`; // Incremented for new features
    const LOCAL_STORAGE_INVESTMENTS_KEY = `investments_adv_${APP_VERSION}_filters_v4`;

    const accountNames = { cash: 'Cash', sbi: 'SBI', hdfc: 'HDFC', icici: 'ICICI' };
    const accountKeys = Object.keys(accountNames);
    const spendCategories = [
        'CC Bills', 'Cloths', 'Education', 'Entertainment', 'EMI', 'Fuel', 'Foods & Drinks', 'Fruits', 'Travel', 'Shopping',
        'Parties', 'Recharge/Bills', 'Vacation', 'Gifts', 'Groceries', 'Homes & Utilities', 'Health & Medicine', 'Insurance', 'Investment Expense', 'Labs & Tests', 'Maintenance', 'Personal Care', 'Pets', 'Rent', 'Subscriptions', 'Transfer', 'Others'
    ];
    const investmentRelatedCategories = ['Investment Expense', 'Investment Income'];

    let balancesVisible = true;
    let transactions = JSON.parse(localStorage.getItem(LOCAL_STORAGE_TRANSACTIONS_KEY)) || [];
    let investments = JSON.parse(localStorage.getItem(LOCAL_STORAGE_INVESTMENTS_KEY)) || [];
    const investmentTypeNames = { stock: 'Stock', mf: 'Mutual Fund', fd: 'Fixed Deposit', postal: 'Postal' };
    
    let spendCategoryChartInstance = null;
    let incomeSpendChartInstance = null;
    let investmentPortfolioChartInstance = null;

    // --- Utility Functions ---
    function saveTransactions() { localStorage.setItem(LOCAL_STORAGE_TRANSACTIONS_KEY, JSON.stringify(transactions)); }
    function saveInvestments() { localStorage.setItem(LOCAL_STORAGE_INVESTMENTS_KEY, JSON.stringify(investments)); }
    function formatDate(dateString) { return new Date(dateString).toLocaleDateString('en-CA'); }
    function displayDate(dateString) { return new Date(dateString).toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });}
    function formatCurrency(amount) { return new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(amount); }
    function setDefaultDate(dateElement) { if(dateElement && !dateElement.value) dateElement.valueAsDate = new Date(); }
    function populateAccountDropdown(selectElement, selectedValue = "") {
        if (!selectElement) return;
        selectElement.innerHTML = '<option value="">-- Select Account --</option>';
        accountKeys.forEach(key => {
            const option = document.createElement('option');
            option.value = key; option.textContent = accountNames[key];
            if (key === selectedValue) option.selected = true;
            selectElement.appendChild(option);
        });
    }

    // --- View Management ---
    function showView(viewId, title) {
        views.forEach(view => view.classList.remove('active'));
        document.getElementById(viewId)?.classList.add('active');
        navItems.forEach(item => item.classList.toggle('active', item.dataset.view === viewId));
        if(appTitleEl) appTitleEl.textContent = title;
        
        if (viewId === 'chartsView') {
            renderSpendCategoryChart();
            renderIncomeSpendChart();
            renderInvestmentPortfolioChart();
        }
        if (viewId === 'homeView') renderHomePageSummaries();
        if (viewId === 'investmentsView') renderInvestmentList();
        if (viewId === 'transactionsView') renderFullTransactionList();
    }
    navItems.forEach(item => { item.addEventListener('click', () => { showView(item.dataset.view, item.dataset.title); }); });

    // --- Chart Rendering ---
    function renderSpendCategoryChart() {
        if (!spendCategoryChartCanvas) return;
        const categorySpends = {};
        transactions.filter(t => t.type === 'spend' && t.category && !investmentRelatedCategories.includes(t.category))
            .forEach(t => { categorySpends[t.category] = (categorySpends[t.category] || 0) + t.amount; });
        
        const labels = Object.keys(categorySpends);
        const data = Object.values(categorySpends);
        const backgroundColors = labels.map((_, index) => `hsl(${(index * 45 + 10) % 360}, 70%, 65%)`);

        if (noSpendDataForCategoryChartEl) noSpendDataForCategoryChartEl.style.display = (labels.length === 0) ? 'block' : 'none';
        if (spendCategoryChartCanvas.parentElement) spendCategoryChartCanvas.parentElement.style.display = (labels.length > 0) ? 'block' : 'none';
        if (labels.length === 0) { if(spendCategoryChartInstance) spendCategoryChartInstance.destroy(); spendCategoryChartInstance = null; return; }
        if (spendCategoryChartInstance) spendCategoryChartInstance.destroy();
        
        spendCategoryChartInstance = new Chart(spendCategoryChartCanvas, {
            type: 'doughnut',
            data: { labels: labels, datasets: [{ label: 'Spend by Category', data: data, backgroundColor: backgroundColors, borderColor: '#fff', borderWidth: 2, hoverOffset: 8 }] },
            options: { responsive: true, maintainAspectRatio: false, animation: { animateScale: true, animateRotate: true },
                plugins: { legend: { position: 'bottom', labels: { font: { size: 10 }, boxWidth:15, padding:10 } },
                    tooltip: { callbacks: { label: context => `${context.label || ''}: ${formatCurrency(context.parsed)} (${((context.parsed / context.dataset.data.reduce((a,b)=>a+b,0)) * 100).toFixed(1)}%)` }}
                }
            }
        });
    }

    function renderIncomeSpendChart() {
        if (!incomeSpendChartCanvas) return;
        let totalIncome = 0;
        let totalSpend = 0;
        transactions.forEach(t => {
            if (t.type === 'income') totalIncome += t.amount;
            else if (t.type === 'spend') totalSpend += t.amount;
        });

        if (noIncomeSpendDataEl) noIncomeSpendDataEl.style.display = (totalIncome === 0 && totalSpend === 0) ? 'block' : 'none';
        if (incomeSpendChartCanvas.parentElement) incomeSpendChartCanvas.parentElement.style.display = (totalIncome > 0 || totalSpend > 0) ? 'block' : 'none';
        if (totalIncome === 0 && totalSpend === 0) { if (incomeSpendChartInstance) incomeSpendChartInstance.destroy(); incomeSpendChartInstance = null; return; }
        if (incomeSpendChartInstance) incomeSpendChartInstance.destroy();

        incomeSpendChartInstance = new Chart(incomeSpendChartCanvas, {
            type: 'bar',
            data: {
                labels: ['Total Income', 'Total Spend'],
                datasets: [{
                    label: 'Amount (₹)',
                    data: [totalIncome, totalSpend],
                    backgroundColor: ['rgba(75, 192, 192, 0.6)', 'rgba(255, 99, 132, 0.6)'],
                    borderColor: ['rgba(75, 192, 192, 1)', 'rgba(255, 99, 132, 1)'],
                    borderWidth: 1
                }]
            },
            options: { responsive: true, maintainAspectRatio: false,
                scales: { y: { beginAtZero: true, ticks: { callback: value => formatCurrency(value) } } },
                plugins: { legend: { display: false }, tooltip: { callbacks: { label: context => `${context.label}: ${formatCurrency(context.parsed.y)}` }} }
            }
        });
    }

    function renderInvestmentPortfolioChart() {
        if (!investmentPortfolioChartCanvas) return;
        const activeInvestments = investments.filter(inv => inv.status === 'active');
        const portfolioData = {};

        activeInvestments.forEach(inv => {
            const typeName = investmentTypeNames[inv.type] || 'Other';
            const value = inv.currentValue !== null && inv.currentValue !== undefined ? inv.currentValue : inv.amount;
            portfolioData[typeName] = (portfolioData[typeName] || 0) + value;
        });

        const labels = Object.keys(portfolioData);
        const data = Object.values(portfolioData);
        const backgroundColors = labels.map((_, index) => `hsl(${(index * 60 + 30) % 360}, 65%, 60%)`);

        if (noInvestmentPortfolioDataEl) noInvestmentPortfolioDataEl.style.display = (labels.length === 0) ? 'block' : 'none';
        if (investmentPortfolioChartCanvas.parentElement) investmentPortfolioChartCanvas.parentElement.style.display = (labels.length > 0) ? 'block' : 'none';
        if (labels.length === 0) { if (investmentPortfolioChartInstance) investmentPortfolioChartInstance.destroy(); investmentPortfolioChartInstance = null; return; }
        if (investmentPortfolioChartInstance) investmentPortfolioChartInstance.destroy();

        investmentPortfolioChartInstance = new Chart(investmentPortfolioChartCanvas, {
            type: 'pie',
            data: { labels: labels, datasets: [{ label: 'Investment Value', data: data, backgroundColor: backgroundColors, borderColor: '#fff', borderWidth: 2, hoverOffset: 8 }] },
            options: { responsive: true, maintainAspectRatio: false, animation: { animateScale: true, animateRotate: true },
                plugins: { legend: { position: 'bottom', labels: { font: { size: 10 }, boxWidth:15, padding:10 } },
                    tooltip: { callbacks: { label: context => `${context.label || ''}: ${formatCurrency(context.parsed)} (${((context.parsed / context.dataset.data.reduce((a,b)=>a+b,0)) * 100).toFixed(1)}%)` }}
                }
            }
        });
    }

    // --- Data Management Functions (Export, Import, Reset) ---
    function exportData() {
        const dataToExport = { transactions, investments, appVersion: `money_tracker_${APP_VERSION}_export_v1.5`, exportDate: new Date().toISOString() }; // Incremented export version
        const jsonData = JSON.stringify(dataToExport, null, 2);
        const blob = new Blob([jsonData], { type: 'application/json' });
        const url = URL.createObjectURL(blob); const a = document.createElement('a');
        a.href = url; a.download = `money_tracker_data_${formatDate(new Date().toISOString().slice(0,10))}.json`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
        alert('Data exported successfully!');
    }

    function importData(event) {
        const file = event.target.files[0]; if (!file) return;
        if (file.type !== "application/json") { alert("Invalid file type."); return; }
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const importedData = JSON.parse(e.target.result);
                const isValidTransaction = (tr) => typeof tr.id === 'number' && typeof tr.type === 'string' && typeof tr.amount === 'number';
                const isValidInvestment = (inv) => typeof inv.id === 'number' && typeof inv.description === 'string' && typeof inv.amount === 'number';

                if (importedData && Array.isArray(importedData.transactions) && importedData.transactions.every(isValidTransaction) &&
                    Array.isArray(importedData.investments) && importedData.investments.every(isValidInvestment)) {
                    
                    if (confirm('This will merge the imported data with your current data. New items will be added. Items with existing IDs will be skipped. Continue?')) {
                        let newTransactionsAdded = 0;
                        let skippedTransactions = 0;
                        let newInvestmentsAdded = 0;
                        let skippedInvestments = 0;

                        const existingTransactionIds = new Set(transactions.map(t => t.id));
                        importedData.transactions.forEach(importedTx => {
                            if (!existingTransactionIds.has(importedTx.id)) {
                                transactions.push({...importedTx, amount: parseFloat(importedTx.amount)});
                                newTransactionsAdded++;
                            } else {
                                skippedTransactions++;
                            }
                        });

                        const existingInvestmentIds = new Set(investments.map(inv => inv.id));
                        importedData.investments.forEach(importedInv => {
                            if (!existingInvestmentIds.has(importedInv.id)) {
                                investments.push({
                                    ...importedInv,
                                    amount: parseFloat(importedInv.amount),
                                    currentValue: importedInv.currentValue ? parseFloat(importedInv.currentValue) : null,
                                    redeemedAmount: importedInv.redeemedAmount ? parseFloat(importedInv.redeemedAmount) : null,
                                    profitOrLoss: importedInv.profitOrLoss ? parseFloat(importedInv.profitOrLoss) : null,
                                    status: importedInv.status || 'active'
                                });
                                newInvestmentsAdded++;
                            } else {
                                skippedInvestments++;
                            }
                        });

                        saveTransactions();
                        saveInvestments();
                        renderAllContent();
                        populateFilters();
                        showView('homeView', 'Dashboard');
                        alert(`Data merged successfully!\nNew Transactions: ${newTransactionsAdded} (Skipped: ${skippedTransactions})\nNew Investments: ${newInvestmentsAdded} (Skipped: ${skippedInvestments})`);
                    }
                } else { alert('Invalid data structure in imported file. Please check the file format.'); }
            } catch (error) { console.error("Import Error:", error); alert('Error importing data. The file might be corrupted or not in the correct JSON format.'); }
            finally { importFileEl.value = ''; }
        };
        reader.readAsText(file);
    }

    function handleResetData() {
        if (confirm('ARE YOU SURE you want to reset all data? This action cannot be undone and will delete all transactions and investments.')) {
            if (confirm('SECOND CONFIRMATION: All data will be permanently deleted. Proceed?')) {
                transactions = [];
                investments = [];
                saveTransactions();
                saveInvestments();
                renderAllContent();
                populateFilters(); 
                alert('All application data has been reset.');
                showView('homeView', 'Dashboard');
            }
        }
    }
    if (exportDataBtn) exportDataBtn.addEventListener('click', exportData);
    if (importDataTriggerBtn) importDataTriggerBtn.addEventListener('click', () => importFileEl.click());
    if (importFileEl) importFileEl.addEventListener('change', importData);
    if (resetDataBtn) resetDataBtn.addEventListener('click', handleResetData);


    // --- Category Chips & Transaction Form Logic ---
    function populateCategoryChips(selectedCategory = null) {
        if (!categoryChipsContainerEl) return; categoryChipsContainerEl.innerHTML = '';
        spendCategories.sort().forEach(cat => {
            const chip = document.createElement('span'); chip.classList.add('category-chip');
            chip.textContent = cat; chip.dataset.category = cat;
            if (cat === selectedCategory) chip.classList.add('active');
            chip.addEventListener('click', () => {
                document.querySelectorAll('#categoryChipsContainer .category-chip').forEach(c => c.classList.remove('active'));
                chip.classList.add('active'); selectedCategoryInputEl.value = cat;
            });
            categoryChipsContainerEl.appendChild(chip);
        });
    }
    function updateTransactionFormFields(transactionType = null) {
        if (!transactionTypeEl || !accountGroupEl || !transferGroupEls.length || !categoryChipsGroupEl || !transactionDescriptionLabelEl) return;
        const type = transactionType || transactionTypeEl.value;
        accountGroupEl.style.display = (type === 'income' || type === 'spend') ? 'block' : 'none';
        transferGroupEls.forEach(el => el.style.display = (type === 'transfer') ? 'block' : 'none');
        categoryChipsGroupEl.style.display = (type === 'spend') ? 'block' : 'none';
        transactionDescriptionLabelEl.textContent = (type === 'spend') ? 'Notes / Specifics (Optional)' : 'Description';
        if (type !== 'spend') { selectedCategoryInputEl.value = ''; document.querySelectorAll('#categoryChipsContainer .category-chip.active').forEach(c => c.classList.remove('active')); }
    }
    if (transactionTypeEl) transactionTypeEl.addEventListener('change', () => updateTransactionFormFields());

    // --- Balance Calculations & Rendering ---
    function calculateAllBalances() {
        const accBalances = {}; accountKeys.forEach(key => accBalances[key] = 0);
        transactions.forEach(t => {
            if (t.type === 'income') accBalances[t.account] = (accBalances[t.account] || 0) + t.amount;
            else if (t.type === 'spend') accBalances[t.account] = (accBalances[t.account] || 0) - t.amount;
            else if (t.type === 'transfer') { accBalances[t.fromAccount] = (accBalances[t.fromAccount] || 0) - t.amount; accBalances[t.toAccount] = (accBalances[t.toAccount] || 0) + t.amount; }
        });
        return accBalances;
    }
    function renderAccountBalances() {
        if(!accountBalancesListEl || !totalBalanceEl) return; const balances = calculateAllBalances();
        accountBalancesListEl.innerHTML = ''; let totalOverallBalance = 0;
        accountKeys.forEach(key => {
            const balance = balances[key] || 0; totalOverallBalance += balance;
            const item = document.createElement('div'); item.classList.add('account-balance-item');
            const valueDisplay = balancesVisible ? formatCurrency(balance) : `<i class="fas fa-eye-slash"></i>`;
            item.innerHTML = `<span class="account-name">${accountNames[key]}</span><span class="account-value ${!balancesVisible ? 'hidden-balance' : ''}">${valueDisplay}</span>`;
            accountBalancesListEl.appendChild(item);
        });
        totalBalanceEl.textContent = formatCurrency(totalOverallBalance);
        totalBalanceEl.style.color = totalOverallBalance < 0 ? '#dc3545' : 'white';
    }
    if (toggleBalanceVisibilityBtn) {
        toggleBalanceVisibilityBtn.addEventListener('click', () => {
            balancesVisible = !balancesVisible;
            toggleBalanceVisibilityBtn.innerHTML = balancesVisible ? '<i class="fas fa-eye"></i> Hide Amounts' : '<i class="fas fa-eye-slash"></i> Show Amounts';
            renderAccountBalances();
        });
    }

    // --- New Transaction Filtering Logic ---
    function populateFilters() {
        if (txMonthFilterEl) {
            const currentMonth = txMonthFilterEl.value;
            txMonthFilterEl.innerHTML = '<option value="">All Months</option>';
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            monthNames.forEach((month, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = month;
                if (String(index) === currentMonth) option.selected = true;
                txMonthFilterEl.appendChild(option);
            });
        }

        if (txYearFilterEl) {
            const currentYear = txYearFilterEl.value;
            const years = [...new Set(transactions.map(t => new Date(t.date).getFullYear()))].sort((a, b) => b - a);
            txYearFilterEl.innerHTML = '<option value="">All Years</option>';
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year; option.textContent = year;
                if (String(year) === currentYear) option.selected = true;
                txYearFilterEl.appendChild(option);
            });
        }
    }

    function filterAndSearchTransactions() {
        let filtered = [...transactions];
        const searchQuery = txSearchInputEl ? txSearchInputEl.value.toLowerCase().trim() : "";
        const amountQueryVal = txAmountFilterEl ? txAmountFilterEl.value.trim() : "";
        const amountQuery = amountQueryVal ? parseFloat(amountQueryVal) : null;
        const selectedMonth = txMonthFilterEl ? txMonthFilterEl.value : "";
        const selectedYear = txYearFilterEl ? txYearFilterEl.value : "";
        const selectedType = txTypeFilterEl ? txTypeFilterEl.value : "";

        if (searchQuery) {
            filtered = filtered.filter(t =>
                (t.description && t.description.toLowerCase().includes(searchQuery)) ||
                (t.category && t.category.toLowerCase().includes(searchQuery)) ||
                (t.type === 'transfer' && (accountNames[t.fromAccount]?.toLowerCase().includes(searchQuery) || accountNames[t.toAccount]?.toLowerCase().includes(searchQuery))) ||
                (t.type !== 'transfer' && accountNames[t.account]?.toLowerCase().includes(searchQuery))
            );
        }

        if (amountQuery !== null && !isNaN(amountQuery)) {
            filtered = filtered.filter(t => t.amount === amountQuery);
        }

        if (selectedYear) {
            filtered = filtered.filter(t => new Date(t.date).getFullYear() === parseInt(selectedYear));
        }

        if (selectedMonth) {
            filtered = filtered.filter(t => new Date(t.date).getMonth() === parseInt(selectedMonth));
        }
        
        if (selectedType) {
            if (selectedType === "investment_purchase") {
                filtered = filtered.filter(t => t.type === 'spend' && t.category === 'Investment Expense');
            } else if (selectedType === "investment_sale") {
                filtered = filtered.filter(t => t.type === 'income' && t.category === 'Investment Income');
            } else {
                filtered = filtered.filter(t => t.type === selectedType);
            }
        }
        return filtered.sort((a,b) => new Date(b.date) - new Date(a.date));
    }
    
    // --- Transaction Rendering (Full List with Edit/Delete & Filtered Totals) ---
    function renderFullTransactionList() {
        if(!transactionListEl) return;
        populateFilters();
        const transactionsToRender = filterAndSearchTransactions();
        transactionListEl.innerHTML = '';

        // Calculate and display filtered totals
        let filteredIncome = 0;
        let filteredSpend = 0;
        let filteredTransfer = 0;

        transactionsToRender.forEach(t => {
            if (t.type === 'income') filteredIncome += t.amount;
            else if (t.type === 'spend') filteredSpend += t.amount;
            else if (t.type === 'transfer') filteredTransfer += t.amount; // Assuming transfers are neutral for net, but sum them up
        });

        if (filteredTotalsContainerEl) {
            if (transactionsToRender.length > 0 && transactions.length > 0) { // Only show if there are transactions to show and some filters might be active
                filteredTotalsContainerEl.innerHTML = `
                    <span class="filtered-total-item filtered-total-income">Income: ${formatCurrency(filteredIncome)}</span>
                    <span class="filtered-total-item filtered-total-spend">Spend: ${formatCurrency(filteredSpend)}</span>
                    <span class="filtered-total-item filtered-total-transfer">Transfers: ${formatCurrency(filteredTransfer)}</span>
                    <span class="filtered-total-item filtered-total-net">Net (Income-Spend): ${formatCurrency(filteredIncome - filteredSpend)}</span>
                `;
                filteredTotalsContainerEl.style.display = 'flex';
            } else {
                filteredTotalsContainerEl.style.display = 'none';
            }
        }


        if (transactionsToRender.length === 0) {
            if (noTransactionsMessageEl) {
                noTransactionsMessageEl.textContent = transactions.length > 0 ? "No transactions match your filters." : "No transactions yet. Add one!";
                noTransactionsMessageEl.style.display = 'block';
                transactionListEl.appendChild(noTransactionsMessageEl);
            }
        } else {
            if (noTransactionsMessageEl) noTransactionsMessageEl.style.display = 'none';
            transactionsToRender.forEach(t => {
                let iconClass = '', sign = '', accInfo = '';
                if (t.type === 'income') { iconClass = 'fa-arrow-down'; sign = '+'; accInfo = `To: ${accountNames[t.account] || 'N/A'}`; }
                else if (t.type === 'spend') { iconClass = 'fa-arrow-up'; sign = '-'; accInfo = `From: ${accountNames[t.account] || 'N/A'}`; }
                else if (t.type === 'transfer') { iconClass = 'fa-exchange-alt'; accInfo = `From ${accountNames[t.fromAccount]||'N/A'} to ${accountNames[t.toAccount]||'N/A'}`; }
                
                let categoryDisplay = (t.type === 'spend' && t.category) ? `<span class="category-info">${t.category}</span>${t.description ? `<span class="description-info">(${t.description})</span>`:''}` : `<span class="main-info">${t.description || (t.type === 'transfer' ? 'Transfer' : 'N/A')}</span>`;
                
                const item = document.createElement('li');
                item.classList.add('list-group-item', `transaction-${t.type}`);
                item.innerHTML = `
                    <div class="list-item-icon"><i class="fas ${iconClass}"></i></div>
                    <div class="list-item-details">
                        ${categoryDisplay}
                        <div class="sub-info">${displayDate(t.date)}</div>
                        <div class="account-info">${accInfo}</div>
                    </div>
                    <div class="list-item-amount-actions">
                        <span class="amount">${sign}${formatCurrency(t.amount)}</span>
                        <div class="item-actions">
                            <button class="btn btn-sm action-btn edit-btn" data-id="${t.id}" title="Edit Transaction"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm action-btn delete-btn" data-id="${t.id}" data-type="transaction" title="Delete Transaction"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </div>`;
                transactionListEl.appendChild(item);
            });
        }
    }
    
    // --- Home Page Summaries ---
    function renderHomePageSummaries() {
        if (recentTransactionsListHomeEl) {
            recentTransactionsListHomeEl.innerHTML = '';
            const recent = [...transactions].sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0,5);
            if(recent.length === 0) { recentTransactionsListHomeEl.innerHTML = '<li class="list-group-item text-center text-muted">No recent transactions.</li>'; }
            else { recent.forEach(t => {
                let sign = t.type === 'income' ? '+' : (t.type === 'spend' ? '-' : (t.type === 'transfer' ? '' : ''));
                let categoryDisplay = (t.type === 'spend' && t.category) ? `<span style="font-weight:500;">${t.category}</span>${t.description ? `<span style="font-style:italic; color:#666;"> (${t.description.substring(0,20)+(t.description.length > 20 ? '...' : '')})</span>`:''}` : `<span style="font-weight:500;">${(t.description || (t.type === 'transfer' ? 'Transfer' : 'N/A')).substring(0,25)+( (t.description||'').length > 25 ? '...':'')}</span>`;
                const item = document.createElement('li'); item.classList.add('list-group-item');
                item.innerHTML = `<div class="d-flex w-100 justify-content-between align-items-center"><div style="font-size:0.85rem;">${categoryDisplay}<small class="d-block text-muted">${displayDate(t.date)}</small></div><small class="text-${t.type === 'income' ? 'success' : (t.type === 'spend' ? 'danger' : 'info')}" style="font-weight:bold;">${sign}${formatCurrency(t.amount)}</small></div>`;
                recentTransactionsListHomeEl.appendChild(item); });
            }
        }
        if (investmentSummaryHomeEl) {
            const activeInvestments = investments.filter(inv => inv.status === 'active');
            if (activeInvestments.length === 0) { investmentSummaryHomeEl.innerHTML = '<p class="text-center text-muted">No active investments yet.</p>'; }
            else {
                const totalInitialCostActive = activeInvestments.reduce((sum, inv) => sum + inv.amount, 0);
                const totalCurrentValueActive = activeInvestments.reduce((sum, inv) => sum + (inv.currentValue !== null && inv.currentValue !== undefined ? inv.currentValue : inv.amount), 0);
                investmentSummaryHomeEl.innerHTML = `<p class="text-center mb-1"><strong>Active Investments:</strong> ${activeInvestments.length}</p><p class="text-center mb-1"><strong>Total Initial Cost (Active):</strong> ${formatCurrency(totalInitialCostActive)}</p><p class="text-center"><strong>Total Current Value (Active):</strong> ${formatCurrency(totalCurrentValueActive)}</p>`;
            }
        }
    }

    // --- Investment Rendering ---
    function renderInvestmentList() {
        if (!investmentListEl) return; investmentListEl.innerHTML = '';
        const sortedInvestments = [...investments].sort((a, b) => (a.status === 'active' && b.status !== 'active') ? -1 : (a.status !== 'active' && b.status === 'active') ? 1 : new Date(b.date) - new Date(a.date));
        if (sortedInvestments.length === 0) { if (noInvestmentsMessageEl) { noInvestmentsMessageEl.style.display = 'block'; investmentListEl.appendChild(noInvestmentsMessageEl); }}
        else { if (noInvestmentsMessageEl) noInvestmentsMessageEl.style.display = 'none';
            sortedInvestments.forEach(inv => {
                const item = document.createElement('li'); item.classList.add('list-group-item', 'investment-item');
                if (inv.status === 'redeemed') item.classList.add('redeemed-investment');
                let valueDisplay = `<span class="amount">${formatCurrency(inv.amount)}</span> <small>(Invested)</small>`;
                if (inv.status === 'active' && (inv.currentValue !== null && inv.currentValue !== undefined)) { valueDisplay += `<br><span class="amount ${inv.currentValue >= inv.amount ? 'text-success' : 'text-danger'}">${formatCurrency(inv.currentValue)}</span> <small class="current-value-label">(Current)</small>`; }
                else if (inv.status === 'redeemed') { valueDisplay = `<span class="amount text-muted">${formatCurrency(inv.amount)}</span> <small>(Invested)</small><br><span class="amount">${formatCurrency(inv.redeemedAmount || 0)}</span> <small>(Redeemed)</small>`; }
                let profitLossDisplay = (inv.status === 'redeemed' && (inv.profitOrLoss !== null && inv.profitOrLoss !== undefined)) ? `<div class="investment-details ${inv.profitOrLoss >= 0 ? 'profit' : 'loss'}">Profit/Loss: ${formatCurrency(inv.profitOrLoss)}</div>` : '';
                let actionButtonsHtml = (inv.status === 'active') ? `<div class="investment-item-actions"><button class="btn btn-info btn-sm update-value-btn" data-id="${inv.id}" title="Update Value"><i class="fas fa-edit"></i></button><button class="btn btn-success btn-sm redeem-btn" data-id="${inv.id}" title="Redeem"><i class="fas fa-hand-holding-usd"></i></button></div>` : '';
                item.innerHTML = `<div class="list-item-content"><div class="main-info">${inv.description} <span class="status-badge status-${inv.status}">${inv.status.charAt(0).toUpperCase() + inv.status.slice(1)}</span></div><div class="sub-info">Type: ${investmentTypeNames[inv.type] || 'N/A'} | Invested: ${displayDate(inv.date)}</div>${inv.status === 'active' && inv.maturityInfo ? `<div class="investment-details">Maturity: ${inv.maturityInfo}</div>` : ''}${inv.status === 'redeemed' && inv.redemptionDate ? `<div class="investment-details">Redeemed: ${displayDate(inv.redemptionDate)}</div>` : ''}${profitLossDisplay}<div class="investment-details">From Acct: ${accountNames[inv.sourceAccount] || 'N/A'}</div></div><div class="list-item-amount text-right">${valueDisplay}</div>${actionButtonsHtml}<button class="delete-btn btn btn-danger btn-sm" data-id="${inv.id}" data-type="investment" title="Delete Investment" style="position: absolute; bottom: 5px; right: 5px;"><i class="fas fa-trash-alt"></i></button>`;
                investmentListEl.appendChild(item);
            });
        }
    }

    // --- Event Handlers for Investment Modals & Actions ---
    document.body.addEventListener('click', function(e) {
        const updateBtn = e.target.closest('.update-value-btn'); const redeemBtn = e.target.closest('.redeem-btn');
        if (updateBtn) {
            const investmentId = parseInt(updateBtn.dataset.id); const investment = investments.find(inv => inv.id === investmentId); if (!investment) return;
            updateValueInvestmentIdEl.value = investment.id; updateValueInvestmentNameEl.textContent = investment.description;
            investmentCurrentValueEl.value = investment.currentValue !== null && investment.currentValue !== undefined ? investment.currentValue.toFixed(2) : '';
            $('#updateInvestmentValueModal').modal('show');
        } else if (redeemBtn) {
            const investmentId = parseInt(redeemBtn.dataset.id); const investment = investments.find(inv => inv.id === investmentId); if (!investment) return;
            redeemInvestmentIdEl.value = investment.id; redeemInvestmentNameEl.textContent = investment.description;
            redeemInvestmentInitialCostEl.textContent = formatCurrency(investment.amount); investmentRedeemedAmountEl.value = '';
            setDefaultDate(investmentRedemptionDateEl); populateAccountDropdown(redemptionDepositAccountEl); redeemProfitLossInfoEl.textContent = '';
            $('#redeemInvestmentModal').modal('show');
        }
    });
    if(investmentRedeemedAmountEl) { investmentRedeemedAmountEl.addEventListener('input', function() {
        const investmentId = parseInt(redeemInvestmentIdEl.value); const investment = investments.find(inv => inv.id === investmentId); if (!investment) return;
        const redeemedAmountVal = parseFloat(this.value);
        if (!isNaN(redeemedAmountVal)) { const profitLoss = redeemedAmountVal - investment.amount; redeemProfitLossInfoEl.textContent = `Est. Profit/Loss: ${formatCurrency(profitLoss)}`; redeemProfitLossInfoEl.className = `profit-loss-info text-center mb-2 ${profitLoss >= 0 ? 'text-success' : 'text-danger'}`; }
        else { redeemProfitLossInfoEl.textContent = ''; }
    });}
    if (updateInvestmentValueForm) { updateInvestmentValueForm.addEventListener('submit', function(e) {
        e.preventDefault(); const id = parseInt(updateValueInvestmentIdEl.value); const currentValue = parseFloat(investmentCurrentValueEl.value);
        const investmentIndex = investments.findIndex(inv => inv.id === id);
        if (investmentIndex > -1 && !isNaN(currentValue) && currentValue >= 0) { investments[investmentIndex].currentValue = currentValue; saveInvestments(); renderAllContent(); $('#updateInvestmentValueModal').modal('hide'); }
        else { alert('Invalid current value. Please enter a non-negative number.'); }
    });}
    if (redeemInvestmentForm) { redeemInvestmentForm.addEventListener('submit', function(e) {
        e.preventDefault(); const id = parseInt(redeemInvestmentIdEl.value); const redeemedAmount = parseFloat(investmentRedeemedAmountEl.value);
        const redemptionDate = investmentRedemptionDateEl.value; const depositAccount = redemptionDepositAccountEl.value;
        const investmentIndex = investments.findIndex(inv => inv.id === id);
        if (investmentIndex > -1 && !isNaN(redeemedAmount) && redeemedAmount > 0 && redemptionDate && depositAccount) {
            const investment = investments[investmentIndex]; const profitLoss = redeemedAmount - investment.amount;
            investment.status = 'redeemed'; investment.redeemedAmount = redeemedAmount; investment.redemptionDate = redemptionDate; investment.profitOrLoss = profitLoss; investment.currentValue = null;
            const incomeTransaction = { id: Date.now(), type: 'income', description: `Redemption: ${investment.description} (P/L: ${formatCurrency(profitLoss)})`, amount: redeemedAmount, date: redemptionDate, account: depositAccount, category: 'Investment Income' };
            transactions.push(incomeTransaction); saveInvestments(); saveTransactions(); renderAllContent(); populateFilters(); $('#redeemInvestmentModal').modal('hide');
        } else { alert('Please fill all fields correctly for redemption (amount must be positive).'); }
    });}

    // --- Transaction Add/Edit/Delete Handlers ---
    if (fabOpenTransactionModal) { fabOpenTransactionModal.addEventListener('click', () => {
        editingTransactionIdEl.value = ''; transactionModalTitleEl.textContent = 'Add New Transaction';
        transactionSubmitBtnEl.textContent = 'Add Transaction'; transactionSubmitBtnEl.classList.remove('btn-warning'); transactionSubmitBtnEl.classList.add('btn-primary');
        transactionForm.reset(); selectedCategoryInputEl.value = ''; document.querySelectorAll('#categoryChipsContainer .category-chip.active').forEach(c => c.classList.remove('active'));
        setDefaultDate(transactionDateEl); updateTransactionFormFields('income'); populateCategoryChips();
        populateAccountDropdown(document.getElementById('transactionAccount')); populateAccountDropdown(document.getElementById('transferFromAccount')); populateAccountDropdown(document.getElementById('transferToAccount'));
        transactionModalJQ.modal('show');
    });}
    document.body.addEventListener('click', function(e) { // Edit Transaction
        const editButton = e.target.closest('.edit-btn');
        if (editButton && editButton.dataset.type !== 'investment') {
            const transactionId = parseInt(editButton.dataset.id); const transactionToEdit = transactions.find(t => t.id === transactionId);
            if (transactionToEdit) {
                editingTransactionIdEl.value = transactionToEdit.id; transactionModalTitleEl.textContent = 'Edit Transaction';
                transactionSubmitBtnEl.textContent = 'Update Transaction'; transactionSubmitBtnEl.classList.remove('btn-primary'); transactionSubmitBtnEl.classList.add('btn-warning');
                transactionTypeEl.value = transactionToEdit.type; updateTransactionFormFields(transactionToEdit.type);
                document.getElementById('transactionDescription').value = transactionToEdit.description || '';
                document.getElementById('transactionAmount').value = transactionToEdit.amount;
                document.getElementById('transactionDate').value = formatDate(transactionToEdit.date);
                if (transactionToEdit.type === 'spend') { populateCategoryChips(transactionToEdit.category); selectedCategoryInputEl.value = transactionToEdit.category || ''; populateAccountDropdown(document.getElementById('transactionAccount'), transactionToEdit.account); }
                else if (transactionToEdit.type === 'income') { populateCategoryChips(); populateAccountDropdown(document.getElementById('transactionAccount'), transactionToEdit.account); }
                else if (transactionToEdit.type === 'transfer') { populateCategoryChips(); populateAccountDropdown(document.getElementById('transferFromAccount'), transactionToEdit.fromAccount); populateAccountDropdown(document.getElementById('transferToAccount'), transactionToEdit.toAccount); }
                transactionModalJQ.modal('show');
            }
        }
    });
    if (transactionForm) { transactionForm.addEventListener('submit', (e) => { // Add/Update Transaction Submit
        e.preventDefault(); const editingId = editingTransactionIdEl.value ? parseInt(editingTransactionIdEl.value) : null;
        const type = transactionTypeEl.value; const descriptionInputVal = document.getElementById('transactionDescription').value.trim();
        const amount = parseFloat(document.getElementById('transactionAmount').value); const date = transactionDateEl.value;
        const category = (type === 'spend') ? selectedCategoryInputEl.value : null; const description = descriptionInputVal;
        let acc, fromAcc, toAcc, isValid = false;
        if (type === 'income' || type === 'spend') { acc = document.getElementById('transactionAccount').value; if (!acc) { alert('Please select an account.'); return; } if (type === 'spend' && !category && !description) { alert('For spend, select a category or provide notes.'); return; } if (amount > 0 && date && (description || category)) isValid = true; }
        else if (type === 'transfer') { fromAcc = document.getElementById('transferFromAccount').value; toAcc = document.getElementById('transferToAccount').value; if (!fromAcc || !toAcc) { alert('Select From and To accounts.'); return; } if (fromAcc === toAcc) { alert('From and To accounts cannot be the same.'); return; } if (description && amount > 0 && date) isValid = true; }
        if (isValid) {
            const transactionData = { type, description, amount, date, category };
            if (type === 'income' || type === 'spend') transactionData.account = acc;
            else if (type === 'transfer') { transactionData.fromAccount = fromAcc; transactionData.toAccount = toAcc; delete transactionData.category; }
            if (editingId) { const index = transactions.findIndex(t => t.id === editingId); if (index > -1) transactions[index] = { ...transactions[index], ...transactionData }; }
            else { transactionData.id = Date.now(); transactions.push(transactionData); }
            saveTransactions(); renderAllContent(); populateFilters(); transactionForm.reset(); editingTransactionIdEl.value = ''; selectedCategoryInputEl.value = ''; document.querySelectorAll('#categoryChipsContainer .category-chip.active').forEach(c => c.classList.remove('active'));
            setDefaultDate(transactionDateEl); updateTransactionFormFields('income'); transactionModalJQ.modal('hide');
        } else { alert('Please fill all required fields correctly. Amount must be positive.'); }
    });}
    document.querySelectorAll('.open-investment-modal').forEach(button => { button.addEventListener('click', function() { // Open Add Investment Modal
        const type = this.dataset.type; if(investmentForm) investmentForm.reset(); if(investmentTypeSelect) investmentTypeSelect.value = type;
        setDefaultDate(investmentDateEl); populateAccountDropdown(investmentSourceAccountEl); document.getElementById('investmentId').value = ''; investmentModalJQ.modal('show');
    });});
    if(investmentForm) { investmentForm.addEventListener('submit', function(e) { // Add Investment Submit
        e.preventDefault(); const type = investmentTypeSelect.value; const description = document.getElementById('investmentDescription').value.trim();
        const date = investmentDateEl.value; const amount = parseFloat(document.getElementById('investmentAmount').value);
        const maturityInfo = document.getElementById('investmentMaturity').value.trim(); const sourceAccount = investmentSourceAccountEl.value;
        if (!description || !date || isNaN(amount) || amount <= 0 || !sourceAccount) { alert('Fill all required fields: Description, Date, Amount, and Source Account.'); return; }
        const newInvestment = { id: Date.now(), type, description, date, amount, maturityInfo, sourceAccount, status: 'active', currentValue: null, redeemedAmount: null, redemptionDate: null, profitOrLoss: null };
        investments.push(newInvestment); saveInvestments();
        const spendTransactionForInvestment = { id: Date.now() + 1, type: 'spend', category: 'Investment Expense', description: `Investment: ${description}`, amount: amount, date: date, account: sourceAccount };
        transactions.push(spendTransactionForInvestment); saveTransactions(); renderAllContent(); populateFilters(); investmentForm.reset(); setDefaultDate(investmentDateEl); populateAccountDropdown(investmentSourceAccountEl); investmentModalJQ.modal('hide');
    });}
    document.body.addEventListener('click', function(e) { // Generic Delete Button
        const deleteButton = e.target.closest('.delete-btn');
        if (deleteButton) {
            const id = parseInt(deleteButton.dataset.id); const type = deleteButton.dataset.type;
            if (type === 'transaction') { if (confirm('Delete this transaction?')) { transactions = transactions.filter(t => t.id !== id); saveTransactions(); renderAllContent(); populateFilters();}}
            else if (type === 'investment') { const investmentToDelete = investments.find(inv => inv.id === id); let confirmMessage = 'Delete this investment record permanently?'; if (investmentToDelete && investmentToDelete.status === 'redeemed') { confirmMessage += '\nAssociated income transaction will NOT be reversed.';} if (confirm(confirmMessage)) { investments = investments.filter(inv => inv.id !== id); saveInvestments(); renderAllContent(); }}
        }
    });

    // --- New Filter Event Listeners ---
    if (txSearchInputEl) txSearchInputEl.addEventListener('input', renderFullTransactionList);
    if (txAmountFilterEl) txAmountFilterEl.addEventListener('input', renderFullTransactionList);
    if (txMonthFilterEl) txMonthFilterEl.addEventListener('change', renderFullTransactionList);
    if (txYearFilterEl) txYearFilterEl.addEventListener('change', renderFullTransactionList);
    if (txTypeFilterEl) txTypeFilterEl.addEventListener('change', renderFullTransactionList);
    if (txClearFiltersBtnEl) { txClearFiltersBtnEl.addEventListener('click', () => {
        if(txSearchInputEl) txSearchInputEl.value = '';
        if(txAmountFilterEl) txAmountFilterEl.value = '';
        if(txMonthFilterEl) txMonthFilterEl.value = '';
        if(txYearFilterEl) txYearFilterEl.value = '';
        if(txTypeFilterEl) txTypeFilterEl.value = '';
        renderFullTransactionList();
    });}

    // --- Master Render Function ---
    function renderAllContent() {
        renderAccountBalances();
        renderHomePageSummaries();
        if (document.getElementById('transactionsView').classList.contains('active')) {
            renderFullTransactionList();
        } else {
             populateFilters(); // Still populate filters so year/month options are available if user navigates back
        }
        if (document.getElementById('investmentsView').classList.contains('active')) renderInvestmentList();
        if(document.getElementById('chartsView').classList.contains('active')) {
            renderSpendCategoryChart(); renderIncomeSpendChart(); renderInvestmentPortfolioChart();
        }
    }

    // --- Initial Setup ---
    function initializeApp() {
        if (appVersionInfoEl) appVersionInfoEl.textContent = `Money Tracker - ${APP_VERSION}`;
        document.title = `Money Tracker - ${APP_VERSION}`;
        setDefaultDate(transactionDateEl); setDefaultDate(investmentDateEl); setDefaultDate(investmentRedemptionDateEl);
        populateCategoryChips();
        populateAccountDropdown(redemptionDepositAccountEl); populateAccountDropdown(investmentSourceAccountEl);
        populateAccountDropdown(document.getElementById('transactionAccount')); populateAccountDropdown(document.getElementById('transferFromAccount')); populateAccountDropdown(document.getElementById('transferToAccount'));
        
        updateTransactionFormFields('income');
        showView('homeView', 'Dashboard');
        renderAllContent();
    }

    // Modal cleanup on hide
    $('#transactionModal').on('hidden.bs.modal', function () {
        transactionForm.reset(); editingTransactionIdEl.value = ''; selectedCategoryInputEl.value = '';
        document.querySelectorAll('#categoryChipsContainer .category-chip.active').forEach(c => c.classList.remove('active'));
        setDefaultDate(transactionDateEl); updateTransactionFormFields('income');
        populateAccountDropdown(document.getElementById('transactionAccount')); populateAccountDropdown(document.getElementById('transferFromAccount')); populateAccountDropdown(document.getElementById('transferToAccount'));
    });
    $('#investmentModal').on('hidden.bs.modal', function () { if(investmentForm) investmentForm.reset(); setDefaultDate(investmentDateEl); if(investmentTypeSelect) investmentTypeSelect.value = "stock"; populateAccountDropdown(investmentSourceAccountEl); });
    $('#updateInvestmentValueModal').on('hidden.bs.modal', function () { if(updateInvestmentValueForm) updateInvestmentValueForm.reset(); });
    $('#redeemInvestmentModal').on('hidden.bs.modal', function () { if(redeemInvestmentForm) redeemInvestmentForm.reset(); if(redeemProfitLossInfoEl) redeemProfitLossInfoEl.textContent = ''; populateAccountDropdown(redemptionDepositAccountEl); });

    initializeApp();
});
</script>
</body>
</html>
