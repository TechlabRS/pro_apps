<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RaGhS Simple₹ App</title>
    <style>
        /* --- General Layout and Card Styling --- */
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background-color: #f0f4f8;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .card {
            background: white;
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        h2, h3 {
            margin: 0 0 16px 0;
            text-align: center;
            font-weight: 600;
            color: #2c3e50;
        }

        /* --- Form and Input Styling --- */
        form {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .form-input-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        input[type="number"],
        input[type="text"],
        input[type="date"],
        select {
            width: 100%;
            padding: 12px 15px;
            border-radius: 8px;
            border: 1px solid #dfe4e8;
            font-size: 16px;
            background: #fcfdfe;
            box-sizing: border-box;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        
        /* --- Button Group Styling --- */
        .btn-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .btn-group-full {
            grid-template-columns: 1fr;
        }
        
        button {
            border: none;
            border-radius: 8px;
            padding: 14px 0;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
        }
        
        /* Specific Button Colors */
        .btn-add { background: #2ecc71; color: #fff; }
        .btn-spent { background: #e74c3c; color: #fff; }
        .btn-export { background: #3498db; color: #fff; }
        .btn-import { background: #f39c12; color: #fff; }
        .btn-transfer { background: #9b59b6; color: #fff; }
        .btn-clear { background: #e74c3c; color: #fff; }
        
        button:hover {
            opacity: 0.9;
        }
        
        button:active {
            transform: scale(0.98);
        }

        /* --- Summary Section Styling --- */
        .summary-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .summary-card {
            background: #ecf0f1;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            
        }

        .summary-card h4 {
            margin: 0 0 8px 0;
            font-size: 14px;
            color: #7f8c8d;
            font-weight: 500;
        }

        /*.summary-card p {
            margin: 0;
            font-size: 24px;
            font-weight: 700;
            color: #2c3e50;
        } */

        .summary-card p {
            margin: 0;
            font-size: 24px;
            font-weight: 700;
            color: #2c3e50;
            /* --- FIX: Allows horizontal scrolling for large numbers --- */
            white-space: nowrap; 
            overflow-x: auto;   
            -webkit-overflow-scrolling: touch; 
            /* Optional: Hide scrollbar */
            scrollbar-width: none; 
            -ms-overflow-style: none;
        }

        .summary-card p::-webkit-scrollbar {
            display: none;
        }
        

        .summary-balances {
            margin-top: 15px;
        }
        
        .account-balance {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-top: 1px solid #bdc3c7;
        }
        .account-balance:first-child { border-top: none; }
        .account-name { font-weight: 600; font-size: 15px;}
        .account-amount { font-weight: 600; color: #2c3e50;}

        /* --- Toggle/Switch Styling --- */
        .toggle-group {
            display: flex;
            justify-content: center;
            gap: 25px;
            margin-top: 15px;
        }
        
        .switch-container {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 15px;
            color: #34495e;
            font-weight: 500;
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: 24px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #3498db;
        }
        
        input:checked + .slider:before {
            transform: translateX(20px);
        }

        /* --- Search and Filter Styling --- */
        .search-and-filter {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 15px;
        }

        .search-container {
            display: flex;
            gap: 10px;
        }

        #searchInput {
            flex-grow: 1;
        }

        .date-filter-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .date-filter-group label {
            font-size: 14px;
            color: #7f8c8d;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .date-filter-group input {
            padding: 8px;
            width: auto;
        }
        
        /* --- Transaction List Styling --- */
        .transactions-list {
            margin-top: 15px;
        }

        .monthly-group {
            margin-bottom: 25px;
        }
        
        .monthly-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 15px;
            font-weight: 600;
            color: #2c3e50;
            background-color: #eef3f7;
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .monthly-summary {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .monthly-income, .monthly-expense {
            font-size: 14px;
            font-weight: 600;
        }

        .monthly-income { color: #2ecc71; }
        .monthly-expense { color: #e74c3c; }

        .transaction-row {
            display: grid;
            grid-template-columns: 40px 1fr auto 50px;
            align-items: center;
            gap: 15px;
            background: #f8f8fb;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            transition: transform 0.2s;
        }

        .transaction-row:hover {
            transform: translateY(-2px);
        }
        
        .t-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .t-icon svg {
            width: 20px;
            height: 20px;
        }

        .icon-income { background-color: #2ecc71; }
        .icon-expense { background-color: #e74c3c; }
        .icon-transfer { background-color: #9b59b6; }
        
        .t-desc { 
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .t-desc .main-desc {
            font-size: 15px;
            color: #2c3e50;
        }
        
        .t-category, .t-account, .t-date {
            font-size: 12px;
            color: #95a5a6;
        }
        
        .t-amt {
            font-size: 16px;
            text-align: right;
            font-weight: 700;
        }
        
        .amount-positive { color: #2ecc71;}
        .amount-negative { color: #e74c3c;}
        .amount-transfer { color: #9b59b6;}
        
        .t-actions { 
            display: flex; 
            gap: 8px;
        }
        
        .action-btn {
            border-radius: 50%;
            border: none;
            width: 32px;
            height: 32px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .action-btn svg {
            width: 16px;
            height: 16px;
        }
        
        .edit-btn { background: #f39c12; color: #fff;}
        .delete-btn { background: #e74c3c; color: #fff;}
        
        .undo {
            display: none; 
            margin-top: 20px; 
            background-color: #f39c12; 
            color: white; 
            padding: 12px; 
            border: none; 
            cursor: pointer; 
            border-radius: 8px;
            width: 100%;
            transition: opacity 0.3s;
        }

        /* --- Chart Section Styling --- */
        .card#trendsSection {
            /* FIX: Enforce a fixed height for the chart container on small screens */
            height: 350px; 
            display: flex; /* Helps center the chart content */
            flex-direction: column;
        }

        #spendTrendsChart {
            /* Ensure the canvas takes up the available space */
            max-height: 100%; 
        }

        .chart-header {
            text-align: center;
            margin-bottom: 8px;
            color: #34495e;
            font-weight: 500;
        }
        
        /* --- Modal and Floating Button Styles --- */
        .fab-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100;
        }

        .fab {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: #3498db;
            color: white;
            font-size: 30px;
            border: none;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .fab:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.25);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 101;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fefefe;
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            width: 90%;
            max-width: 400px;
            animation: slideIn 0.3s forwards;
        }

        @keyframes slideIn {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            line-height: 1;
        }

        .close-btn:hover,
        .close-btn:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        
        /* --- Responsive Layout for larger screens (Tablet/Desktop) --- */
        @media (min-width: 600px) {
            .container {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 24px;
                max-width: 900px;
            }
            .card.summary-main {
                grid-column: 1 / 2;
                grid-row: 1 / 2;
            }
            .card.transactions-list {
                grid-column: 1 / 3;
            }
            .card.trends-container {
                grid-column: 2 / 3;
                grid-row: 1 / 2; 
                /* On desktop, allow height to match the summary card */
                height: auto; 
            }
        }
        
        /* --- Smart Analysis Styling --- */
        #anomalyAlert {
            color: #e74c3c; /* Red color for warning */
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 5px;
            text-align: center;
        }

        .suggestion {
            font-size: 12px;
            color: #3498db;
            cursor: pointer;
            text-decoration: underline;
            padding: 2px 0;
        }
    </style>
</head>
<body>
<div class="container">

    <div class="card summary-main">
        <h2>RaGhS Simple₹ App</h2>
        <h3>Balances</h3>
        <div class="summary-section">
            <div class="summary-card">
                <h4>Total Income</h4>
                <p>₹<span id="totalIncome">0.00</span></p>
            </div>
            <div class="summary-card">
                <h4>Total Spends</h4>
                <p>₹<span id="totalExpense">0.00</span></p>
            </div>
        </div>
        <div class="summary-balances">
            <div class="account-balance">
                <span class="account-name">Final Balance</span>
                <span class="account-amount">₹<span id="finalBalance">0.00</span></span>
            </div>
            <h3>Account Balances</h3>
            <div id="accountBalancesList"></div>
        </div>
        <div class="toggle-group">
            <div class="switch-container">
                <label for="toggleTrends">Chart</label>
                <label class="switch">
                    <input type="checkbox" id="toggleTrends" onchange="toggleVisibility('trendsSection', 'toggleTrends')" checked>
                    <span class="slider"></span>
                </label>
            </div>
            <div class="switch-container">
                <label for="toggleTransactions">Transactions</label>
                <label class="switch">
                    <input type="checkbox" id="toggleTransactions" onchange="toggleVisibility('transactionsSection', 'toggleTransactions')" checked>
                    <span class="slider"></span>
                </label>
            </div>
        </div>
        <div style="margin-top: 20px;" class="btn-group">
            <button class="btn-export" onclick="exportData()">Export Data</button>
            <button class="btn-import" onclick="document.getElementById('importFile').click()">Import Data</button>
            <button class="btn-clear" onclick="clearAllData()">Clear All</button>
        </div>
        <input type="file" id="importFile" style="display: none" accept=".json" onchange="importData(event)">
    </div>
    
    <div class="card trends-container" id="trendsSection">
        <h3 id="chartTitle">Monthly Spend Trends</h3>
        <canvas id="spendTrendsChart"></canvas>
    </div>

    <div class="card transactions-list" id="transactionsSection">
        <h3>Transaction History</h3>
        <div class="search-and-filter">
            <div class="search-container">
                <input type="text" id="searchInput" placeholder="Search by description, amount, or category" oninput="displayTransactions()">
                <select id="filterByPeriod" onchange="updateViews()">
                    <option value="all">All Time</option>
                    <option value="week">Current Week</option>
                    <option value="month">Current Month</option>
                    <option value="year">Current Year</option>
                </select>
            </div>
            <div class="date-filter-group">
                <label for="startDate">From:</label>
                <input type="date" id="startDate" onchange="updateViews()">
                <label for="endDate">To:</label>
                <input type="date" id="endDate" onchange="updateViews()">
            </div>
        </div>
        <div class="transactions" id="transactionList"></div>
        <button class="undo" id="undoBtn" onclick="undoDelete()">Undo</button>
    </div>
</div>

<div class="fab-container">
    <button class="fab" onclick="openModal()">+</button>
</div>

<div id="myModal" class="modal" onclick="closeModalOnOutsideClick(event)">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal()">&times;</span>
        <h2>Add Transaction</h2>
        <form onsubmit="return false;">
            <div id="anomalyAlert" style="display: none;"></div>
            <div class="form-input-group">
                <input type="number" id="amount" placeholder="Enter Amount" step="0.01">
                <input type="text" id="description" placeholder="Description (Optional)">
                <input type="text" id="category" placeholder="Category (e.g., Groceries, Salary)">
                <div id="categorySuggestion" class="suggestion" onclick="applySuggestion('category')"></div>
                <input type="text" id="account" placeholder="From Account (e.g., Cash, PhonePe)">
                <div id="accountSuggestion" class="suggestion" onclick="applySuggestion('account')"></div>
                <input type="text" id="toAccount" placeholder="To Account (for transfers only)">
                <input type="date" id="date">
            </div>
            <div class="btn-group">
                <button class="btn-add" id="incomeBtn" onclick="addOrUpdateTransaction('income')">Add Income</button>
                <button class="btn-spent" id="spendBtn" onclick="addOrUpdateTransaction('expense')">Add Spend</button>
            </div>
            <div class="btn-group btn-group-full">
                <button class="btn-transfer" id="transferBtn" onclick="addOrUpdateTransaction('transfer')">Transfer</button>
            </div>
        </form>
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let transactions = [];
    let deletedTransaction = null;
    let editTransactionId = null;
    let myChart;

    const monthNames = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];

    // --- Core Data Management and Initial Load ---

    function loadSavedData() {
        try {
            const savedTransactions = JSON.parse(localStorage.getItem("transactions"));
            if (Array.isArray(savedTransactions)) {
                transactions = savedTransactions;
            } else {
                transactions = [];
            }
        } catch (e) {
            transactions = [];
        }
        updateViews();
        resetForm();
        initSmartAnalysisListeners(); // Initialize listeners for the new smart features
    }
    
    function saveData() {
        localStorage.setItem("transactions", JSON.stringify(transactions));
    }

    function updateViews() {
        const filteredTransactions = getTransactionsByTimePeriod();
        updateSummary(filteredTransactions);
        displayTransactions();
        renderChart(filteredTransactions);
        updateAccountBalances();
        scaleSummaryAmounts();
    }

    function scaleSummaryAmounts() {
        // Select the three elements that display money totals
        const amountElements = [
            document.getElementById('totalIncome'),
            document.getElementById('totalExpense'),
            document.getElementById('finalBalance')
        ];

        amountElements.forEach(element => {
            // Find the parent <p> element
            const pTag = element.parentElement; 
            
            // Reset to default size before checking
            pTag.style.fontSize = '24px';
            
            // Get the length of the text content (e.g., "₹1,234,567.89")
            const textLength = element.textContent.length; 
            
            // Define scaling thresholds (adjust these numbers based on your exact layout)
            if (textLength > 16) {
                // For very long numbers (e.g., over 10 million)
                pTag.style.fontSize = '14px';
            } else if (textLength > 14) {
                // For long numbers (e.g., over 1 million)
                pTag.style.fontSize = '18px';
            } else if (textLength > 12) {
                // For medium-long numbers
                pTag.style.fontSize = '20px';
            }
        });
    }
    
    // --- Smart Analysis Implementation ---

    function getStandardDeviation(array) {
        if (array.length === 0) return { mean: 0, stdDev: 0 };
        const mean = array.reduce((a, b) => a + b) / array.length;
        const variance = array.map(n => Math.pow(n - mean, 2)).reduce((a, b) => a + b) / array.length;
        return { mean, stdDev: Math.sqrt(variance) };
    }

    function checkAnomaly(amount, category) {
        const pastExpenses = transactions
            .filter(t => t.type === 'expense' && t.category === category)
            .map(t => t.amount);
        
        // Need at least 5 past transactions in the category to establish a norm
        if (pastExpenses.length < 5) {
            return { isAnomaly: false, message: "" }; 
        }
        
        const { mean, stdDev } = getStandardDeviation(pastExpenses);
        
        // Flag as anomaly if the amount is more than 2 standard deviations above the mean.
        if (amount > (mean + 2 * stdDev)) {
            const meanDisplay = mean.toFixed(2);
            const stdDevDisplay = stdDev.toFixed(2);
            const deviation = ((amount - mean) / stdDev).toFixed(1);
            return { 
                isAnomaly: true, 
                message: `⚠️ **Anomaly Alert**: This is ${deviation} standard deviations above the average spend (₹${meanDisplay}) for '${category}'.`
            };
        }
        
        return { isAnomaly: false, message: "" };
    }

    function getSmartSuggestions(description) {
        const cleanDesc = description.trim().toLowerCase();
        // Require at least 3 characters to start suggesting
        if (cleanDesc.length < 3) return { suggestedCategory: '', suggestedAccount: '' };

        const history = transactions
            .filter(t => t.type !== 'transfer' && t.description.toLowerCase().includes(cleanDesc));

        if (history.length < 2) return { suggestedCategory: '', suggestedAccount: '' };

        const categoryCounts = {};
        const accountCounts = {};

        history.forEach(t => {
            const cat = t.category || 'Uncategorized';
            const acc = t.account || 'Cash';
            categoryCounts[cat] = (categoryCounts[cat] || 0) + 1;
            accountCounts[acc] = (accountCounts[acc] || 0) + 1;
        });

        const sortedCategories = Object.entries(categoryCounts).sort(([, a], [, b]) => b - a);
        const sortedAccounts = Object.entries(accountCounts).sort(([, a], [, b]) => b - a);

        // Suggest if the top suggestion has at least 60% confidence
        const totalCategories = history.length;
        const suggestedCategory = sortedCategories.length && sortedCategories[0][1] / totalCategories >= 0.6 
                                ? sortedCategories[0][0] : '';
        
        const totalAccounts = history.length;
        const suggestedAccount = sortedAccounts.length && sortedAccounts[0][1] / totalAccounts >= 0.6 
                                ? sortedAccounts[0][0] : '';
        
        return { suggestedCategory, suggestedAccount };
    }

    function handleSmartAnalysis() {
        const descriptionInput = document.getElementById("description");
        const categoryInput = document.getElementById("category");
        const accountInput = document.getElementById("account");
        const amountInput = document.getElementById("amount");
        const alertDiv = document.getElementById("anomalyAlert");
        const catSuggestionDiv = document.getElementById("categorySuggestion");
        const accSuggestionDiv = document.getElementById("accountSuggestion");
        
        const description = descriptionInput.value;
        const amount = parseFloat(amountInput.value);

        // --- 1. Auto-fill Suggestions ---
        const { suggestedCategory, suggestedAccount } = getSmartSuggestions(description);

        if (suggestedCategory && categoryInput.value.trim() === "") {
            catSuggestionDiv.innerHTML = `Smart Suggestion: **${suggestedCategory}** (click to apply)`;
            catSuggestionDiv.style.display = "block";
            catSuggestionDiv.dataset.suggestion = suggestedCategory;
        } else {
            catSuggestionDiv.style.display = "none";
            catSuggestionDiv.textContent = "";
        }

        if (suggestedAccount && accountInput.value.trim() === "") {
            accSuggestionDiv.innerHTML = `Smart Suggestion: **${suggestedAccount}** (click to apply)`;
            accSuggestionDiv.style.display = "block";
            accSuggestionDiv.dataset.suggestion = suggestedAccount;
        } else {
            accSuggestionDiv.style.display = "none";
            accSuggestionDiv.textContent = "";
        }

        // --- 2. Anomaly Detection ---
        // Determine the category to check: either the one typed in, or the smart suggestion
        const currentCategory = categoryInput.value.trim() || suggestedCategory;

        // Only check if it's a valid amount and a category is present
        if (!isNaN(amount) && amount > 0 && currentCategory) {
            const anomalyResult = checkAnomaly(amount, currentCategory);
            if (anomalyResult.isAnomaly) {
                alertDiv.innerHTML = anomalyResult.message;
                alertDiv.style.display = "block";
            } else {
                alertDiv.style.display = "none";
                alertDiv.textContent = "";
            }
        } else {
            alertDiv.style.display = "none";
            alertDiv.textContent = "";
        }
    }

    function applySuggestion(target) {
        if (target === 'category') {
            const catSuggestionDiv = document.getElementById("categorySuggestion");
            document.getElementById("category").value = catSuggestionDiv.dataset.suggestion;
            catSuggestionDiv.style.display = "none";
            // Re-run analysis to check anomaly with the new category
            handleSmartAnalysis();
        } else if (target === 'account') {
            const accSuggestionDiv = document.getElementById("accountSuggestion");
            document.getElementById("account").value = accSuggestionDiv.dataset.suggestion;
            accSuggestionDiv.style.display = "none";
        }
    }

    function initSmartAnalysisListeners() {
        const descriptionInput = document.getElementById("description");
        const amountInput = document.getElementById("amount");
        const categoryInput = document.getElementById("category");
        
        if (descriptionInput) descriptionInput.addEventListener('input', handleSmartAnalysis);
        // Anomaly check should happen when amount or category changes
        if (amountInput) amountInput.addEventListener('input', handleSmartAnalysis);
        if (categoryInput) categoryInput.addEventListener('input', handleSmartAnalysis);
    }

    // --- Transaction Logic (Add/Edit/Delete/Undo) ---

    function addOrUpdateTransaction(type) {
        let amount = parseFloat(document.getElementById("amount").value);
        let description = document.getElementById("description").value || "No Description";
        let category = document.getElementById("category").value || "Uncategorized";
        let fromAccount = document.getElementById("account").value || "Cash";
        let toAccount = document.getElementById("toAccount").value;
        let date = document.getElementById("date").value || new Date().toISOString().split('T')[0];

        if (isNaN(amount) || amount <= 0) {
            alert("Enter a valid amount!");
            return;
        }
        
        // New Anomaly Confirmation for Expenses before saving
        if (type === 'expense' && !editTransactionId) {
            const currentCategory = category;
            const anomalyResult = checkAnomaly(amount, currentCategory);
            if (anomalyResult.isAnomaly) {
                if (!confirm(`${anomalyResult.message.replace(/\*\*/g, '')}\n\nDo you still want to save this expense?`)) {
                    // User chose NOT to save the anomaly
                    return;
                }
            }
        }

        if (type === 'transfer') {
             // For transfers, 'From Account' and 'To Account' must be set and different
            if (!fromAccount || !toAccount || fromAccount.toLowerCase() === toAccount.toLowerCase()) {
                alert("For a Transfer, please specify two different accounts (From and To).");
                return;
            }
            category = "Transfer"; // Override category for transfers
            description = description || `Transfer to ${toAccount}`;
        }
        
        let transaction;

        if (editTransactionId) {
            // Update existing transaction
            let idx = transactions.findIndex(t => t.id === editTransactionId);
            if (idx !== -1) {
                // Ensure the 'category' field is only present for Income/Expense for consistency
                if (type === 'transfer') {
                    transaction = { id: editTransactionId, amount, description, account: fromAccount, toAccount, date, type };
                } else {
                    transaction = { id: editTransactionId, amount, description, category, account: fromAccount, date, type };
                }
                transactions[idx] = transaction;
            }
        } else {
            // Add new transaction
             if (type === 'transfer') {
                transaction = { id: Date.now(), amount, description, account: fromAccount, toAccount, date, type };
            } else {
                transaction = { id: Date.now(), amount, description, category, account: fromAccount, date, type };
            }
            transactions.push(transaction);
        }
        
        saveData();
        updateViews();
        resetForm();
        closeModal();
    }

    function editTransaction(id) {
        openModal();
        let t = transactions.find(tx => tx.id === id);
        if (!t) return;
        
        // Populate fields
        document.getElementById("amount").value = t.amount;
        document.getElementById("description").value = t.description;
        document.getElementById("category").value = t.category || "";
        document.getElementById("account").value = t.account || "";
        document.getElementById("toAccount").value = t.toAccount || '';
        document.getElementById("date").value = t.date;
        
        editTransactionId = t.id;

        // Dynamic Field Visibility and Button Text
        if (t.type === 'transfer') {
            document.getElementById("category").style.display = "none";
            document.getElementById("toAccount").style.display = "block";
            document.getElementById("incomeBtn").style.display = "none";
            document.getElementById("spendBtn").style.display = "none";
            document.getElementById("transferBtn").style.display = "block";
            document.getElementById("transferBtn").textContent = "Update Transfer";
        } else {
            document.getElementById("category").style.display = "block";
            document.getElementById("toAccount").style.display = "none";
            document.getElementById("incomeBtn").style.display = "block";
            document.getElementById("spendBtn").style.display = "block";
            document.getElementById("transferBtn").style.display = "none";

            // Set the *relevant* button to 'Update' and the other to 'Add'
            document.getElementById("incomeBtn").textContent = (t.type === 'income') ? "Update Income" : "Add Income";
            document.getElementById("spendBtn").textContent = (t.type === 'expense') ? "Update Spend" : "Add Spend";
        }
        handleSmartAnalysis(); // Run analysis after populating form in edit mode
    }
    
    // Add event listeners to the modal buttons to manage field visibility when user switches
    document.getElementById("incomeBtn").onclick = () => { manageModalFields('income'); addOrUpdateTransaction('income'); };
    document.getElementById("spendBtn").onclick = () => { manageModalFields('expense'); addOrUpdateTransaction('expense'); };
    document.getElementById("transferBtn").onclick = () => { manageModalFields('transfer'); addOrUpdateTransaction('transfer'); };

    // Function to dynamically show/hide fields when clicking buttons in the modal
    function manageModalFields(type) {
        if (type === 'transfer') {
            document.getElementById("category").style.display = "none";
            document.getElementById("toAccount").style.display = "block";
        } else {
            document.getElementById("category").style.display = "block";
            document.getElementById("toAccount").style.display = "none";
        }
        // Always reset button text to 'Add' when switching types in the modal
        document.getElementById("incomeBtn").textContent = "Add Income";
        document.getElementById("spendBtn").textContent = "Add Spend";
        document.getElementById("transferBtn").textContent = "Transfer";
        
        // If we are in edit mode, ensure the *current* button is set to update
        if (editTransactionId) {
            let t = transactions.find(tx => tx.id === editTransactionId);
            if(t && t.type === type) {
                if (type === 'income') document.getElementById("incomeBtn").textContent = "Update Income";
                if (type === 'expense') document.getElementById("spendBtn").textContent = "Update Spend";
                if (type === 'transfer') document.getElementById("transferBtn").textContent = "Update Transfer";
            }
        }
        handleSmartAnalysis(); // Run analysis after changing field visibility
    }


    function resetForm() {
        document.getElementById("amount").value = "";
        document.getElementById("description").value = "";
        document.getElementById("category").value = "";
        document.getElementById("account").value = "";
        document.getElementById("toAccount").value = "";
        document.getElementById("date").value = "";

        // Reset smart analysis elements
        document.getElementById("anomalyAlert").style.display = "none";
        document.getElementById("anomalyAlert").textContent = "";
        document.getElementById("categorySuggestion").style.display = "none";
        document.getElementById("categorySuggestion").textContent = "";
        document.getElementById("accountSuggestion").style.display = "none";
        document.getElementById("accountSuggestion").textContent = "";

        // Reset button text and field visibility to default (non-edit, full view)
        document.getElementById("incomeBtn").textContent = "Add Income";
        document.getElementById("spendBtn").textContent = "Add Spend";
        document.getElementById("transferBtn").textContent = "Transfer";
        
        document.getElementById("category").style.display = "block";
        document.getElementById("toAccount").style.display = "none";
        document.getElementById("incomeBtn").style.display = "block";
        document.getElementById("spendBtn").style.display = "block";
        document.getElementById("transferBtn").style.display = "block";

        editTransactionId = null;
    }

    function deleteTransaction(id) {
        let idx = transactions.findIndex(t => t.id === id);
        if (idx !== -1) {
            let tx = transactions[idx];
            deletedTransaction = tx;
            transactions.splice(idx, 1);
            saveData();
            updateViews();
            document.getElementById("undoBtn").style.display = "block";
            setTimeout(() => {
                document.getElementById("undoBtn").style.display = "none"; 
                deletedTransaction = null;
            }, 5000);
            if (editTransactionId === id) resetForm();
        }
    }

    function undoDelete() {
        if (deletedTransaction) {
            transactions.push(deletedTransaction);
            saveData();
            updateViews();
            document.getElementById("undoBtn").style.display = "none"; 
            deletedTransaction = null;
        }
    }

    function clearAllData() {
        if (confirm("Are you sure you want to clear ALL transaction data? This action cannot be undone.")) {
            transactions = [];
            localStorage.removeItem("transactions");
            updateViews();
            alert("All transaction data has been cleared.");
        }
    }

    // --- Summary and Balance Calculations ---

    function updateSummary(filteredTransactions) {
        const totalIncome = filteredTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
        const totalExpense = filteredTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);

        document.getElementById("totalIncome").textContent = totalIncome.toFixed(2);
        document.getElementById("totalExpense").textContent = totalExpense.toFixed(2);
        document.getElementById("finalBalance").textContent = (totalIncome - totalExpense).toFixed(2);
    }

    function updateAccountBalances() {
        const accounts = {};
        transactions.forEach(t => {
            const fromAccount = t.account || 'Cash';
            // Ensure both accounts are tracked, even if balance is 0
            if (!accounts.hasOwnProperty(fromAccount)) accounts[fromAccount] = 0;
            if (t.type === 'transfer' && t.toAccount && !accounts.hasOwnProperty(t.toAccount)) accounts[t.toAccount] = 0;

            if (t.type === 'income') {
                accounts[fromAccount] += t.amount;
            } else if (t.type === 'expense') {
                accounts[fromAccount] -= t.amount;
            } else if (t.type === 'transfer') {
                const toAccount = t.toAccount || 'Unspecified';
                accounts[fromAccount] -= t.amount;
                if (toAccount) {
                    if (!accounts.hasOwnProperty(toAccount)) accounts[toAccount] = 0;
                    accounts[toAccount] += t.amount;
                }
            }
        });

        const accountsList = document.getElementById("accountBalancesList");
        accountsList.innerHTML = "";
        for (const account in accounts) {
            const div = document.createElement('div');
            div.className = 'account-balance';
            div.innerHTML = `
                <span class="account-name">${account}</span>
                <span class="account-amount">₹${accounts[account].toFixed(2)}</span>
            `;
            accountsList.appendChild(div);
        }
    }

    // --- Filtering Logic ---

    function getTransactionsByTimePeriod() {
        let tempTransactions = [...transactions];
        
        const startDate = document.getElementById("startDate").value;
        const endDate = document.getElementById("endDate").value;
        
        if (startDate && endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            end.setDate(end.getDate() + 1);
            tempTransactions = tempTransactions.filter(t => {
                const transactionDate = new Date(t.date);
                return transactionDate >= start && transactionDate < end;
            });
            document.getElementById("filterByPeriod").value = 'all';
        } else {
            const filterPeriod = document.getElementById("filterByPeriod").value;
            const today = new Date();
            let periodStartDate;

            switch (filterPeriod) {
                case 'week':
                    periodStartDate = new Date(today.getFullYear(), today.getMonth(), today.getDate() - today.getDay());
                    break;
                case 'month':
                    periodStartDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    break;
                case 'year':
                    periodStartDate = new Date(today.getFullYear(), 0, 1);
                    break;
                default:
                    return transactions;
            }
            tempTransactions = tempTransactions.filter(t => new Date(t.date) >= periodStartDate);
        }
        return tempTransactions;
    }

    function displayTransactions() {
        const container = document.getElementById("transactionList");
        container.innerHTML = "";
        
        let filteredTransactions = getTransactionsByTimePeriod();

        const searchTerm = document.getElementById("searchInput").value.trim().toLowerCase();
        if (searchTerm) {
            filteredTransactions = filteredTransactions.filter(t => {
                const descriptionMatch = t.description.toLowerCase().includes(searchTerm);
                const amountMatch = String(t.amount).includes(searchTerm);
                const categoryMatch = (t.category || '').toLowerCase().includes(searchTerm);
                const accountMatch = (t.account || '').toLowerCase().includes(searchTerm);
                const toAccountMatch = (t.toAccount || '').toLowerCase().includes(searchTerm);
                return descriptionMatch || amountMatch || categoryMatch || accountMatch || toAccountMatch;
            });
        }

        filteredTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
        
        const transactionsByMonth = filteredTransactions.reduce((acc, transaction) => {
            const date = new Date(transaction.date);
            const monthYear = `${date.getFullYear()}-${date.getMonth()}`;
            if (!acc[monthYear]) {
                acc[monthYear] = {
                    transactions: [],
                    totalIncome: 0,
                    totalExpense: 0
                };
            }
            acc[monthYear].transactions.push(transaction);
            if (transaction.type === 'income') acc[monthYear].totalIncome += transaction.amount;
            else if (transaction.type === 'expense') acc[monthYear].totalExpense += transaction.amount;
            return acc;
        }, {});

        const sortedMonths = Object.keys(transactionsByMonth).sort((a, b) => {
            const [yearA, monthA] = a.split('-').map(Number);
            const [yearB, monthB] = b.split('-').map(Number);
            if (yearA !== yearB) return yearB - yearA;
            return monthB - monthA;
        });

        sortedMonths.forEach(monthYear => {
            const data = transactionsByMonth[monthYear];
            const [year, month] = monthYear.split('-');
            const monthName = monthNames[parseInt(month)];
            const header = document.createElement('div');
            header.className = 'monthly-group';
            header.innerHTML = `
                <div class="monthly-header">
                    <span>${monthName} ${year}</span>
                    <div class="monthly-summary">
                        <span class="monthly-income">+ ₹${data.totalIncome.toFixed(2)}</span>
                        <span class="monthly-expense">- ₹${data.totalExpense.toFixed(2)}</span>
                    </div>
                </div>
            `;
            container.appendChild(header);

            data.transactions.forEach(t => {
                const row = document.createElement("div");
                row.className = "transaction-row";
                const date = new Date(t.date);
                const formattedDate = `${date.getDate()} ${monthNames[date.getMonth()]}`;

                let amountDisplay;
                let descriptionDisplay;
                let amountClass;
                let iconHtml;

                if (t.type === 'income') {
                    amountDisplay = `+₹${t.amount.toFixed(2)}`;
                    descriptionDisplay = t.description;
                    amountClass = 'amount-positive';
                    iconHtml = `
                        <div class="t-icon icon-income">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="white" viewBox="0 0 24 24"><path d="M12 2c5.514 0 10 4.486 10 10s-4.486 10-10 10-10-4.486-10-10 4.486-10 10-10zm0-2c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm6 13h-4v4h-4v-4h-4v-4h4v-4h4v4h4v4z"/></svg>
                        </div>
                    `;
                } else if (t.type === 'expense') {
                    amountDisplay = `-₹${t.amount.toFixed(2)}`;
                    descriptionDisplay = t.description;
                    amountClass = 'amount-negative';
                    iconHtml = `
                        <div class="t-icon icon-expense">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="white" viewBox="0 0 24 24"><path d="M12 2c5.514 0 10 4.486 10 10s-4.486 10-10 10-10-4.486-10-10 4.486-10 10-10zm0-2c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm-6 13h12v-2h-12v2z"/></svg>
                        </div>
                    `;
                } else if (t.type === 'transfer') {
                    amountDisplay = `₹${t.amount.toFixed(2)}`;
                    descriptionDisplay = `${t.account} -> ${t.toAccount}`;
                    amountClass = 'amount-transfer';
                    iconHtml = `
                        <div class="t-icon icon-transfer">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="white" viewBox="0 0 24 24"><path d="M14.5 19h-5c-2.481 0-4.5-2.019-4.5-4.5v-2c0-.552.447-1 1-1h15c.553 0 1 .448 1 1v2c0 2.481-2.019 4.5-4.5 4.5zm-5-3h5c1.379 0 2.5-1.122 2.5-2.5v-1.5c0-.276-.224-.5-.5-.5h-15c-.276 0-.5.224-.5.5v1.5c0 1.378 1.121 2.5 2.5 2.5zm11.5-7h-12c-2.481 0-4.5-2.019-4.5-4.5v-2c0-.552.447-1 1-1h15c.553 0 1 .448 1 1v2c0 2.481-2.019 4.5-4.5 4.5zm-12-3h12c1.379 0 2.5-1.122 2.5-2.5v-1.5c0-.276-.224-.5-.5-.5h-15c-.276 0-.5.224-.5.5v1.5c0 1.378 1.121 2.5 2.5 2.5z"/></svg>
                        </div>
                    `;
                }

                row.innerHTML = `
                    ${iconHtml}
                    <div class="t-desc">
                        <span class="main-desc">${t.description}</span>
                        ${t.type === 'transfer' ? `<span class="t-category">Transfer</span>` : `<span class="t-category">Category: ${t.category}</span>`}
                        <span class="t-date">${formattedDate} | From: ${t.account}</span>
                    </div>
                    <div class="t-amt ${amountClass}">${amountDisplay}</div>
                    <div class="t-actions">
                        <button class="action-btn edit-btn" onclick="editTransaction(${t.id})">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="white" viewBox="0 0 24 24"><path d="M7.127 22.569c-.149 0-.29-.033-.42-.098l-5.694-2.846c-.521-.261-.715-.892-.454-1.413l13.136-26.273c.261-.521.892-.715 1.413-.454l5.694 2.846c.521.261.715.892.454 1.413l-13.136 26.273c-.053.106-.118.196-.2.269-.082.074-.184.116-.293.116zm-3.003-4.576l4.249 2.124-11.233-5.617-4.249-2.124 11.233 5.617zm1.196 2.392l-2.392-1.196 10.778-21.556 2.392 1.196-10.778 21.556z"/></svg>
                        </button>
                        <button class="action-btn delete-btn" onclick="deleteTransaction(${t.id})">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="white" viewBox="0 0 24 24"><path d="M24 20.188l-8.315-8.209 8.2-8.282-3.697-3.697-8.212 8.318-8.31-8.203-3.695 3.697 8.313 8.212-8.2 8.318 3.697 3.697 8.216-8.318 8.286 8.23z"/></svg>
                        </button>
                    </div>
                `;
                container.appendChild(row);
            });
        });
    }

    // --- Chart Logic ---

    function renderChart(filteredTransactions) {
        // 1. Filter for expenses and calculate unique months
        const expenseTransactions = filteredTransactions.filter(t => t.type === 'expense').sort((a, b) => new Date(a.date) - new Date(b.date));
        
        const uniqueMonths = [...new Set(expenseTransactions.map(t => t.date.slice(0, 7)))];
        const chartTitle = document.getElementById('chartTitle');

        let chartType;
        let data;
        let config;

        // Check if data spans more than one month or is empty
        if (uniqueMonths.length > 1) {
            // Logic A: Monthly Trend (Bar Chart)
            chartTitle.textContent = 'Monthly Expense Trend';
            chartType = 'bar';

            const monthlyTotals = uniqueMonths.map(month => {
                const total = expenseTransactions
                    .filter(t => t.date.startsWith(month))
                    .reduce((sum, t) => sum + t.amount, 0);
                return total;
            });

            const labels = uniqueMonths.map(month => {
                const [year, monthIndex] = month.split('-');
                return `${monthNames[parseInt(monthIndex) - 1]} ${year}`;
            });

            data = {
                labels: labels,
                datasets: [{
                    label: 'Total Monthly Spend (₹)',
                    data: monthlyTotals,
                    backgroundColor: '#e74c3c', // Red for expense
                    borderRadius: 6,
                }]
            };

            config = {
                type: chartType,
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false, // Key to fixing the scrolling issue
                    scales: {
                        x: {
                            grid: { display: false }
                        },
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Amount (₹)' }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            };

        } else if (uniqueMonths.length === 1) {
            // Logic B: Category Breakdown (Doughnut Chart)
            chartTitle.textContent = `Category Breakdown for ${monthNames[parseInt(uniqueMonths[0].split('-')[1])]} ${uniqueMonths[0].split('-')[0]}`;
            chartType = 'doughnut';

            const categoryData = expenseTransactions.reduce((acc, t) => {
                const category = t.category || "Uncategorized";
                acc[category] = (acc[category] || 0) + t.amount;
                return acc;
            }, {});

            const labels = Object.keys(categoryData);
            const amounts = Object.values(categoryData);
            const colors = labels.map((_, index) => getRandomColor(index)); // Use index for deterministic color

            data = {
                labels: labels,
                datasets: [{
                    data: amounts,
                    backgroundColor: colors,
                    hoverOffset: 10
                }]
            };

            config = {
                type: chartType,
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false, // Key to fixing the scrolling issue
                    plugins: {
                        legend: {
                            position: 'bottom',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        label += '₹' + context.parsed.toFixed(2);
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((context.parsed / total) * 100).toFixed(1);
                                        label += ' (' + percentage + '%)';
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            };

        } else {
            // No Expense Data
            chartTitle.textContent = 'No Expense Data for Selected Period';
            data = { labels: ['No Data'], datasets: [{ data: [1], backgroundColor: ['#ccc'] }] };
            chartType = 'doughnut';
            config = {
                type: chartType,
                data: data,
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { enabled: false } } }
            };
        }

        const ctx = document.getElementById('spendTrendsChart').getContext('2d');
        if (myChart) {
            myChart.destroy();
        }
        myChart = new Chart(ctx, config);
    }

    // Updated color function for better distinction in Doughnut chart
    function getRandomColor(index) {
        const standardColors = [
            '#3498db', '#e74c3c', '#2ecc71', '#f1c40f', '#9b59b6', '#34495e',
            '#1abc9c', '#e67e22', '#7f8c8d', '#d35400', '#2980b9', '#c0392b'
        ];
        return standardColors[index % standardColors.length];
    }

    // --- Export, Import, and Utility Functions ---

    function exportData() {
        let blob = new Blob([JSON.stringify(transactions)], { type: "application/json" });
        let a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "transactions.json";
        a.click();
    }

    function importData(event) {
        let file = event.target.files[0];
        if (!file) return;
        let reader = new FileReader();
        reader.onload = function(e) {
            try {
                const importedData = JSON.parse(e.target.result);
                if (Array.isArray(importedData)) {
                    transactions = importedData;
                    saveData();
                    updateViews();
                    resetForm();
                } else {
                    alert("Invalid JSON format in the file.");
                }
            } catch (error) {
                alert("Error parsing file: " + error.message);
            }
        };
        reader.readAsText(file);
    }
    
    function toggleVisibility(sectionId, checkboxId) {
        const element = document.getElementById(sectionId);
        const checkbox = document.getElementById(checkboxId);
        if (checkbox.checked) {
            element.style.display = "flex"; // Use flex since the chart container is flex
        } else {
            element.style.display = "none";
        }
    }

    // Modal functions
    const modal = document.getElementById("myModal");
    function openModal() {
        modal.style.display = "flex";
        resetForm(); // Ensure a fresh start
        manageModalFields('expense'); // Default to expense/income view
        document.getElementById("transferBtn").style.display = "block"; // Show all buttons on open
    }

    function closeModal() {
        modal.style.display = "none";
        resetForm(); // Ensure form is cleaned up when closing
    }

    function closeModalOnOutsideClick(event) {
        if (event.target == modal) {
            closeModal();
        }
    }

    window.onload = loadSavedData;
</script>
</body>
</html>
